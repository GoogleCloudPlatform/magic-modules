name: pre-build-validations

permissions: read-all

on:
  pull_request:

jobs:
  lint-yaml:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        path: repo
        fetch-depth: 0
    - name: Check for mmv1 product file changes
      id: pull_request
      run: |
        cd repo
        git config user.name "modular-magician"
        git config user.email "magic-modules@google.com"
        git merge --no-ff origin/main
        yamlfiles=$(git diff --name-only origin/main -- mmv1/products)
        if [ ! -z "$yamlfiles" ]; then
          echo "yamlfiles=repo/${yamlfiles//$'\n'/ repo/}" >> $GITHUB_OUTPUT
        fi
    - name: Install yamllint
      if: ${{ !failure() && steps.pull_request.outputs.yamlfiles != '' }}
      run: pip install yamllint
    - name: Lint YAML files
      if: ${{ !failure() && steps.pull_request.outputs.yamlfiles != '' }}
      run: yamllint -c repo/.yamllint ${{steps.pull_request.outputs.yamlfiles}}
  hugo-build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@16361eb4acea8698b220b76c0d4e84e1fd22c61d # v2.6.0
        with:
          hugo-version: '0.115.0'
          extended: true

      - name: Build
        working-directory: ./docs
        run: hugo --minify
