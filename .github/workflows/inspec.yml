---
name: create-inspec-diffs
on:
    pull_request:
        types: ["opened", "synchronize"]
jobs:
    inspec:
        runs-on: ubuntu-latest
        name: "Build Inspec, before and after commit"
        steps:
            - uses: actions/checkout@v1
            - uses: actions/setup-ruby@v1
              with:
                  ruby-version: 2.x
                  architecture: 'x64'
            - run: bundle install
            - uses: actions/checkout@v1
              with:
                  path: inspec-gcp
                  repository: modular-magician/inspec-gcp
                  ref: master

            - name: Configure git.
              run: git config --global user.email "magic-modules@google.com" && git config --global user.name "Modular Magician"
            - run: bundle exec compiler -a -e inspec -o /home/runner/work/magic-modules/inspec-gcp
            - run: git add . && git commit -m "${{ github.event.pull_request.title }}"
              working-directory: /home/runner/work/magic-modules/inspec-gcp
              continue-on-error: true
            - name: Push changes
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ secrets.NATHAN_TOKEN }}
                  repository: ndmckinley/inspec-gcp
                  branch: refs/heads/pr-${{ github.event.pull_request.number }}-new
                  directory: /home/runner/work/magic-modules/inspec-gcp
                  force: true

            - run: git reset --hard HEAD~
              working-directory: /home/runner/work/magic-modules/inspec-gcp
            - run: bundle exec compiler -a -e inspec -o /home/runner/work/magic-modules/inspec-gcp
            - run: git add . && git commit -m "Previous diffbase."
              working-directory: /home/runner/work/magic-modules/inspec-gcp
              continue-on-error: true
            - name: Push changes
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ secrets.NATHAN_TOKEN }}
                  repository: ndmckinley/inspec-gcp
                  branch: refs/heads/pr-${{ github.event.pull_request.number }}-old
                  directory: /home/runner/work/magic-modules/inspec-gcp
                  force: true

            - name: Comment on PR.
              uses: ndmckinley/comment-on-pr@master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  msg: "Successfully generated [diff for InSpec](https://github.com/ndmckinley/inspec-gcp/compare/pr-${{ github.event.pull_request.number }}-old..pr-${{ github.event.pull_request.number }}-new)."
