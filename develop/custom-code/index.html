<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Add custom resource code#
This document covers how to add &ldquo;custom code&rdquo; to MMv1 resources. Custom code can be used to add arbitrary logic to a resource while still generating most of the code; it allows for a balance between maintainability and supporting real-worlds APIs that deviate from what MMv1 can support. Custom code should only be added if the desired behavior can&rsquo;t be achieved otherwise.
Most custom code attributes are strings that contain a path to a template file relative to the mmv1 directory. For example:"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/develop/custom-code/"><meta property="og:site_name" content="Magic Modules"><meta property="og:title" content="Add custom resource code"><meta property="og:description" content="Add custom resource code# This document covers how to add “custom code” to MMv1 resources. Custom code can be used to add arbitrary logic to a resource while still generating most of the code; it allows for a balance between maintainability and supporting real-worlds APIs that deviate from what MMv1 can support. Custom code should only be added if the desired behavior can’t be achieved otherwise.
Most custom code attributes are strings that contain a path to a template file relative to the mmv1 directory. For example:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="develop"><meta property="article:modified_time" content="2024-12-16T14:01:21-05:00"><title>Add custom resource code | Magic Modules</title><link rel=icon href=/magic-modules/favicon.png><link rel=manifest href=/magic-modules/manifest.json><link rel=canonical href=https://googlecloudplatform.github.io/magic-modules/develop/custom-code/><link rel=stylesheet href=/magic-modules/book.min.34f6ea145e56d87823abe9f451d0a8fbe3dbcc6f9e02412199a014611b7adf70.css integrity="sha256-NPbqFF5W2Hgjq+n0UdCo++PbzG+eAkEhmaAUYRt633A=" crossorigin=anonymous><script defer src=/magic-modules/fuse.min.js></script><script defer src=/magic-modules/en.search.min.ed997fde5ff9dc8028f5dec3d3a2ea873935e206a2f9278120a638b6901740cc.js integrity="sha256-7Zl/3l/53IAo9d7D06Lqhzk14gai+SeBIKY4tpAXQMw=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-develop"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/magic-modules/ title=Overview>Overview</a></li></ul><ul><li><a href=/magic-modules/contribution-process/>Contribution process</a></li><li><input type=checkbox id=section-1218d39abefe7f824522d24e615b6429 class=toggle checked>
<label for=section-1218d39abefe7f824522d24e615b6429 class=flex><a role=button>Develop</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/develop/set-up-dev-environment/>Set up your development environment</a></li><li><a href=/magic-modules/develop/add-resource/>Add a resource</a></li><li><a href=/magic-modules/develop/add-fields/>Add a field to an existing resource</a></li><li><a href=/magic-modules/develop/add-iam-support/>Add IAM support</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource/>Add a datasource</a></li><li><a href=/magic-modules/develop/custom-code/ class=active>Add custom resource code</a></li><li><a href=/magic-modules/develop/promote-to-ga/>Promote to GA</a></li><li><a href=/magic-modules/develop/update-dependencies/>Update dependencies</a></li><li><a href=/magic-modules/develop/diffs/>Fix diffs</a></li><li><a href=/magic-modules/develop/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/develop/client-side-fields/>Client-side fields</a></li></ul></li><li><input type=checkbox id=section-46008ee5c4ef0e6f804abf3cfaea6dd0 class=toggle>
<label for=section-46008ee5c4ef0e6f804abf3cfaea6dd0 class=flex><a role=button>Test</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/test/test/>Add resource tests</a></li><li><a href=/magic-modules/test/run-tests/>Run tests</a></li></ul></li><li><input type=checkbox id=section-54e8c97150acf80b182bc188a6e6c492 class=toggle>
<label for=section-54e8c97150acf80b182bc188a6e6c492 class=flex><a role=button>Document</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/document/add-documentation/>Add documentation</a></li><li><a href=/magic-modules/document/handwritten-docs-style-guide/>Handwritten docs style guide</a></li></ul></li><li><input type=checkbox id=section-d11be9eb6f9aad36128162d909d31b29 class=toggle>
<label for=section-d11be9eb6f9aad36128162d909d31b29 class=flex><a role=button>Convert</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/convert/add-new-resource-tgc/>Add TGC conversion</a></li></ul></li><li><input type=checkbox id=section-ca39f9a7961e297a8c04b44ec69dbc58 class=toggle>
<label for=section-ca39f9a7961e297a8c04b44ec69dbc58 class=flex><a role=button>Breaking changes</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/breaking-changes/breaking-changes/>Types of breaking changes</a></li><li><a href=/magic-modules/breaking-changes/make-a-breaking-change/>Make a breaking change</a></li></ul></li><li><input type=checkbox id=section-e42fc06bc1be2cad20d6487ff549c503 class=toggle>
<label for=section-e42fc06bc1be2cad20d6487ff549c503 class=flex><a role=button>Code review</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/code-review/create-pr/>Create a pull request</a></li><li><a href=/magic-modules/code-review/release-notes/>Write release notes</a></li><li><a href=/magic-modules/code-review/review-pr/>Review a pull request</a></li></ul></li><li><input type=checkbox id=section-29607ad0ac6d788001e899a44038a031 class=toggle>
<label for=section-29607ad0ac6d788001e899a44038a031 class=flex><a role=button>Best practices</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/best-practices/immutable-fields/>Immutable fields</a></li><li><a href=/magic-modules/best-practices/deletion-behaviors/>Deletion behaviors</a></li><li><a href=/magic-modules/best-practices/labels-and-annotations/>Labels and annotations</a></li><li><a href=/magic-modules/best-practices/common-resource-patterns/>Common resource patterns</a></li><li><a href=/magic-modules/best-practices/validation/>Validation</a></li></ul></li><li><input type=checkbox id=section-3de530fff78b7e92c59925d632c7e725 class=toggle>
<label for=section-3de530fff78b7e92c59925d632c7e725 class=flex><a role=button>Reference</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/reference/resource/>MMv1 resource reference</a></li><li><a href=/magic-modules/reference/field/>MMv1 field reference</a></li><li><a href=/magic-modules/reference/make-commands/>make commands</a></li><li><a href=/magic-modules/reference/metadata/>MMv1 metadata reference</a></li><li><a href=/magic-modules/reference/ruby-go-changes/>Ruby to Go Migration</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/icons/menu.svg class=book-icon alt=Menu></label><h3>Add custom resource code</h3><label for=toc-control><img src=/magic-modules/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#add-reusable-variables-and-functions>Add reusable variables and functions</a></li><li><a href=#modify-the-api-request-or-response>Modify the API request or response</a><ul><li><a href=#custom_expand>Modify the API request value for a specific field</a></li><li><a href=#encoder>Modify the API request data for an entire resource</a></li><li><a href=#decoder>Modify the API response data for an entire resource</a></li><li><a href=#custom_flatten>Modify the API response value for a specific field</a></li></ul></li><li><a href=#pre_post_injection>Inject code before / after CRUD operations and Import</a><ul><li><a href=#custom-create-error-handling>Custom create error handling</a></li><li><a href=#custom-retry-handling>Custom retry handling</a></li></ul></li><li><a href=#replace-entire-crud-methods>Replace entire CRUD methods</a></li><li><a href=#add-extra-fields-to-a-resource>Add extra fields to a resource</a></li><li><a href=#whats-next>What&rsquo;s next?</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=add-custom-resource-code>Add custom resource code<a class=anchor href=#add-custom-resource-code>#</a></h1><p>This document covers how to add &ldquo;custom code&rdquo; to <a href=https://googlecloudplatform.github.io/magic-modules/#mmv1>MMv1 resources</a>. Custom code can be used to add arbitrary logic to a resource while still generating most of the code; it allows for a balance between maintainability and supporting real-worlds APIs that deviate from what MMv1 can support. Custom code should only be added if the desired behavior can&rsquo;t be achieved otherwise.</p><p>Most custom code attributes are strings that contain a path to a template file relative to the <code>mmv1</code> directory. For example:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#78787e># References mmv1/templates/terraform/custom_delete/resource_name_custom_delete.go.tmpl</span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_delete</span>: templates/terraform/custom_delete/resource_name_custom_delete.go.tmpl</span></span></code></pre></div><p>By convention, the template files are stored in a directory matching the type of custom code, and the name of the file includes the resource (and, if relevant, field) impacted by the custom code. Like handwritten resource and test code, custom code is written as go templates which render go code.</p><p>When in doubt about the behavior of custom code, write the custom code, <a href=https://googlecloudplatform.github.io/magic-modules/develop/generate-providers/>generate the providers</a>, and inspect what changed in the providers using <code>git diff</code>.</p><p>The following sections describe types of custom code in more detail.</p><h2 id=add-reusable-variables-and-functions>Add reusable variables and functions<a class=anchor href=#add-reusable-variables-and-functions>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>constants</span>: templates/terraform/constants/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>Use <code>custom_code.constants</code> to inject top-level code in a resource file. This is useful for anything that should be referenced from other parts of the resource, such as:</p><ul><li>Constants</li><li>Regexes compiled at build time</li><li>Functions, such as <a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#diff_suppress_func>diff suppress functions</a>,
<a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#validation>validation functions</a>,
CustomizeDiff functions, and so on.</li><li>Methods</li></ul><p>Any custom functions added should have thorough <a href=https://googlecloudplatform.github.io/magic-modules/test/test/#add-unit-tests>unit tests</a>.</p><h2 id=modify-the-api-request-or-response>Modify the API request or response<a class=anchor href=#modify-the-api-request-or-response>#</a></h2><p>API requests and responses can be modified in the following order:</p><ol><li>Modify the API request value for a specific field</li><li>Modify the API request data for an entire resource</li><li>Modify the API response data for an entire resource</li><li>Modify the API response value for a specific field</li></ol><p>These are described in more detail in the following sections.</p><h3 id=custom_expand>Modify the API request value for a specific field<a class=anchor href=#custom_expand>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#ff6ac1>name</span>: <span style=color:#5af78e>&#39;FIELD&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>type</span>: String
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_expand</span>: <span style=color:#5af78e>&#39;templates/terraform/custom_expand/PRODUCT_RESOURCE_FIELD.go.tmpl&#39;</span></span></span></code></pre></div><p>Set <code>custom_expand</code> on a field to inject code that modifies the value to send to the API for that field. Custom expanders run <em>before</em> any <a href=#encoder><code>encoder</code> or <code>update_encoder</code></a>. The referenced file must include the function signature for the expander. For example:</p><pre tabindex=0><code class=language-erb data-lang=erb>func expand{{$.GetPrefix}}{{$.TitlelizeProperty}}(v interface{}, d tpgresource.TerraformResourceData, config *transport_tpg.Config) (interface{}, error) {
  if v == nil {
    return nil, nil
  }

  return base64.StdEncoding.EncodeToString([]byte(v.(string))), nil
}</code></pre><p>The parameters the function receives are:</p><ul><li><code>v</code>: The value for the field</li><li><code>d</code>: Terraform resource data. Use <code>d.Get("field_name")</code> to get a field&rsquo;s current value.</li><li><code>config</code>: Config object. Can be used to make API calls.</li></ul><p>The function returns a final value that will be sent to the API.</p><h3 id=encoder>Modify the API request data for an entire resource<a class=anchor href=#encoder>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>encoder</span>: templates/terraform/encoder/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>update_encoder</span>: templates/terraform/update_encoder/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>Use <code>custom_code.encoder</code> to inject code that modifies the data that will be sent in the API request. This is useful if the API expects the data to be in a significantly different structure than Terraform does - for example, if the API expects the entire object to be nested under a key, or a particular field must never be sent to the API. The encoder will run <em>after</em> any <a href=#custom_expand><code>custom_expand</code></a> code.</p><p>The encoder code will be wrapped in a function like:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>resourceProductResourceEncoder</span>(d <span style=color:#ff6ac1>*</span>schema.ResourceData, meta <span style=color:#ff5c57>interface</span>{}, obj <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}) (<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#78787e>// Your code will be injected here.</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The parameters the function receives are:</p><ul><li><code>d</code>: Terraform resource data. Use <code>d.Get("field_name")</code> to get a field&rsquo;s current value.</li><li><code>meta</code>: Can be cast to a Config object (which can make API calls) using <code>meta.(*transport_tpg.Config)</code></li><li><code>obj</code>: The data that will be sent to the API.</li></ul><p>The function returns data that will be sent to the API and an optional error.</p><p>If the Create and Update methods for the resource need different logic, set <code>custom_code.update_encoder</code> to override the logic for update only. It is otherwise the same as <code>custom_code.encoder</code>.</p><h3 id=decoder>Modify the API response data for an entire resource<a class=anchor href=#decoder>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>decoder</span>: templates/terraform/decoder/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>Use <code>custom_code.decoder</code> to inject code that modifies the data recieved from an API response. This is useful if the API returns data in a significantly different structure than what Terraform expects - for example, if the API returns the entire object nested under a key, or uses a different name for a field in the response than in the request. The decoder will run <em>before</em> any <a href=#custom_flatten><code>custom_flatten</code></a> code.</p><p>The decoder code will be wrapped in a function like:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>resourceProductResourceDecoder</span>(d <span style=color:#ff6ac1>*</span>schema.ResourceData, meta <span style=color:#ff5c57>interface</span>{}, res <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}) (<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Your code will be injected here.</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The parameters the function receives are:</p><ul><li><code>d</code>: Terraform resource data. Use <code>d.Get("field_name")</code> to get a field&rsquo;s current value.</li><li><code>meta</code>: Can be cast to a Config object (which can make API calls) using <code>meta.(*transport_tpg.Config)</code></li><li><code>res</code>: The data (&ldquo;response&rdquo;) returned by the API.</li></ul><p>The function returns data that will be set in Terraform state and an optional error.</p><h3 id=custom_flatten>Modify the API response value for a specific field<a class=anchor href=#custom_flatten>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#ff6ac1>name</span>: <span style=color:#5af78e>&#39;FIELD&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>type</span>: String
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_flatten</span>: <span style=color:#5af78e>&#39;templates/terraform/custom_flatten/PRODUCT_RESOURCE_FIELD.go.tmpl&#39;</span></span></span></code></pre></div><p>Set <code>custom_flatten</code> on a field to inject code that modifies the value returned by the API prior to storing it in Terraform state. Custom flatteners run <em>after</em> any <a href=#encoder><code>decoder</code></a>. The referenced file must include the function signature for the flattener. For example:</p><pre tabindex=0><code class=language-erb data-lang=erb>func flatten{{$.GetPrefix}}{{$.TitlelizeProperty}}(v interface{}, d *schema.ResourceData, config *transport_tpg.Config) interface{} {
  if v == nil {
    return &#34;0&#34;
  }
  return v
}</code></pre><p>The parameters the function receives are:</p><ul><li><code>v</code>: The value for the field</li><li><code>d</code>: Terraform resource data. Use <code>d.Get("field_name")</code> to get a field&rsquo;s current value.</li><li><code>config</code>: Config object. Can be used to make API calls.</li></ul><p>The function returns a final value that will be stored in Terraform state for the field, which will be compared with the user&rsquo;s configuration to determine if there is a diff.</p><h2 id=pre_post_injection>Inject code before / after CRUD operations and Import<a class=anchor href=#pre_post_injection>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>pre_create</span>: templates/terraform/pre_create/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>post_create</span>: templates/terraform/post_create/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>pre_read</span>: templates/terraform/pre_read/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>pre_update</span>: templates/terraform/pre_update/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>post_update</span>: templates/terraform/post_update/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>pre_delete</span>: templates/terraform/pre_delete/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>post_delete</span>: templates/terraform/post_delete/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>post_import</span>: templates/terraform/post_import/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>CRUD operations can be modified with pre/post hooks. This code will be injected directly into the relevant CRUD method as close as possible to the related API call and will have access to any variables that are present when it runs. <code>pre_create</code> and <code>pre_update</code> run after any <a href=#encoder><code>encoder</code></a>. Some example use cases:</p><ul><li>Use <code>post_create</code> to set an update-only field after create finishes.</li><li>Use <code>pre_delete</code> to detach a disk before deleting it.</li><li>Use <code>post_import</code> to parse attributes from the import ID and call <code>d.Set("field")</code> so that the resource can be read from the API.</li></ul><h3 id=custom-create-error-handling>Custom create error handling<a class=anchor href=#custom-create-error-handling>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>post_create_failure</span>: templates/terraform/post_create_failure/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>Use <code>custom_code.post_create_failure</code> to inject code that runs if a Create request to the API returns an error.</p><p>The post_create_failure code will be wrapped in a function like:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>resourceProductResourcePostCreateFailure</span>(d <span style=color:#ff6ac1>*</span>schema.ResourceData, meta <span style=color:#ff5c57>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Your code will be injected here.</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>The parameters the function receives are:</p><ul><li><code>d</code>: Terraform resource data. Use <code>d.Get("field_name")</code> to get a field&rsquo;s current value.</li><li><code>meta</code>: Can be cast to a Config object (which can make API calls) using <code>meta.(*transport_tpg.Config)</code></li></ul><h3 id=custom-retry-handling>Custom retry handling<a class=anchor href=#custom-retry-handling>#</a></h3><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>error_retry_predicates</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5af78e>&#39;transport_tpg.IamMemberMissing&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>error_abort_predicates</span>:
</span></span><span style=display:flex><span>  - <span style=color:#5af78e>&#39;transport_tpg.Is429QuotaError&#39;</span></span></span></code></pre></div><p>Use <code>error_retry_predicates</code> or <code>error_abort_predicates</code> functions to retry or abort when encountering certain error responses. By default, errors are retried using <a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/third_party/terraform/transport/error_retry_predicates.go#L23>this list</a> of retry predicates. <code>error_retry_predicates</code> can be used to make more errors retryable, while <code>error_abort_predicates</code> can be used to prevent errors from being retried.</p><p>Both functions use the following signature:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (err <span style=color:#9aedfe>error</span>) (<span style=color:#9aedfe>bool</span>, <span style=color:#9aedfe>string</span>) {}</span></span></code></pre></div><p>The function takes an error and returns:</p><ul><li><code>bool</code>: whether the error should be retried/aborted</li><li><code>string</code>: a reason that will be logged</li></ul><h2 id=replace-entire-crud-methods>Replace entire CRUD methods<a class=anchor href=#replace-entire-crud-methods>#</a></h2><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>custom_code</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_create</span>: templates/terraform/custom_create/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_update</span>: templates/terraform/custom_update/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_delete</span>: templates/terraform/custom_delete/PRODUCT_RESOURCE.go.tmpl
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>custom_import</span>: templates/terraform/custom_import/PRODUCT_RESOURCE.go.tmpl</span></span></code></pre></div><p>Custom methods replace the entire contents of the Create, Update, Delete, or Import methods. For example:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>resourceProductResourceImport</span>(d <span style=color:#ff6ac1>*</span>schema.ResourceData, meta <span style=color:#ff5c57>interface</span>{}) ([]<span style=color:#ff6ac1>*</span>schema.ResourceData, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Your code will be injected here.</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Custom methods are similar to handwritten code and should be avoided if possible. If you have to replace two or more methods, the resource should be handwritten instead.</p><h2 id=add-extra-fields-to-a-resource>Add extra fields to a resource<a class=anchor href=#add-extra-fields-to-a-resource>#</a></h2><p>Use <code>custom_code.extra_schema_entry</code> to add additional fields to a resource. Do not use <code>extra_schema_entry</code> unless there is no other option. The extra fields are injected at the end of the resource&rsquo;s <a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/schemas/schema-types><code>Schema</code> field</a>. They should be formatted as entries in the map. For example:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#5af78e>&#34;foo&#34;</span>: <span style=color:#ff6ac1>&amp;</span>schema.Schema{ <span style=color:#ff6ac1>...</span> },</span></span></code></pre></div><p>Any fields added in this way will need to be have documentation manually added using the top-level <code>docs</code> field:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>docs</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>optional_properties</span>: |<span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>    * `FIELD_NAME` - (Optional, [Beta](https://terraform.io/docs/providers/google/guides/provider_versions.html)) FIELD_DESCRIPTION</span></span></span></code></pre></div><p>See <a href=https://googlecloudplatform.github.io/magic-modules/document/add-documentation/>Add documentation (Handwritten)</a> for more information about what to include in the field documentation.</p><h2 id=whats-next>What&rsquo;s next?<a class=anchor href=#whats-next>#</a></h2><ul><li><a href=https://googlecloudplatform.github.io/magic-modules/test/test/>Add tests</a></li><li><a href=https://googlecloudplatform.github.io/magic-modules/test/run-tests/>Run tests</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/369c73a05c4f5b810dd9eae1b30b8371a78ab7cd title='Last modified by nityaravi | December 16, 2024' target=_blank rel=noopener><img src=/magic-modules/icons/calendar.svg class=book-icon alt>
<span>December 16, 2024</span></a></div><div><a class="flex align-center" href="https://github.com/hashicorp/terraform-provider-google/issues/new?assignees=&labels=technical-debt,documentation&projects=&title=MM%20docsite%20issue%20in%20content/develop%2fcustom-code.md&template=11_developer_productivity.md" target=_blank rel=noopener><img src=/magic-modules/icons/report.svg class=book-icon alt=Edit>
<span>Report documentation issue</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/develop/custom-code.md target=_blank rel="noopener edit"><img src=/magic-modules/icons/edit.svg class=book-icon alt>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap justify-between"><span><a href=/magic-modules/develop/add-handwritten-datasource/ class="flex align-center"><img src=/magic-modules/icons/backward.svg class=book-icon alt=Previous title="Add a datasource">
<span>Add a datasource</span>
</a></span><span><a href=/magic-modules/develop/promote-to-ga/ class="flex align-center"><span>Promote to GA</span>
<img src=/magic-modules/icons/forward.svg class=book-icon alt=Next title="Promote to GA"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#add-reusable-variables-and-functions>Add reusable variables and functions</a></li><li><a href=#modify-the-api-request-or-response>Modify the API request or response</a><ul><li><a href=#custom_expand>Modify the API request value for a specific field</a></li><li><a href=#encoder>Modify the API request data for an entire resource</a></li><li><a href=#decoder>Modify the API response data for an entire resource</a></li><li><a href=#custom_flatten>Modify the API response value for a specific field</a></li></ul></li><li><a href=#pre_post_injection>Inject code before / after CRUD operations and Import</a><ul><li><a href=#custom-create-error-handling>Custom create error handling</a></li><li><a href=#custom-retry-handling>Custom retry handling</a></li></ul></li><li><a href=#replace-entire-crud-methods>Replace entire CRUD methods</a></li><li><a href=#add-extra-fields-to-a-resource>Add extra fields to a resource</a></li><li><a href=#whats-next>What&rsquo;s next?</a></li></ul></nav></div></aside></main></body></html>