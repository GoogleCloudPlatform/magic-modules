<%= lines(autogen_notice :go) -%>

package google

import (
	"fmt"
	"testing"

	"github.com/hashicorp/terraform/helper/acctest"
	"github.com/hashicorp/terraform/helper/resource"
)

<%# Since most resources define a "basic" config as their first example, we can reuse that config to create a resource to test IAM resources with. -%>
<% example = object.examples.reject(&:skip_test)
         .reject { |e| @api.version_obj_or_closest(version) < @api.version_obj_or_closest(e.min_version) }
         .first -%>
<% resource_name = product_ns + object.name -%>
<% 
individual_url = object.self_link_url
params = individual_url.gsub('{{name}}', "{{#{object.name.underscore}}}").scan(/({{)(\w+)(}})/).map { |arr| arr[1] }
-%>
<% 
  tf_product = (@config.legacy_name || product_ns).underscore
  terraform_name = object.legacy_name || "google_#{tf_product}_#{object.name.underscore}"
-%>
<% import_url = individual_url.gsub(/({{)(\w+)(}})/, '%s').gsub(object.__product.base_url, '') -%>
<% import_str = Array.new(params.length, '%s').join('/') -%>
<% import_qualifiers = [] -%>
<% params.each_with_index do |param, i| -%>
	<% if param == 'project' -%>
		<% if i != params.size - 1 -%>
			<%# If the last parameter is project then we want to create a new project to use for the test, so don't default from the environment -%>
			<% if object.iam_policy.test_project_name.nil? -%>
				<% import_qualifiers.push('getTestProjectFromEnv()') -%>
			<% else -%>
				<% import_qualifiers.push('context["project_id"]') -%>
			<% end -%>
		<% end -%>
	<% elsif param == 'zone' -%>
		<% import_qualifiers.push('getTestZoneFromEnv()') -%>
	<% elsif param == 'region' || param == 'location' -%>
		<% import_qualifiers.push('getTestRegionFromEnv()') -%>
	<% end -%>
<% end -%>
func TestAcc<%= resource_name -%>IamBindingGenerated(t *testing.T) {
	t.Parallel()

<%= lines(compile('templates/terraform/iam/iam_context.go.erb')) -%>

	resource.Test(t, resource.TestCase{
		PreCheck:     func() { testAccPreCheck(t) },
		Providers:    testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: testAcc<%= resource_name -%>IamBinding_basicGenerated(context),
			},
			{
				ResourceName:      "<%= terraform_name -%>_iam_binding.foo",
				ImportStateId:     fmt.Sprintf("<%= import_url -%> <%= object.iam_policy.allowed_iam_role -%>"<% unless import_qualifiers.empty? -%>, <% end -%><%= import_qualifiers.join(', ') -%>, <%= example.primary_resource_name -%>),
				ImportState:       true,
				ImportStateVerify: true,
			},
			{
				// Test Iam Binding update
				Config: testAcc<%= resource_name -%>IamBinding_updateGenerated(context),
			},
			{
				ResourceName:      "<%= terraform_name -%>_iam_binding.foo",
				ImportStateId:     fmt.Sprintf("<%= import_url -%> <%= object.iam_policy.allowed_iam_role -%>"<% unless import_qualifiers.empty? -%>, <% end -%><%= import_qualifiers.join(', ') -%>, <%= example.primary_resource_name -%>),
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func TestAcc<%= resource_name -%>IamMemberGenerated(t *testing.T) {
	t.Parallel()

<%= lines(compile('templates/terraform/iam/iam_context.go.erb')) -%>

	resource.Test(t, resource.TestCase{
		PreCheck:  func() { testAccPreCheck(t) },
		Providers: testAccProviders,
		Steps: []resource.TestStep{
			{
				// Test Iam Member creation (no update for member, no need to test)
				Config: testAcc<%= resource_name -%>IamMember_basicGenerated(context),
			},
			{
				ResourceName:      "<%= terraform_name -%>_iam_member.foo",
				ImportStateId:     fmt.Sprintf("<%= import_url -%> <%= object.iam_policy.allowed_iam_role -%> user:admin@hashicorptest.com"<% unless import_qualifiers.empty? -%>, <% end -%><%= import_qualifiers.join(', ') -%>, <%= example.primary_resource_name -%>),
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func TestAcc<%= resource_name -%>IamPolicyGenerated(t *testing.T) {
	t.Parallel()

<%= lines(compile('templates/terraform/iam/iam_context.go.erb')) -%>

	resource.Test(t, resource.TestCase{
		PreCheck:  func() { testAccPreCheck(t) },
		Providers: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: testAcc<%= resource_name -%>IamPolicy_basicGenerated(context),
			},
			{
				ResourceName:      "<%= terraform_name -%>_iam_policy.foo",
				ImportStateId:     fmt.Sprintf("<%= import_url -%>"<% unless import_qualifiers.empty? -%>, <% end -%><%= import_qualifiers.join(', ') -%>, <%= example.primary_resource_name -%>),
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}
<% parent_resource_type_type = object.iam_policy.parent_resource_type || terraform_name -%>

func testAcc<%= resource_name -%>IamMember_basicGenerated(context map[string]interface{}) string {
	return Nprintf(`
<%= example.config_test_body -%>

resource "<%= terraform_name -%>_iam_member" "foo" {
	<%= params.last.underscore -%> = "${<%= parent_resource_type_type -%>.<%= example.primary_resource_id -%>.<%= object.iam_policy.parent_resource_attribute -%>}"
<% unless object.iam_policy.test_project_name.nil? -%>
	project = "%{project_id}"
<% end -%>
	role = "%{role}"
	member = "user:admin@hashicorptest.com"
}
`, context)
}

func testAcc<%= resource_name -%>IamPolicy_basicGenerated(context map[string]interface{}) string {
	return Nprintf(`
<%= example.config_test_body -%>

data "google_iam_policy" "foo" {
	binding {
		role = "%{role}"
		members = ["user:admin@hashicorptest.com"]
	}
}

resource "<%= terraform_name -%>_iam_policy" "foo" {
	<%= params.last.underscore -%> = "${<%= parent_resource_type_type -%>.<%= example.primary_resource_id -%>.<%= object.iam_policy.parent_resource_attribute -%>}"
<% unless object.iam_policy.test_project_name.nil? -%>
	project = "%{project_id}"
<% end -%>
	policy_data = "${data.google_iam_policy.foo.policy_data}"
}
`, context)
}

func testAcc<%= resource_name -%>IamBinding_basicGenerated(context map[string]interface{}) string {
	return Nprintf(`
<%= example.config_test_body -%>

resource "<%= terraform_name -%>_iam_binding" "foo" {
	<%= params.last.underscore -%> = "${<%= parent_resource_type_type -%>.<%= example.primary_resource_id -%>.<%= object.iam_policy.parent_resource_attribute -%>}"
<% unless object.iam_policy.test_project_name.nil? -%>
	project = "%{project_id}"
<% end -%>
	role = "%{role}"
	members = ["user:admin@hashicorptest.com"]
}
`, context)
}

func testAcc<%= resource_name -%>IamBinding_updateGenerated(context map[string]interface{}) string {
	return Nprintf(`
<%= example.config_test_body -%>

resource "<%= terraform_name -%>_iam_binding" "foo" {
	<%= params.last.underscore -%> = "${<%= parent_resource_type_type -%>.<%= example.primary_resource_id -%>.<%= object.iam_policy.parent_resource_attribute -%>}"
<% unless object.iam_policy.test_project_name.nil? -%>
	project = "%{project_id}"
<% end -%>
	role = "%{role}"
	members = ["user:admin@hashicorptest.com", "user:paddy@hashicorp.com"]
}
`, context)
}
