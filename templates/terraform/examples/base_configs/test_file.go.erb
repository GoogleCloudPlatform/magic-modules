<%= lines(autogen_notice :go) -%>

package azurerm

import (
    "fmt"
    "testing"

    "github.com/hashicorp/terraform/helper/resource"
    "github.com/hashicorp/terraform/terraform"
    "github.com/terraform-providers/terraform-provider-azurerm/azurerm/helpers/tf"
    "github.com/terraform-providers/terraform-provider-azurerm/azurerm/utils"
)
<%
    resource_name = "AzureRM" + object.name
    terraform_name = "azurerm_" + object.name.underscore
    azure_client_name = "#{object.api_name}Client".camelcase(:lower)
    properties = object.all_user_properties
%>
<%  if object.instance_variable_defined?(:@acctests) -%>
<%    object.acctests.each do |testName, test| -%>
func TestAcc<%= resource_name -%>_<%= testName -%>(t *testing.T) {
    resourceName := "<%= terraform_name -%>.test"
<%    test.steps.map{|step| object.acctests[step.hcl_reference].hcl_parameters}.flatten.uniq(&:variable_name).each do |param| -%>
    <%= param.variable_name -%> := <%= param.create_expression -%>

<%    end -%>
<%    test.steps.uniq(&:config_name).each do |step| -%>
<%
        hcl_params = object.acctests[step.hcl_reference].hcl_parameters
        uniq_params = hcl_params.uniq(&:variable_name).map(&:variable_name)
-%>
    <%= step.config_name -%> := testAcc<%= resource_name -%>_<%= step.hcl_reference -%>(<%= uniq_params.join(", ") -%>)
<%    end -%>
<% -%>

    resource.ParallelTest(t, resource.TestCase{
        PreCheck:     func() { testAccPreCheck(t) },
        Providers:    testAccProviders,
        CheckDestroy: testCheck<%= resource_name -%>Destroy,
        Steps: []resource.TestStep{
<%      test.steps.each do |step| -%>
<%
          hcl = object.acctests[step.hcl_reference]
          props_to_check = Hash.new
          until hcl.nil? do
            hcl.properties.each do |propName, prop|
              props_to_check[propName] = prop unless props_to_check.has_key?(propName)
            end
            hcl = hcl.based_on.nil? ? nil : object.acctests[hcl.based_on]
          end
          props_to_check.reject!{|pn, pv| object.azure_sdk_definition.read.request.has_key?(object.properties.find{|p| p.name == pn}.azure_api_path) }
-%>
            {
                Config: <%= step.config_name -%>,
                Check: resource.ComposeTestCheckFunc(
                    testCheck<%= resource_name -%>Exists(resourceName),
<%        props_to_check.each do |propName, propValue| -%>
                    resource.TestCheckResourceAttr(resourceName, "<%= propName.underscore -%>", "<%= propValue -%>"),
<%        end -%>
                ),
            },
<%      end -%>
<%      if test.check_import -%>
            {
                ResourceName:      resourceName,
                ImportState:       true,
                ImportStateVerify: true,
            },
<%      end -%>
        },
    })
}

<%    end -%>
<%  end -%>

func testCheck<%= resource_name -%>Exists(resourceName string) resource.TestCheckFunc {
    return func(s *terraform.State) error {
        rs, ok := s.RootModule().Resources[resourceName]
        if !ok {
            return fmt.Errorf("<%= object.name.titlecase -%> not found: %s", resourceName)
        }

<%= lines(build_acctest_parameters_from_schema(object.azure_sdk_definition.read, properties, object, true)) -%>

        client := testAccProvider.Meta().(*ArmClient).<%= azure_client_name -%>

        ctx := testAccProvider.Meta().(*ArmClient).StopContext

        if resp, err := <%= build_sdk_func_invocation(object.azure_sdk_definition.read) -%>; err != nil {
            if utils.ResponseWasNotFound(resp.Response) {
                return <%= build_errorf_with_resource_name("Bad: %s does not exist", false, object.azure_sdk_definition.delete, properties, object) -%>

            }
            return fmt.Errorf("Bad: Get on <%= azure_client_name -%>: %+v", err)
        }

        return nil
    }
}

func testCheck<%= resource_name -%>Destroy(s *terraform.State) error {
    client := testAccProvider.Meta().(*ArmClient).<%= azure_client_name -%>

    ctx := testAccProvider.Meta().(*ArmClient).StopContext

    for _, rs := range s.RootModule().Resources {
        if rs.Type != "<%= terraform_name -%>" {
            continue
        }

<%= lines(build_acctest_parameters_from_schema(object.azure_sdk_definition.read, properties, object)) -%>

        if resp, err := <%= build_sdk_func_invocation(object.azure_sdk_definition.read) -%>; err != nil {
            if !utils.ResponseWasNotFound(resp.Response) {
                return fmt.Errorf("Bad: Get on <%= azure_client_name -%>: %+v", err)
            }
        }

        return nil
    }

    return nil
}

<%  if object.instance_variable_defined?(:@acctests) -%>
<%    object.acctests.each do |testName, test| -%>
<%      uniq_params = test.hcl_parameters.uniq(&:variable_name).map{|p| "#{p.variable_name} #{p.go_type}"} -%>
func testAcc<%= resource_name -%>_<%= testName -%>(<%= uniq_params.join(", ") -%>) string {
    return fmt.Sprintf(`
<%= build_acctest_dependencies_hcl(test, object) -%>


<%= build_acctest_resource_test_hcl(test, object) -%>

`, <%= test.hcl_parameters.map(&:variable_name).join(", ") -%>)
}

<%    end -%>
<%  end -%>