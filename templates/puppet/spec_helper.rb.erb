<% if false # the license inside this if block assertains to this file -%>
# Copyright 2017 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
<% end -%>
<%= compile 'templates/license.erb' -%>

<%= lines(autogen_notice :ruby) -%>

#----------------------------------------------------------
# Setup timezone.
#
# Our default timezone is UTC, to avoid local time compromise
# test code seed generation.

ENV['TZ'] = 'UTC'

#----------------------------------------------------------
# Add test path to the search libs

$LOAD_PATH.unshift(File.expand_path('.'))
<% if spec_stubs? -%>
$LOAD_PATH.unshift(File.expand_path('./spec/stubs'))
# Add fixtures so that they can be loaded by integration tests.
$LOAD_PATH.unshift(File.expand_path('./spec/fixtures/modules/gauth/lib'))
$LOAD_PATH.unshift(File.expand_path('./spec/fixtures/modules/<%= @api.prefix -%>/lib'))
<% end # spec_stubs? -%>

#----------------------------------------------------------
# Block all network traffic
require 'puppetlabs_spec_helper/module_spec_helper'
require 'webmock/rspec'

#----------------------------------------------------------
# Setup PuppetSpec to allow executing the Puppet manifests from within tests

require 'puppet'

module PuppetSpec
  puppet_dir = File.dirname(Puppet.method(:settings).source_location[0])
  require File.join(puppet_dir, '../spec/lib/puppet_spec/compiler')
  require File.join(puppet_dir, '../spec/lib/puppet_spec/files')
end

require 'rspec-puppet'

RSpec.configure do |c|
  c.include PuppetSpec::Compiler
  c.include PuppetSpec::Files

  c.filter_run_excluding broken: true

  Puppet::Test::TestHelper.initialize

  c.before :all do
    Puppet::Test::TestHelper.before_all_tests
  end

  c.after :all do
    Puppet::Test::TestHelper.after_all_tests
  end

  c.before :each do
    base = PuppetSpec::Files.tmpdir('tmp_settings')
    Puppet[:vardir] = File.join(base, 'var')
    Puppet[:confdir] = File.join(base, 'etc')
    Puppet[:codedir] = File.join(base, 'code')
    Puppet[:logdir] = '$vardir/log'
    Puppet[:rundir] = '$vardir/run'
    Puppet[:hiera_config] = File.join(base, 'hiera')

    FileUtils.mkdir_p Puppet[:statedir]

    Puppet::Test::TestHelper.before_each_test
  end

  c.after :each do
    Puppet::Test::TestHelper.after_each_test
    PuppetSpec::Files.cleanup
  end
end

def get_example(example_name)
  ex = read_example(example_name)
  healthcheck_fn = File.open('spec/fixtures/mock_hc_fn.pp').read
  healthcheck_fn + "\n\n" + ex
end

def read_example(example_name)
  # It's not ideal, but puppet unit tests don't support
  # these facts-as-variables, so we have to do these
  # substitutions ourselves.
  File.open("examples/#{example_name}.pp", 'rb').read\
      .gsub('$project', "\"#{ENV['GOOGLE_PROJECT']}\"")\
      .gsub('$cred_path', "\"#{ENV['GOOGLE_CREDENTIALS_PATH']}\"")
end


require 'mocha/test_unit'

#----------------------------------------------------------
# Helper modules

require 'yaml'
