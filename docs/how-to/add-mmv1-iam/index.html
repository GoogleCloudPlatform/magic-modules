<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="For resources implemented through the MMv1 engine, the majority of configuration for IAM support can be inferred based on the preexisting YAML specification file."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Add MMv1 IAM resources"><meta property="og:description" content="For resources implemented through the MMv1 engine, the majority of configuration for IAM support can be inferred based on the preexisting YAML specification file."><meta property="og:type" content="article"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/docs/how-to/add-mmv1-iam/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-03-08T13:22:11-08:00"><title>Add MMv1 IAM resources | Magic Modules</title><link rel=manifest href=/magic-modules/manifest.json><link rel=icon href=/magic-modules/favicon.png type=image/x-icon><link rel=stylesheet href=/magic-modules/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/magic-modules/flexsearch.min.js></script>
<script defer src=/magic-modules/en.search.min.2f653af129452131d2b57b9c0e9fa9ec37004674da72f2dff61bdc033552be6e.js integrity="sha256-L2U68SlFITHStXucDp+p7DcARnTacvLf9hvcAzVSvm4=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><span>Getting Started</span><ul><li><a href=/magic-modules/docs/getting-started/setup/>Set up your environment</a></li><li><a href=/magic-modules/docs/getting-started/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/docs/getting-started/run-provider-tests/>Run provider tests</a></li><li><a href=/magic-modules/docs/getting-started/use-built-provider/>Use built provider</a></li><li><a href=/magic-modules/docs/getting-started/contributing/>Contributing</a></li><li><a href=/magic-modules/docs/getting-started/provider-documentation/>Provider documentation</a></li></ul></li><li><a href=/magic-modules/docs/how-to/>How To</a><ul><li><a href=/magic-modules/docs/how-to/types-of-resources/>Types of resources</a></li><li><a href=/magic-modules/docs/how-to/add-mmv1-resource/>Add an MMv1 resource</a></li><li><a href=/magic-modules/docs/how-to/add-mmv1-iam/ class=active>Add MMv1 IAM resources</a></li><li><a href=/magic-modules/docs/how-to/add-mmv1-test/>Add an MMv1 test</a></li><li><a href=/magic-modules/docs/how-to/mmv1-resource-documentation/>Add and update MMv1 resource documentation</a></li><li><a href=/magic-modules/docs/how-to/update-handwritten-resource/>Update a handwritten resource</a></li><li><a href=/magic-modules/docs/how-to/add-handwritten-test/>Add a handwritten test</a></li><li><a href=/magic-modules/docs/how-to/add-handwritten-datasource/>Add a handwritten datasource</a></li><li><a href=/magic-modules/docs/how-to/add-handwritten-iam/>Add handwritten IAM resources</a></li><li><a href=/magic-modules/docs/how-to/update-handwritten-documentation/>Update handwritten provider documentation</a></li><li><a href=/magic-modules/docs/how-to/add-handwritten-datasource-documentation/>Add documentation for a handwritten data source</a></li></ul></li><li><a href=/magic-modules/docs/best-practices/>Best practices</a><ul></ul></li><li><span>Reference</span><ul><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource.rb target=_blank rel=noopener>api.yaml resource ↗</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/overrides/terraform/resource_override.rb target=_blank rel=noopener>terraform.yaml resource ↗</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Add MMv1 IAM resources</strong>
<label for=toc-control><img src=/magic-modules/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#adding-iam-support-to-nonexistent-resources>Adding IAM support to nonexistent resources</a></li></ul></nav></aside></header><article class=markdown><h1 id=add-mmv1-iam-resources>Add MMv1 IAM resources
<a class=anchor href=#add-mmv1-iam-resources>#</a></h1><p>For resources implemented through the MMv1 engine, the majority of configuration
for IAM support can be inferred based on the preexisting YAML specification file.</p><p>To add support for IAM resources based on an existing resource, add an
<code>iam_policy</code> block to the resource&rsquo;s definition in <code>api.yaml</code>, such as the
following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>iam_policy</span>: !<span style=color:#ae81ff>ruby/object:Api::Resource::IamPolicy</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>method_name_separator</span>: <span style=color:#e6db74>&#39;:&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>fetch_iam_policy_verb</span>: :<span style=color:#ae81ff>POST      </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>parent_resource_attribute</span>: <span style=color:#e6db74>&#39;registry&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>import_format</span>: [<span style=color:#e6db74>&#34;projects/{{project}}/locations/{{location}}/registries/{{name}}&#34;</span>, <span style=color:#e6db74>&#34;{{name}}&#34;</span>]         
</span></span></code></pre></div><p>The specification values can be determined based on a mixture of the resource
specification and the cloud.google.com <code>setIamPolicy</code>/<code>getIamPolicy</code> REST
documentation, such as
<a href=https://cloud.google.com/iot/docs/reference/cloudiot/rest/v1/projects.locations.registries/setIamPolicy>this page</a>
for Cloud IOT Registries.</p><p><code>parent_resource_attribute</code> - (Required) determines the field name of the parent
resource reference in the IAM resources. Generally, this should be the singular
form of the parent resource kind in snake case, i.e. <code>registries</code> -> <code>registry</code>
or <code>backendServices</code> -> <code>backend_service</code>.</p><p><code>method_name_separator</code> - (Required) should be set to the character preceding
<code>setIamPolicy</code> in the &ldquo;HTTP Request&rdquo; section on the resource&rsquo;s <code>setIamPolicy</code>
page. This is almost always <code>:</code> for APIs other than Google Compute Engine (GCE),
MMv1&rsquo;s <code>compute</code> product.</p><p><code>fetch_iam_policy_verb</code> - (Required) should be set to the HTTP verb listed in
the &ldquo;HTTP Request&rdquo; section on the resource&rsquo;s <code>getIamPolicy</code> page. This is
generally <code>POST</code> but is occasionally <code>GET</code>. Note: This is specified as a Ruby
symbol, prefixed with a <code>:</code>. For example, for <code>GET</code>, you would specify <code>:GET</code>.</p><p><code>import_format</code> - (Optional) A list of templated strings used to determine the
Terraform import format. If the resource has a custom <code>import_format</code> or
<code>id_format</code> defined in <code>terraform.yaml</code>, this must be supplied.</p><ul><li>If an <code>import_format</code> is set on the parent resource use that set of values exactly, substituting <code>parent_resource_attribute</code> for the field name of the <strong>final</strong> templated value.</li><li>If an <code>id_format</code> is set on the parent resource use that as the first entry (substituting the final templated value, as with <code>import_format</code>) and define a second format with <strong>only</strong> the templated values, <code>/</code>-separated. For example, <code>projects/{{project}}/locations/{{region}}/myResources/{{name}}</code> -> <code>["projects/{{project}}/locations/{{region}}/myResources/{{myResource}}", "{{project}}/{{region}}/{{myResource}}"]</code>.<ul><li>Optionally, you may provide a version of the shortened format that excludes entries called <code>{{project}}</code>, <code>{{region}}</code>, and <code>{{zone}}</code>. For example, given <code>{{project}}/{{region}}/{{myResource}}/{{entry}}</code>, <code>{{myResource}}/{{entry}}</code> is a valid format. When a user specifies this format, the provider&rsquo;s default values for <code>project</code>/<code>region</code>/<code>zone</code> will be used.</li></ul></li></ul><p><code>allowed_iam_role</code> - (Optional) If the resource does not allow the
<code>roles/viewer</code> IAM role to be set, an alternate, valid role must be provided.</p><p><code>iam_conditions_request_type</code> - (Optional) The method the IAM policy version is
set in <code>getIamPolicy</code>. If unset, IAM conditions are assumed to not be supported for the resource. One of <code>QUERY_PARAM</code>, <code>QUERY_PARAM_NESTED</code> or <code>REQUEST_BODY</code>. For resources where a query parameter is expected, <code>QUERY_PARAM</code> should be used if the key is <code>optionsRequestedPolicyVersion</code>, while <code>QUERY_PARAM_NESTED</code> should be used if it is <code>options.requestedPolicyVersion</code>.</p><p><code>min_version</code> - (Optional) If the resource or IAM method is not generally
available, this should be set to <code>beta</code> or <code>alpha</code> as appropriate.</p><p><code>set_iam_policy_verb</code> - (Optional, rare) Similar to <code>fetch_iam_policy_verb</code>, the
HTTP verb expected by <code>setIamPolicy</code>. Defaults to <code>:POST</code>, and should only be
specified if it differs (typically if <code>:PUT</code> is expected).</p><p>Several single-user settings are not documented on this page as they are not
expected to recur often. If you are unable to configure your API successfully,
you may want to consult <a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource/iam_policy.rb>https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource/iam_policy.rb</a>
for additional configuration options.</p><p>Additionally, in order to generate IAM tests based on a preexisting resource
configuration, the first <code>examples</code> entry in <code>terraform.yaml</code> must be modified
to include a <code>primary_resource_name</code> entry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>      - !ruby/object:Provider::Terraform::Examples
</span></span><span style=display:flex><span>        name: &#34;disk_basic&#34;
</span></span><span style=display:flex><span>        primary_resource_id: &#34;default&#34;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        primary_resource_name: &#34;fmt.Sprintf(\&#34;tf-test-test-disk%s\&#34;, context[\&#34;random_suffix\&#34;])&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>        vars:
</span></span><span style=display:flex><span>          disk_name: &#34;test-disk&#34;
</span></span></code></pre></div><p><code>primary_resource_name</code> - Typically
<code>"fmt.Sprintf(\"tf-test-{{shortname}}%s\", context[\"random_suffix\"])"</code>,
substituting the parent resource&rsquo;s shortname from the example configuration for
<code>{{shortname}}</code>, such as <code>test-disk</code> above. This value is variable, as both the
key and value are user-defined parts of the example configuration. In some cases
the value must be customized further, albeit rarely.</p><p>Once an <code>iam_policy</code> block is added and filled out, and <code>primary_resource_name</code>
is set on the first example, you&rsquo;re finished, and you can run MMv1 to generate
the IAM resources you&rsquo;ve added, alongside documentation, and tests.</p><h2 id=adding-iam-support-to-nonexistent-resources>Adding IAM support to nonexistent resources
<a class=anchor href=#adding-iam-support-to-nonexistent-resources>#</a></h2><p>Some IAM targets don&rsquo;t exist as distinct resources, such as IAP, or their target
is supported through an engine other than MMv1 (i.e. through tpgtools/DCL or a
handwritten resource). For these resources, the <code>exclude_resource: true</code>
annotation can be used. To use it, partially define the resource in the
product&rsquo;s <code>api.yaml</code> file and apply the annotation. MMv1 won&rsquo;t attempt to
generate the resource itself and will only generate IAM resources targeting it.</p><p>For tpgtools/DCL resources, you may need to set the <code>PRODUCT_BASE_PATH</code> override
to ensure that MMv1 is the sole library trying to set the base product URL.</p><p>The IAP product is a good reference for adding IAM support to nonexistent resources:
<a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/products/iap>https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/products/iap</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/b2658055aa4c1dc53c77168dec44c7edc20ebc3a title='Last modified by Stephen Lewis (Burrows) | March 8, 2023' target=_blank rel=noopener><img src=/magic-modules/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 8, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/docs/how-to/add-mmv1-iam.md target=_blank rel=noopener><img src=/magic-modules/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#adding-iam-support-to-nonexistent-resources>Adding IAM support to nonexistent resources</a></li></ul></nav></div></aside></main></body></html>