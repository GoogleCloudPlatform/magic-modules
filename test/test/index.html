<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  Add resource tests
  #

This page describes how to add tests to a new resource in the google or google-beta Terraform provider.
The providers have two basic types of tests:

Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs.
Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider&rsquo;s behavior in constructing the API requests and parsing the responses.

Acceptance tests are also called &ldquo;VCR tests&rdquo; because they use go-vcr to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don&rsquo;t actually need to be created, updated, or destroyed by the live API."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/test/test/"><meta property="og:site_name" content="Magic Modules"><meta property="og:title" content="Add resource tests"><meta property="og:description" content="Add resource tests # This page describes how to add tests to a new resource in the google or google-beta Terraform provider.
The providers have two basic types of tests:
Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs. Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider’s behavior in constructing the API requests and parsing the responses. Acceptance tests are also called “VCR tests” because they use go-vcr to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don’t actually need to be created, updated, or destroyed by the live API."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="test"><meta property="article:modified_time" content="2025-01-22T13:54:33-08:00"><title>Add resource tests | Magic Modules</title>
<link rel=manifest href=/magic-modules/manifest.json><link rel=icon href=/magic-modules/favicon.png><link rel=canonical href=https://googlecloudplatform.github.io/magic-modules/test/test/><link rel=stylesheet href=/magic-modules/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css integrity="sha256-MJt+0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin=anonymous><script defer src=/magic-modules/fuse.min.js></script><script defer src=/magic-modules/en.search.min.bc0d696b442e077fe8fdb10978c511833dbeb07c944cf6a1c2923f1a43d88d28.js integrity="sha256-vA1pa0QuB3/o/bEJeMURgz2+sHyUTPahwpI/GkPYjSg=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/magic-modules/>Overview</a></li></ul><ul><li><a href=/magic-modules/contribution-process/>Contribution process</a></li><li><span>Develop</span><ul><li><a href=/magic-modules/develop/set-up-dev-environment/>Set up your development environment</a></li><li><a href=/magic-modules/develop/add-resource/>Add a resource</a></li><li><a href=/magic-modules/develop/add-fields/>Add a field to an existing resource</a></li><li><a href=/magic-modules/develop/add-iam-support/>Add IAM support</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource/>Add a datasource</a></li><li><a href=/magic-modules/develop/custom-code/>Add custom resource code</a></li><li><a href=/magic-modules/develop/promote-to-ga/>Promote to GA</a></li><li><a href=/magic-modules/develop/update-dependencies/>Update dependencies</a></li><li><a href=/magic-modules/develop/diffs/>Fix diffs</a></li><li><a href=/magic-modules/develop/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/develop/client-side-fields/>Client-side fields</a></li></ul></li><li><span>Test</span><ul><li><a href=/magic-modules/test/test/ class=active>Add resource tests</a></li><li><a href=/magic-modules/test/run-tests/>Run tests</a></li></ul></li><li><span>Document</span><ul><li><a href=/magic-modules/document/add-documentation/>Add documentation</a></li><li><a href=/magic-modules/document/handwritten-docs-style-guide/>Handwritten docs style guide</a></li></ul></li><li><span>Breaking changes</span><ul><li><a href=/magic-modules/breaking-changes/breaking-changes/>Types of breaking changes</a></li><li><a href=/magic-modules/breaking-changes/make-a-breaking-change/>Make a breaking change</a></li></ul></li><li><span>Code review</span><ul><li><a href=/magic-modules/code-review/create-pr/>Create a pull request</a></li><li><a href=/magic-modules/code-review/release-notes/>Write release notes</a></li><li><a href=/magic-modules/code-review/review-pr/>Review a pull request</a></li></ul></li><li><span>Best practices</span><ul><li><a href=/magic-modules/best-practices/immutable-fields/>Immutable fields</a></li><li><a href=/magic-modules/best-practices/deletion-behaviors/>Deletion behaviors</a></li><li><a href=/magic-modules/best-practices/labels-and-annotations/>Labels and annotations</a></li><li><a href=/magic-modules/best-practices/common-resource-patterns/>Common resource patterns</a></li></ul></li><li><span>Reference</span><ul><li><a href=/magic-modules/reference/resource/>MMv1 resource reference</a></li><li><a href=/magic-modules/reference/field/>MMv1 field reference</a></li><li><a href=/magic-modules/reference/make-commands/>make commands</a></li><li><a href=/magic-modules/reference/metadata/>MMv1 metadata reference</a></li><li><a href=/magic-modules/reference/ruby-go-changes/>Ruby to Go Migration</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Add resource tests</strong>
<label for=toc-control><img src=/magic-modules/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before you begin</a></li><li><a href=#add-a-create-test>Add a create test</a></li><li><a href=#add-an-update-test>Add an update test</a></li><li><a href=#add-unit-tests>Add unit tests</a></li><li><a href=#skip-vcr>Skip tests in VCR replaying mode</a><ul><li><a href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode</a></li></ul></li><li><a href=#whats-next>What&rsquo;s next?</a></li><li><a href=#references>References</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=add-resource-tests>Add resource tests
<a class=anchor href=#add-resource-tests>#</a></h1><p>This page describes how to add tests to a new resource in the <code>google</code> or <code>google-beta</code> Terraform provider.</p><p>The providers have two basic types of tests:</p><ul><li>Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs.</li><li>Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider&rsquo;s behavior in constructing the API requests and parsing the responses.</li></ul><p>Acceptance tests are also called &ldquo;VCR tests&rdquo; because they use <a href=https://github.com/dnaeon/go-vcr><code>go-vcr</code></a> to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don&rsquo;t actually need to be created, updated, or destroyed by the live API.</p><p>For more information about testing, see the <a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/testing/acceptance-tests>official Terraform documentation</a>.</p><h2 id=before-you-begin>Before you begin
<a class=anchor href=#before-you-begin>#</a></h2><ol><li>Determine whether your resources is using <a href=https://googlecloudplatform.github.io/magic-modules/>MMv1 generation or handwritten</a>.</li><li>If you are not adding tests to an in-progress PR, ensure that your <code>magic-modules</code>, <code>terraform-provider-google</code>, and <code>terraform-provider-google-beta</code> repositories are up to date.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd ~/magic-modules
</span></span><span style=display:flex><span>git checkout main <span style=color:#f92672>&amp;&amp;</span> git clean -f . <span style=color:#f92672>&amp;&amp;</span> git checkout -- . <span style=color:#f92672>&amp;&amp;</span> git pull
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google
</span></span><span style=display:flex><span>git checkout main <span style=color:#f92672>&amp;&amp;</span> git clean -f . <span style=color:#f92672>&amp;&amp;</span> git checkout -- . <span style=color:#f92672>&amp;&amp;</span> git pull
</span></span><span style=display:flex><span>cd $GOPATH/src/github.com/hashicorp/terraform-provider-google-beta
</span></span><span style=display:flex><span>git checkout main <span style=color:#f92672>&amp;&amp;</span> git clean -f . <span style=color:#f92672>&amp;&amp;</span> git checkout -- . <span style=color:#f92672>&amp;&amp;</span> git pull
</span></span></code></pre></div></li></ol><h2 id=add-a-create-test>Add a create test
<a class=anchor href=#add-a-create-test>#</a></h2><p>A create test is a test that creates the target resource and immediately destroys it.</p><blockquote><p><strong>Note:</strong> All resources should have a &ldquo;basic&rdquo; create test, which uses the smallest possible number of fields. Additional create tests can be used to ensure all fields on the resource are used in at least one test.</p></blockquote><div class=book-tabs><input type=radio class=toggle name=tabs-create id=tabs-create-0 checked>
<label for=tabs-create-0>MMv1</label><div class="book-tabs-content markdown-inner"><ol><li><p>Add an entry to your <code>RESOURCE_NAME.yaml</code> file&rsquo;s <code>examples</code>. The fields listed here are the most commonly-used. For a comprehensive reference, see <a href=https://googlecloudplatform.github.io/magic-modules/reference/resource/#examples>MMv1 resource reference: <code>examples</code> ↗</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>examples</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># name must correspond to a configuration file that you&#39;ll create in the next step.</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># The name should include the product name, resource name, and a basic description</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># of the test. This will be used to generate the test name and the documentation</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># header.</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;PRODUCT_RESOURCE_basic&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># primary_resource_id will be used for the Terraform resource id in the configuration file.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>primary_resource_id</span>: <span style=color:#e6db74>&#34;example&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># vars contains key/value pairs of variables to inject into the configuration file.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># These can be referenced in the configuration file as a key inside `{{$.Vars}}`.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># All resource IDs (even for resources not under test) should be declared</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># with variables that contain a `-` or `_`; this will ensure that, in tests,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># the resources are created with a `tf-test` prefix to allow automatic cleanup</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># of dangling resources and a random suffix to avoid name collisions.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>network_name</span>: <span style=color:#e6db74>&#34;example-network&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># test_vars_overrides contains key/value pairs of literal overrides for</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># variables used in tests. This can be used to call functions to</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># generate or determine a variable&#39;s value – for example, bootstrapping</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># a shared network for your product to avoid test failures due to limits</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># on the default network.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>test_vars_overrides</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>network_name</span>: <span style=color:#e6db74>&#39;acctest.BootstrapSharedServiceNetworkingConnection(t, &#34;PRODUCT-RESOURCE-network-config&#34;)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set min_version: beta if the resource is not beta-only and any beta-only fields are being tested.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>min_version</span>: <span style=color:#ae81ff>beta</span>
</span></span></code></pre></div></li><li><p>Create a <code>.tf.tmpl</code> file in <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/templates/terraform/examples><code>mmv1/templates/terraform/examples/</code></a>. The name of the file should match the name of the example created in the previous step. For example, <code>PRODUCT_RESOURCE_basic.tf.tmpl</code>.</p></li><li><p>In that file, write the Terraform configuration for your test. This should include all of the required dependencies. For example, <code>google_compute_subnetwork</code> has a dependency on <code>google_compute_network</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_subnetwork&#34;</span> <span style=color:#e6db74>&#34;{{$.PrimaryResourceId}}&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>          = <span style=color:#e6db74>&#34;{{index $.Vars &#34;</span><span style=color:#a6e22e>subnetwork_name</span><span style=color:#e6db74>&#34;}}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ip_cidr_range</span> = <span style=color:#e6db74>&#34;10.1.0.0/16&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span>        = <span style=color:#e6db74>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>network</span>       = <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_network&#34;</span> <span style=color:#e6db74>&#34;network&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>                    = <span style=color:#e6db74>&#34;{{index $.Vars &#34;</span><span style=color:#a6e22e>network_name</span><span style=color:#e6db74>&#34;}}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>auto_create_subnetworks</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>If the resource or the example is beta-only:</p><ul><li>Add <code>provider = google-beta</code> to every resource in the file.</li></ul></li></ol></div><input type=radio class=toggle name=tabs-create id=tabs-create-1>
<label for=tabs-create-1>Handwritten</label><div class="book-tabs-content markdown-inner"><p>This section assumes you&rsquo;ve used the <a href=https://googlecloudplatform.github.io/magic-modules/develop/add-resource/>Add a resource</a> guide to create your handwritten resource, and you have a working MMv1 config.</p><blockquote><p><strong>Note:</strong> If not, you can create one now, or skip this guide and construct the test by hand. Writing tests by hand can sometimes be a better option if there is a similar test you can copy from.</p></blockquote><ol><li>Add the test in MMv1. Repeat for all the create tests you will need.</li><li><a href=https://googlecloudplatform.github.io/magic-modules/develop/generate-providers/>Generate the beta provider</a>.</li><li>From the beta provider, copy and paste the generated <code>*_generated_test.go</code> file into the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services/><code>magic-modules/mmv1/third_party/terraform/services</code></a> as a new file call <code>*_test.go</code>.</li><li>Modify the tests as needed.<ul><li>Replace all occurrences of <code>github.com/hashicorp/terraform-provider-google-beta/google-beta</code> with <code>github.com/hashicorp/terraform-provider-google/google</code></li><li>Remove the comments at the top of the file.</li><li>Remove the <code>Example</code> suffix from all function names.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li></ul></li></ul></li></ol></div></div><h2 id=add-an-update-test>Add an update test
<a class=anchor href=#add-an-update-test>#</a></h2><p>An update test is a test that creates the target resource and then makes updates to fields that are updatable. Updatable fields are fields that can be updated without recreating the entire resource; that is, they are not marked <code>immutable</code> in MMv1 or <code>ForceNew</code> in handwritten code.</p><blockquote><p><strong>Note:</strong> All updatable fields must be covered by at least one update test. In most cases, only a single update test is needed to test all fields at once.</p></blockquote><div class=book-tabs><input type=radio class=toggle name=tabs-update id=tabs-update-0 checked>
<label for=tabs-update-0>MMv1</label><div class="book-tabs-content markdown-inner"><ol><li><a href=https://googlecloudplatform.github.io/magic-modules/develop/generate-providers/>Generate the beta provider</a>.</li><li>From the beta provider, copy and paste the generated <code>*_generated_test.go</code> file into the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> as a new file call <code>*_test.go</code>.</li><li>Using an editor of your choice, delete the <code>*DestroyProducer</code> function, and all but one test. The remaining test should be the &ldquo;full&rdquo; test, or if there is no &ldquo;full&rdquo; test, the &ldquo;basic&rdquo; test. This will be the starting point for your new update test.</li><li>Modify the <code>TestAcc*</code> <em>test function</em> to support updates.<ul><li>Change the suffix of the test function to <code>_update</code>.</li><li>Copy the 2 <code>TestStep</code> blocks and paste them immediately after, so that there are 4 total test steps.</li><li>Change the suffix of the first <code>Config</code> value to <code>_full</code> (or <code>_basic</code>).</li><li>Change the suffix of the second <code>Config</code> value to <code>_update</code>.</li><li>Add <code>ConfigPlanChecks</code> to the update step of the test to ensure the resource is updated in-place.</li><li>The resulting test function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestAccPubsubTopic_update</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>acctest</span>.<span style=color:#a6e22e>VcrTest</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>TestCase</span>{
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Steps</span>: []<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>TestStep</span>{
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Config</span>: <span style=color:#a6e22e>testAccPubsubTopic_full</span>(<span style=color:#f92672>...</span>),
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Config</span>: <span style=color:#a6e22e>testAccPubsubTopic_update</span>(<span style=color:#f92672>...</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ConfigPlanChecks</span>: <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>ConfigPlanChecks</span>{
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>PreApply</span>: []<span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>PlanCheck</span>{
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>ExpectResourceAction</span>(<span style=color:#e6db74>&#34;google_pubsub_topic.foo&#34;</span>, <span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>ResourceActionUpdate</span>),
</span></span><span style=display:flex><span>               },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Modify the <code>testAcc*</code> Terraform <em>template function</em> to support updates.<ul><li>Copy the template function and paste it immediately after so that there are 2 template functions.</li><li>Change the suffix of the first template function to <code>_full</code> (or <code>_basic</code>).</li><li>Change the suffix of the second template function to <code>_update</code>.</li><li>The resulting template functions would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>testAccPubsubTopic_full</span>(<span style=color:#f92672>...</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>testAccPubsubTopic_update</span>(<span style=color:#f92672>...</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Modify the test as needed.<ul><li>Replace all occurrences of <code>github.com/hashicorp/terraform-provider-google-beta/google-beta</code> with <code>github.com/hashicorp/terraform-provider-google/google</code></li><li>Modify the template function ending in <code>_update</code> so that updatable fields are changed or removed. This may require additions to the <code>context</code> map in the test function.</li><li>Remove the comments at the top of the file.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li><li>In each beta-only test, ensure that the TestCase sets <code>ProtoV5ProviderFactories: acctest.ProtoV5ProviderBetaFactories(t)</code></li><li>In each beta-only test, ensure that all Terraform resources in all configs have <code>provider = google-beta</code> set</li></ul></li></ul></li></ol></div><input type=radio class=toggle name=tabs-update id=tabs-update-1>
<label for=tabs-update-1>Handwritten</label><div class="book-tabs-content markdown-inner"><ol><li>Using an editor of your choice, open the existing <code>*_test.go</code> or <code>*_test.go.tmpl</code> file in the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> which contains your create tests.</li><li>Copy the <code>TestAcc*</code> <em>test function</em> for the existing &ldquo;full&rdquo; test. If there is no &ldquo;full&rdquo; test, use the &ldquo;basic&rdquo; test. This will be the starting point for your new update test.</li><li>Modify the test function to support updates.<ul><li>Change the suffix of the test function to <code>_update</code>.</li><li>Copy the 2 <code>TestStep</code> blocks and paste them immediately after, so that there are 4 total test steps.</li><li>Change the suffix of the second <code>Config</code> value to <code>_update</code>.</li><li>Add <code>ConfigPlanChecks</code> to the update step of the test to ensure the resource is updated in-place.</li><li>The resulting test function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestAccPubsubTopic_update</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>acctest</span>.<span style=color:#a6e22e>VcrTest</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>TestCase</span>{
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Steps</span>: []<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>TestStep</span>{
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Config</span>: <span style=color:#a6e22e>testAccPubsubTopic_full</span>(<span style=color:#f92672>...</span>),
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Config</span>: <span style=color:#a6e22e>testAccPubsubTopic_update</span>(<span style=color:#f92672>...</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ConfigPlanChecks</span>: <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>ConfigPlanChecks</span>{
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>PreApply</span>: []<span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>PlanCheck</span>{
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>ExpectResourceAction</span>(<span style=color:#e6db74>&#34;google_pubsub_topic.foo&#34;</span>, <span style=color:#a6e22e>plancheck</span>.<span style=color:#a6e22e>ResourceActionUpdate</span>),
</span></span><span style=display:flex><span>               },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Add a Terraform <em>template function</em> to support updates.<ul><li>Copy the full (or basic) <code>testAcc*</code> template function.</li><li>Change the suffix of the new template function to <code>_update</code>.</li><li>The new template function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>testAccPubsubTopic_update</span>(<span style=color:#f92672>...</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li>Modify the test as needed.<ul><li>Modify the new template function so that updatable fields are changed or removed. This may require additions to the <code>context</code> map in the test function.</li><li>Remove the comments at the top of the file.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li><li>In each beta-only test, ensure that the TestCase sets <code>ProtoV5ProviderFactories: acctest.ProtoV5ProviderBetaFactories(t)</code></li><li>In each beta-only test, ensure that all Terraform resources in all configs have <code>provider = google-beta</code> set</li></ul></li></ul></li></ol></div></div><h2 id=add-unit-tests>Add unit tests
<a class=anchor href=#add-unit-tests>#</a></h2><p>A unit test verifies functionality that is not related to interactions with the API, such as
<a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#diff_suppress_func>diff suppress functions</a>,
<a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#validation>validation functions</a>,
CustomizeDiff functions, and so on.</p><p>Unit tests should be added to the appropriate folder in <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> in the file called <code>resource_PRODUCT_RESOURCE_test.go</code>. (You may need to create this file if it does not already exist. Replace PRODUCT with the product name and RESOURCE with the resource name; it should match the name of the generated resource file.)</p><p>Unit tests should be named like <code>TestFunctionName</code> - for example, <code>TestDiskImageDiffSuppress</code> would contain tests for the <code>DiskImageDiffSuppress</code> function.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestSignatureAlgorithmDiffSuppress</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>cases</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Old</span>, <span style=color:#a6e22e>New</span>           <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpectDiffSuppress</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>   }{
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;ECDSA_P256 equivalent&#34;</span>: {
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>Old</span>:                <span style=color:#e6db74>&#34;ECDSA_P256_SHA256&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>New</span>:                <span style=color:#e6db74>&#34;EC_SIGN_P256_SHA256&#34;</span>,
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>ExpectDiffSuppress</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Additional cases excluded for brevity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>tn</span>, <span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cases</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>signatureAlgorithmDiffSuppress</span>(<span style=color:#e6db74>&#34;signature_algorithm&#34;</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>Old</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>New</span>, <span style=color:#66d9ef>nil</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>ExpectDiffSuppress</span> {
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;bad: %s, %q =&gt; %q expect DiffSuppress to return %t&#34;</span>, <span style=color:#a6e22e>tn</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>Old</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>New</span>, <span style=color:#a6e22e>tc</span>.<span style=color:#a6e22e>ExpectDiffSuppress</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=skip-vcr>Skip tests in VCR replaying mode
<a class=anchor href=#skip-vcr>#</a></h2><p>Acceptance tests are run in VCR replaying mode on PRs (using pre-recorded HTTP requests and responses) to reduce the time it takes to present results to contributors. However, not all resources or tests are possible to run in replaying mode. Incompatible tests should be skipped during VCR replaying mode. They will still run in our nightly test suite.</p><div class=book-tabs><input type=radio class=toggle name=tabs-skipping-tests-in-vcr-replaying id=tabs-skipping-tests-in-vcr-replaying-0 checked>
<label for=tabs-skipping-tests-in-vcr-replaying-0>Skip a generated test</label><div class="book-tabs-content markdown-inner"><p>Skipping acceptance tests that are generated from example files can be achieved by adding <code>skip_vcr: true</code> in the example&rsquo;s YAML:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>examples</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;bigtable_app_profile_anycluster&#39;</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># bigtable instance does not use the shared HTTP client, this test creates an instance</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>skip_vcr</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>If you skip a test in VCR mode, include a code comment explaining the reason for skipping (for example, a link to a GitHub issue.)</p></div><input type=radio class=toggle name=tabs-skipping-tests-in-vcr-replaying id=tabs-skipping-tests-in-vcr-replaying-1>
<label for=tabs-skipping-tests-in-vcr-replaying-1>Skip a handwritten test</label><div class="book-tabs-content markdown-inner"><p>Skipping acceptance tests that are handwritten can be achieved by adding <code>acctest.SkipIfVcr(t)</code> at the start of the test:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestAccPubsubTopic_update</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>acctest</span>.<span style=color:#a6e22e>SkipIfVcr</span>(<span style=color:#a6e22e>t</span>) <span style=color:#75715e>// See: https://github.com/hashicorp/terraform-provider-google/issues/9999
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>acctest</span>.<span style=color:#a6e22e>VcrTest</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>TestCase</span>{ <span style=color:#f92672>...</span> }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you skip a test in VCR mode, include a code comment explaining the reason for skipping (for example, a link to a GitHub issue.)</p></div></div><h3 id=reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode
<a class=anchor href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>#</a></h3><table><thead><tr><th>Problem</th><th>How to fix/Other info</th><th>Skip in VCR replaying?</th></tr></thead><tbody><tr><td><em>Incorrect or insufficient data is present in VCR recordings to replay tests</em>. Tests will fail with <code>Requested interaction not found</code> errors during REPLAYING mode</td><td>Make sure that you&rsquo;re not introducing randomness into the test, e.g. by unnecessarily using the random provider to set a resource&rsquo;s name.</td><td>If you cannot avoid this issue you should skip the test, but try to ensure that it cannot be fixed first.</td></tr><tr><td><em>Bigtable acceptance tests aren&rsquo;t working in VCR mode</em>. <code>Requested interaction not found</code> errors are seen during Bigtable tests run in REPLAYING mode</td><td>Currently the provider uses a separate client than the rest of the provider to interact with the Bigtable API. As HTTP traffic to the Bigtable API doesn&rsquo;t go via the shared client it cannot be recorded in RECORDING mode.</td><td>Skip the test in VCR for Bigtable.</td></tr><tr><td><em>Using multiple provider aliases doesn&rsquo;t work in VCR</em>. You may have two instances of the google provider in the test config but one of them doesn&rsquo;t seem to be using its provider arguments - for example, using the wrong default project.</td><td>See this GitHub issue: <a href=https://github.com/hashicorp/terraform-provider-google/issues/20019>https://github.com/hashicorp/terraform-provider-google/issues/20019</a> . The problem is that, due to how the VCR system works, one provider instance will be configured and the other will be forced to reuse the first instance&rsquo;s configuration, despite them being given different provider arguments.</td><td>Skip the test in VCR is using aliases is unavoidable.</td></tr><tr><td><em>Using multiple versions of the google/google-beta provider in a single test isn&rsquo;t working in VCR</em>. Unexpected test failures may occur during tests in REPLAYING mode where <code>ExternalProviders</code> is used to pull in past versions of the google/google-beta provider.</td><td>When ExternalProviders is used to pulling in other versions of the provider, any HTTP traffic through the external provider will not be recorded. If the HTTP traffic produces an unexpected result or returns an API error then the test will fail in REPLAYING mode.</td><td>Skip the test in VCR when testing the current provider behaviour versus previous released versions.</td></tr></tbody></table><p>Some additional things to bear in mind are that VCR tests in REPLAYING mode will still interact with GCP APIs somewhat. For example:</p><ul><li>When the provider is configured it will use credentials to obtain access tokens from GCP</li><li>Some acceptance tests use bootstrapping functions that ensure long-lived resources are present in a testing project before the provider is tested.</li></ul><p>These tests can still run in VCR replaying mode; however, REPLAYING mode can&rsquo;t be used as a way to completely avoid HTTP traffic generally or with GCP APIs.</p><h2 id=whats-next>What&rsquo;s next?
<a class=anchor href=#whats-next>#</a></h2><p><a href=https://googlecloudplatform.github.io/magic-modules/test/run-tests/>Run your tests</a></p><h2 id=references>References
<a class=anchor href=#references>#</a></h2><ul><li><a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/testing/acceptance-tests>Official Terraform documentation on Acceptance Tests</a></li><li><a href=https://googlecloudplatform.github.io/magic-modules/reference/resource/#examples>MMv1 resource reference: <code>examples</code> ↗</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/1a0143d25cabb2907e7b90ba4d0168853e77a8ef title='Last modified by Riley Karson | January 22, 2025' target=_blank rel=noopener><img src=/magic-modules/svg/calendar.svg class=book-icon alt=Calendar>
<span>January 22, 2025</span></a></div><div><a class="flex align-center" href="https://github.com/hashicorp/terraform-provider-google/issues/new?assignees=&labels=technical-debt,documentation&projects=&title=MM%20docsite%20issue%20in%20content/test%2ftest.md&template=11_developer_productivity.md" target=_blank rel=noopener><img src=/magic-modules/report.svg class=book-icon alt=Edit>
<span>Report documentation issue</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/test/test.md target=_blank rel=noopener><img src=/magic-modules/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before you begin</a></li><li><a href=#add-a-create-test>Add a create test</a></li><li><a href=#add-an-update-test>Add an update test</a></li><li><a href=#add-unit-tests>Add unit tests</a></li><li><a href=#skip-vcr>Skip tests in VCR replaying mode</a><ul><li><a href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode</a></li></ul></li><li><a href=#whats-next>What&rsquo;s next?</a></li><li><a href=#references>References</a></li></ul></nav></div></aside></main></body></html>