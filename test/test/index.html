<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Add resource tests#
This page describes how to add tests to a new resource in the google or google-beta Terraform provider.
The providers have two basic types of tests:

Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs.
Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider&rsquo;s behavior in constructing the API requests and parsing the responses.

Acceptance tests are also called &ldquo;VCR tests&rdquo; because they use go-vcr to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don&rsquo;t actually need to be created, updated, or destroyed by the live API."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/test/test/"><meta property="og:site_name" content="Magic Modules"><meta property="og:title" content="Add resource tests"><meta property="og:description" content="Add resource tests# This page describes how to add tests to a new resource in the google or google-beta Terraform provider.
The providers have two basic types of tests:
Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs. Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider’s behavior in constructing the API requests and parsing the responses. Acceptance tests are also called “VCR tests” because they use go-vcr to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don’t actually need to be created, updated, or destroyed by the live API."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="test"><meta property="article:modified_time" content="2025-09-29T18:41:20+02:00"><title>Add resource tests | Magic Modules</title><link rel=icon href=/magic-modules/favicon.png><link rel=manifest href=/magic-modules/manifest.json><link rel=canonical href=https://googlecloudplatform.github.io/magic-modules/test/test/><link rel=stylesheet href=/magic-modules/book.min.34f6ea145e56d87823abe9f451d0a8fbe3dbcc6f9e02412199a014611b7adf70.css integrity="sha256-NPbqFF5W2Hgjq+n0UdCo++PbzG+eAkEhmaAUYRt633A=" crossorigin=anonymous><script defer src=/magic-modules/fuse.min.js></script><script defer src=/magic-modules/en.search.min.5c9b471d5792a5c3ec3ddc087e73fd5ee39205013f098498d12b8527c2f72f6c.js integrity="sha256-XJtHHVeSpcPsPdwIfnP9XuOSBQE/CYSY0SuFJ8L3L2w=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-test"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/magic-modules/ title=Overview>Overview</a></li></ul><ul><li><a href=/magic-modules/contribution-process/>Contribution process</a></li><li><input type=checkbox id=section-1218d39abefe7f824522d24e615b6429 class=toggle>
<label for=section-1218d39abefe7f824522d24e615b6429 class=flex><a role=button>Develop</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/develop/set-up-dev-environment/>Set up your development environment</a></li><li><a href=/magic-modules/develop/add-resource/>Add a resource</a></li><li><a href=/magic-modules/develop/add-fields/>Add a field to an existing resource</a></li><li><a href=/magic-modules/develop/add-iam-support/>Add IAM support</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource/>Add a datasource</a></li><li><a href=/magic-modules/develop/custom-code/>Add custom resource code</a></li><li><a href=/magic-modules/develop/promote-to-ga/>Promote to GA</a></li><li><a href=/magic-modules/develop/update-dependencies/>Update dependencies</a></li><li><a href=/magic-modules/develop/diffs/>Fix diffs</a></li><li><a href=/magic-modules/develop/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/develop/client-side-fields/>Client-side fields</a></li></ul></li><li><input type=checkbox id=section-46008ee5c4ef0e6f804abf3cfaea6dd0 class=toggle checked>
<label for=section-46008ee5c4ef0e6f804abf3cfaea6dd0 class=flex><a role=button>Test</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/test/test/ class=active>Add resource tests</a></li><li><a href=/magic-modules/test/run-tests/>Run tests</a></li></ul></li><li><input type=checkbox id=section-54e8c97150acf80b182bc188a6e6c492 class=toggle>
<label for=section-54e8c97150acf80b182bc188a6e6c492 class=flex><a role=button>Document</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/document/add-documentation/>Add documentation</a></li><li><a href=/magic-modules/document/handwritten-docs-style-guide/>Handwritten docs style guide</a></li></ul></li><li><input type=checkbox id=section-d11be9eb6f9aad36128162d909d31b29 class=toggle>
<label for=section-d11be9eb6f9aad36128162d909d31b29 class=flex><a role=button>Convert</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/convert/add-new-resource-tgc/>Add TGC conversion</a></li></ul></li><li><input type=checkbox id=section-ca39f9a7961e297a8c04b44ec69dbc58 class=toggle>
<label for=section-ca39f9a7961e297a8c04b44ec69dbc58 class=flex><a role=button>Breaking changes</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/breaking-changes/breaking-changes/>Types of breaking changes</a></li><li><a href=/magic-modules/breaking-changes/make-a-breaking-change/>Make a breaking change</a></li></ul></li><li><input type=checkbox id=section-e42fc06bc1be2cad20d6487ff549c503 class=toggle>
<label for=section-e42fc06bc1be2cad20d6487ff549c503 class=flex><a role=button>Code review</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/code-review/create-pr/>Create a pull request</a></li><li><a href=/magic-modules/code-review/release-notes/>Write release notes</a></li><li><a href=/magic-modules/code-review/review-pr/>Review a pull request</a></li></ul></li><li><input type=checkbox id=section-29607ad0ac6d788001e899a44038a031 class=toggle>
<label for=section-29607ad0ac6d788001e899a44038a031 class=flex><a role=button>Best practices</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/best-practices/immutable-fields/>Immutable fields</a></li><li><a href=/magic-modules/best-practices/deletion-behaviors/>Deletion behaviors</a></li><li><a href=/magic-modules/best-practices/labels-and-annotations/>Labels and annotations</a></li><li><a href=/magic-modules/best-practices/common-resource-patterns/>Common resource patterns</a></li><li><a href=/magic-modules/best-practices/validation/>Validation</a></li></ul></li><li><input type=checkbox id=section-3de530fff78b7e92c59925d632c7e725 class=toggle>
<label for=section-3de530fff78b7e92c59925d632c7e725 class=flex><a role=button>Reference</a>
<img src=/magic-modules/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/magic-modules/reference/resource/>MMv1 resource reference</a></li><li><a href=/magic-modules/reference/field/>MMv1 field reference</a></li><li><a href=/magic-modules/reference/make-commands/>make commands</a></li><li><a href=/magic-modules/reference/metadata/>MMv1 metadata reference</a></li><li><a href=/magic-modules/reference/ruby-go-changes/>Ruby to Go Migration</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/icons/menu.svg class=book-icon alt=Menu></label><h3>Add resource tests</h3><label for=toc-control><img src=/magic-modules/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before you begin</a></li><li><a href=#add-unit-tests>Add unit tests</a></li><li><a href=#add-a-create-test>Add a create test</a></li><li><a href=#add-an-update-test>Add an update test</a></li><li><a href=#bootstrapping>Bootstrap API resources</a><ul><li><a href=#cryptokeys>CryptoKeys</a></li><li><a href=#iam-resources>IAM resources</a></li><li><a href=#networks>Networks</a></li></ul></li><li><a href=#create-test-projects>Create test projects</a></li><li><a href=#skip-vcr>Skip tests in VCR replaying mode</a><ul><li><a href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode</a></li></ul></li><li><a href=#whats-next>What&rsquo;s next?</a></li><li><a href=#references>References</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=add-resource-tests>Add resource tests<a class=anchor href=#add-resource-tests>#</a></h1><p>This page describes how to add tests to a new resource in the <code>google</code> or <code>google-beta</code> Terraform provider.</p><p>The providers have two basic types of tests:</p><ul><li>Unit tests: test specific functions thoroughly. Unit tests do not interact with GCP APIs.</li><li>Acceptance tests (aka VCR tests, or create and update tests): test that resources interact as expected with the APIs. Acceptance tests interact with GCP APIs, but should only test the provider&rsquo;s behavior in constructing the API requests and parsing the responses.</li></ul><p>Acceptance tests are also called &ldquo;VCR tests&rdquo; because they use <a href=https://github.com/dnaeon/go-vcr><code>go-vcr</code></a> to record and play back HTTP requests. This allows tests to run more quickly on PRs because the resources don&rsquo;t actually need to be created, updated, or destroyed by the live API.</p><p>For more information about testing, see the <a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/testing/acceptance-tests>official Terraform documentation</a>.</p><h2 id=before-you-begin>Before you begin<a class=anchor href=#before-you-begin>#</a></h2><ol><li>Determine whether your resources is using <a href=https://googlecloudplatform.github.io/magic-modules/>MMv1 generation or handwritten</a>.</li><li>If you are not adding tests to an in-progress PR, ensure that your <code>magic-modules</code>, <code>terraform-provider-google</code>, and <code>terraform-provider-google-beta</code> repositories are up to date.<div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff5c57>cd</span> ~/magic-modules
</span></span><span style=display:flex><span>git checkout main <span style=color:#ff6ac1>&amp;&amp;</span> git clean -f . <span style=color:#ff6ac1>&amp;&amp;</span> git checkout -- . <span style=color:#ff6ac1>&amp;&amp;</span> git pull
</span></span><span style=display:flex><span><span style=color:#ff5c57>cd</span> <span style=color:#ff5c57>$GOPATH</span>/src/github.com/hashicorp/terraform-provider-google
</span></span><span style=display:flex><span>git checkout main <span style=color:#ff6ac1>&amp;&amp;</span> git clean -f . <span style=color:#ff6ac1>&amp;&amp;</span> git checkout -- . <span style=color:#ff6ac1>&amp;&amp;</span> git pull
</span></span><span style=display:flex><span><span style=color:#ff5c57>cd</span> <span style=color:#ff5c57>$GOPATH</span>/src/github.com/hashicorp/terraform-provider-google-beta
</span></span><span style=display:flex><span>git checkout main <span style=color:#ff6ac1>&amp;&amp;</span> git clean -f . <span style=color:#ff6ac1>&amp;&amp;</span> git checkout -- . <span style=color:#ff6ac1>&amp;&amp;</span> git pull</span></span></code></pre></div></li></ol><h2 id=add-unit-tests>Add unit tests<a class=anchor href=#add-unit-tests>#</a></h2><p>A unit test verifies functionality that is not related to interactions with the API, such as
<a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#diff_suppress_func>diff suppress functions</a>,
<a href=https://googlecloudplatform.github.io/magic-modules/reference/field/#validation>validation functions</a>,
CustomizeDiff functions, and so on.</p><p>Unit tests should be added to the appropriate folder in <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> in the file called <code>resource_PRODUCT_RESOURCE_test.go</code>. (You may need to create this file if it does not already exist. Replace PRODUCT with the product name and RESOURCE with the resource name; it should match the name of the generated resource file.)</p><p>Unit tests should be named like <code>TestFunctionName</code> - for example, <code>TestDiskImageDiffSuppress</code> would contain tests for the <code>DiskImageDiffSuppress</code> function.</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestSignatureAlgorithmDiffSuppress</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>   cases <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>      Old, New           <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>      ExpectDiffSuppress <span style=color:#9aedfe>bool</span>
</span></span><span style=display:flex><span>   }{
</span></span><span style=display:flex><span>      <span style=color:#5af78e>&#34;ECDSA_P256 equivalent&#34;</span>: {
</span></span><span style=display:flex><span>         Old:                <span style=color:#5af78e>&#34;ECDSA_P256_SHA256&#34;</span>,
</span></span><span style=display:flex><span>         New:                <span style=color:#5af78e>&#34;EC_SIGN_P256_SHA256&#34;</span>,
</span></span><span style=display:flex><span>         ExpectDiffSuppress: <span style=color:#ff6ac1>true</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#78787e>// Additional cases excluded for brevity</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#ff6ac1>for</span> tn, tc <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> cases {
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>if</span> <span style=color:#57c7ff>signatureAlgorithmDiffSuppress</span>(<span style=color:#5af78e>&#34;signature_algorithm&#34;</span>, tc.Old, tc.New, <span style=color:#ff6ac1>nil</span>) <span style=color:#ff6ac1>!=</span> tc.ExpectDiffSuppress {
</span></span><span style=display:flex><span>         t.<span style=color:#57c7ff>Errorf</span>(<span style=color:#5af78e>&#34;bad: %s, %q =&gt; %q expect DiffSuppress to return %t&#34;</span>, tn, tc.Old, tc.New, tc.ExpectDiffSuppress)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=add-a-create-test>Add a create test<a class=anchor href=#add-a-create-test>#</a></h2><p>A create test is an <strong>acceptance test</strong> that creates the target resource and immediately destroys it.</p><blockquote class=book-hint><p><strong>Note:</strong> All resources should have a &ldquo;basic&rdquo; create test, which uses the smallest possible number of fields. Additional create tests can be used to ensure all fields on the resource are used in at least one test.</p></blockquote><div class=book-tabs><input type=radio class=toggle name=tabs-create id=tabs-create-0 checked><label for=tabs-create-0>MMv1</label><div class="book-tabs-content markdown-inner"><ol><li><p>Add an entry to your <code>RESOURCE_NAME.yaml</code> file&rsquo;s <code>examples</code>. The fields listed here are the most commonly-used. For a comprehensive reference, see <a href=https://googlecloudplatform.github.io/magic-modules/reference/resource/#examples>MMv1 resource reference: <code>examples</code> ↗</a>.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>  <span style=color:#78787e># name must correspond to a configuration file that you&#39;ll create in the next step.</span>
</span></span><span style=display:flex><span>  <span style=color:#78787e># The name should include the product name, resource name, and a basic description</span>
</span></span><span style=display:flex><span>  <span style=color:#78787e># of the test. This will be used to generate the test name and the documentation</span>
</span></span><span style=display:flex><span>  <span style=color:#78787e># header.</span>
</span></span><span style=display:flex><span>  - <span style=color:#ff6ac1>name</span>: <span style=color:#5af78e>&#34;PRODUCT_RESOURCE_basic&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># primary_resource_id will be used for the Terraform resource id in the configuration file.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>primary_resource_id</span>: <span style=color:#5af78e>&#34;example&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># vars contains key/value pairs of variables to inject into the configuration file.</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># These can be referenced in the configuration file as a key inside `{{$.Vars}}`.</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># All resource IDs (even for resources not under test) should be declared</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># with variables that contain a `-` or `_`; this will ensure that, in tests,</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># the resources are created with a `tf-test` prefix to allow automatic cleanup</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># of dangling resources and a random suffix to avoid name collisions.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>vars</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>network_name</span>: <span style=color:#5af78e>&#34;example-network&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># test_vars_overrides contains key/value pairs of literal overrides for</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># variables used in tests. This can be used to call functions to</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># generate or determine a variable&#39;s value – for example, bootstrapping</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># a shared network for your product to avoid test failures due to limits</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># on the default network.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>test_vars_overrides</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>network_name</span>: <span style=color:#5af78e>&#39;acctest.BootstrapSharedServiceNetworkingConnection(t, &#34;PRODUCT-RESOURCE-network-config&#34;)&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e># Set min_version: beta if the resource is not beta-only and any beta-only fields are being tested.</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>min_version</span>: beta</span></span></code></pre></div></li><li><p>Create a <code>.tf.tmpl</code> file in <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/templates/terraform/examples><code>mmv1/templates/terraform/examples/</code></a>. The name of the file should match the name of the example created in the previous step. For example, <code>PRODUCT_RESOURCE_basic.tf.tmpl</code>.</p></li><li><p>In that file, write the Terraform configuration for your test. This should include all of the required dependencies. For example, <code>google_compute_subnetwork</code> has a dependency on <code>google_compute_network</code>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#ff6ac1>resource</span> <span style=color:#5af78e>&#34;google_compute_subnetwork&#34;</span> <span style=color:#5af78e>&#34;{{</span><span style=color:#ff5c57>$</span><span style=color:#5af78e>.PrimaryResourceId}}&#34;</span> {
</span></span><span style=display:flex><span>  name          <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;{{index </span><span style=color:#ff5c57>$</span><span style=color:#5af78e>.Vars &#34;</span>subnetwork_name<span style=color:#5af78e>&#34;}}&#34;</span>
</span></span><span style=display:flex><span>  ip_cidr_range <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;10.1.0.0/16&#34;</span>
</span></span><span style=display:flex><span>  region        <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;us-central1&#34;</span>
</span></span><span style=display:flex><span>  network       <span style=color:#ff6ac1>=</span> google_compute_network.network.name
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>resource</span> <span style=color:#5af78e>&#34;google_compute_network&#34;</span> <span style=color:#5af78e>&#34;network&#34;</span> {
</span></span><span style=display:flex><span>  name                    <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;{{index </span><span style=color:#ff5c57>$</span><span style=color:#5af78e>.Vars &#34;</span>network_name<span style=color:#5af78e>&#34;}}&#34;</span>
</span></span><span style=display:flex><span>  auto_create_subnetworks <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>false</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></li><li><p>If the resource or the example is beta-only:</p><ul><li>Add <code>provider = google-beta</code> to every resource in the file.</li></ul></li></ol></div><input type=radio class=toggle name=tabs-create id=tabs-create-1><label for=tabs-create-1>Handwritten</label><div class="book-tabs-content markdown-inner"><p>This section assumes you&rsquo;ve used the <a href=https://googlecloudplatform.github.io/magic-modules/develop/add-resource/>Add a resource</a> guide to create your handwritten resource, and you have a working MMv1 config.</p><blockquote class=book-hint><p><strong>Note:</strong> If not, you can create one now, or skip this guide and construct the test by hand. Writing tests by hand can sometimes be a better option if there is a similar test you can copy from.</p></blockquote><ol><li>Add the test in MMv1. Repeat for all the create tests you will need.</li><li><a href=https://googlecloudplatform.github.io/magic-modules/develop/generate-providers/>Generate the beta provider</a>.</li><li>From the beta provider, copy and paste the generated <code>*_generated_test.go</code> file into the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services/><code>magic-modules/mmv1/third_party/terraform/services</code></a> as a new file call <code>*_test.go</code>.</li><li>Modify the tests as needed.<ul><li>Replace all occurrences of <code>github.com/hashicorp/terraform-provider-google-beta/google-beta</code> with <code>github.com/hashicorp/terraform-provider-google/google</code></li><li>Remove the comments at the top of the file.</li><li>Remove the <code>Example</code> suffix from all function names.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li><li>In each beta-only test, ensure that the TestCase sets <code>ProtoV5ProviderFactories: acctest.ProtoV5ProviderBetaFactories(t)</code></li><li>In each beta-only test, ensure that all Terraform resources in all configs have <code>provider = google-beta</code> set</li></ul></li></ul></li></ol></div></div><h2 id=add-an-update-test>Add an update test<a class=anchor href=#add-an-update-test>#</a></h2><p>An update test is an <strong>acceptance test</strong> that creates the target resource and then makes updates to fields that are updatable. Updatable fields are fields that can be updated without recreating the entire resource; that is, they are not marked <code>immutable</code> in MMv1 or <code>ForceNew</code> in handwritten code.</p><blockquote class=book-hint><p><strong>Note:</strong> All updatable fields must be covered by at least one update test. In most cases, only a single update test is needed to test all fields at once.</p></blockquote><div class=book-tabs><input type=radio class=toggle name=tabs-update id=tabs-update-0 checked><label for=tabs-update-0>MMv1</label><div class="book-tabs-content markdown-inner"><ol><li><a href=https://googlecloudplatform.github.io/magic-modules/develop/generate-providers/>Generate the beta provider</a>.</li><li>From the beta provider, copy and paste the generated <code>*_generated_test.go</code> file into the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> as a new file call <code>*_test.go</code>.</li><li>Using an editor of your choice, delete the <code>*DestroyProducer</code> function, and all but one test. The remaining test should be the &ldquo;full&rdquo; test, or if there is no &ldquo;full&rdquo; test, the &ldquo;basic&rdquo; test. This will be the starting point for your new update test.</li><li>Modify the <code>TestAcc*</code> <em>test function</em> to support updates.<ul><li>Change the suffix of the test function to <code>_update</code>.</li><li>Copy the 2 <code>TestStep</code> blocks and paste them immediately after, so that there are 4 total test steps.</li><li>Change the suffix of the first <code>Config</code> value to <code>_full</code> (or <code>_basic</code>).</li><li>Change the suffix of the second <code>Config</code> value to <code>_update</code>.</li><li>Add <code>ConfigPlanChecks</code> to the update step of the test to ensure the resource is updated in-place.</li><li>The resulting test function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff6ac1>import</span> <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-plugin-testing/plancheck&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccPubsubTopic_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>   <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>   acctest.<span style=color:#57c7ff>VcrTest</span>(t, resource.TestCase{
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>      Steps: []resource.TestStep{
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            Config: <span style=color:#57c7ff>testAccPubsubTopic_full</span>(<span style=color:#ff6ac1>...</span>),
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            Config: <span style=color:#57c7ff>testAccPubsubTopic_update</span>(<span style=color:#ff6ac1>...</span>),
</span></span><span style=display:flex><span>            ConfigPlanChecks: resource.ConfigPlanChecks{
</span></span><span style=display:flex><span>               PreApply: []plancheck.PlanCheck{
</span></span><span style=display:flex><span>                  plancheck.<span style=color:#57c7ff>ExpectResourceAction</span>(<span style=color:#5af78e>&#34;google_pubsub_topic.foo&#34;</span>, plancheck.ResourceActionUpdate),
</span></span><span style=display:flex><span>               },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>}</span></span></code></pre></div></li><li>Modify the <code>testAcc*</code> Terraform <em>template function</em> to support updates.<ul><li>Copy the template function and paste it immediately after so that there are 2 template functions.</li><li>Change the suffix of the first template function to <code>_full</code> (or <code>_basic</code>).</li><li>Change the suffix of the second template function to <code>_update</code>.</li><li>The resulting template functions would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>testAccPubsubTopic_full</span>(<span style=color:#ff6ac1>...</span>) <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>testAccPubsubTopic_update</span>(<span style=color:#ff6ac1>...</span>) <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></li><li>Modify the test as needed.<ul><li>Replace all occurrences of <code>github.com/hashicorp/terraform-provider-google-beta/google-beta</code> with <code>github.com/hashicorp/terraform-provider-google/google</code></li><li>Modify the template function ending in <code>_update</code> so that updatable fields are changed or removed. This may require additions to the <code>context</code> map in the test function.</li><li>Remove the comments at the top of the file.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li><li>In each beta-only test, ensure that the TestCase sets <code>ProtoV5ProviderFactories: acctest.ProtoV5ProviderBetaFactories(t)</code></li><li>In each beta-only test, ensure that all Terraform resources in all configs have <code>provider = google-beta</code> set</li></ul></li></ul></li></ol></div><input type=radio class=toggle name=tabs-update id=tabs-update-1><label for=tabs-update-1>Handwritten</label><div class="book-tabs-content markdown-inner"><ol><li>Using an editor of your choice, open the existing <code>*_test.go</code> or <code>*_test.go.tmpl</code> file in the appropriate service folder inside <a href=https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services><code>magic-modules/mmv1/third_party/terraform/services</code></a> which contains your create tests.</li><li>Copy the <code>TestAcc*</code> <em>test function</em> for the existing &ldquo;full&rdquo; test. If there is no &ldquo;full&rdquo; test, use the &ldquo;basic&rdquo; test. This will be the starting point for your new update test.</li><li>Modify the test function to support updates.<ul><li>Change the suffix of the test function to <code>_update</code>.</li><li>Copy the 2 <code>TestStep</code> blocks and paste them immediately after, so that there are 4 total test steps.</li><li>Change the suffix of the second <code>Config</code> value to <code>_update</code>.</li><li>Add <code>ConfigPlanChecks</code> to the update step of the test to ensure the resource is updated in-place.</li><li>The resulting test function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff6ac1>import</span> <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-plugin-testing/plancheck&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccPubsubTopic_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>   <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>   acctest.<span style=color:#57c7ff>VcrTest</span>(t, resource.TestCase{
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>      Steps: []resource.TestStep{
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            Config: <span style=color:#57c7ff>testAccPubsubTopic_full</span>(<span style=color:#ff6ac1>...</span>),
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            Config: <span style=color:#57c7ff>testAccPubsubTopic_update</span>(<span style=color:#ff6ac1>...</span>),
</span></span><span style=display:flex><span>            ConfigPlanChecks: resource.ConfigPlanChecks{
</span></span><span style=display:flex><span>               PreApply: []plancheck.PlanCheck{
</span></span><span style=display:flex><span>                  plancheck.<span style=color:#57c7ff>ExpectResourceAction</span>(<span style=color:#5af78e>&#34;google_pubsub_topic.foo&#34;</span>, plancheck.ResourceActionUpdate),
</span></span><span style=display:flex><span>               },
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>         {
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>         },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>   })
</span></span><span style=display:flex><span>}</span></span></code></pre></div></li><li>Add a Terraform <em>template function</em> to support updates.<ul><li>Copy the full (or basic) <code>testAcc*</code> template function.</li><li>Change the suffix of the new template function to <code>_update</code>.</li><li>The new template function would look similar to this:</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>testAccPubsubTopic_update</span>(<span style=color:#ff6ac1>...</span>) <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></li><li>Modify the test as needed.<ul><li>Modify the new template function so that updatable fields are changed or removed. This may require additions to the <code>context</code> map in the test function.</li><li>Remove the comments at the top of the file.</li><li>If beta-only fields are being tested, do the following:<ul><li>Change the file suffix to <code>.go.tmpl</code></li><li>Wrap each beta-only test in a separate version guard: <code>{{- if ne $.TargetVersionName "ga" -}}...{{- else }}...{{- end }}</code></li><li>In each beta-only test, ensure that the TestCase sets <code>ProtoV5ProviderFactories: acctest.ProtoV5ProviderBetaFactories(t)</code></li><li>In each beta-only test, ensure that all Terraform resources in all configs have <code>provider = google-beta</code> set</li></ul></li></ul></li></ol></div></div><h2 id=bootstrapping>Bootstrap API resources<a class=anchor href=#bootstrapping>#</a></h2><p>Most acceptance tests run in a the default org and default test project, which means that they can conflict for quota, resource namespaces, and control over shared resources. You can work around these limitations with &ldquo;bootstrapped&rdquo; resources.</p><h3 id=cryptokeys>CryptoKeys<a class=anchor href=#cryptokeys>#</a></h3><p>There are a few functions provided for bootstrapping CryptoKeys, depending on your needs.</p><ul><li><code>BootstrapKMSKeyWithPurposeInLocationAndName(t *testing.T, purpose, locationID, keyShortName string)</code></li><li><code>BootstrapKMSKeyWithPurposeInLocation(t *testing.T, purpose, locationID string)</code><ul><li>Uses a default key name based on the purpose.</li></ul></li><li><code>BootstrapKMSKeyWithPurpose(t *testing.T, purpose string)</code><ul><li>Uses <code>global</code> location and a key name based on the purpose.</li></ul></li><li><code>BootstrapKMSKeyInLocation(t *testing.T, locationID string)</code><ul><li>Uses <code>ENCRYPT_DECRYPT</code> for the purpose and the corresponding key name.</li></ul></li><li><code>BootstrapKMSKey(t *testing.T)</code><ul><li>Uses <code>global</code> location, <code>ENCRYPT_DECRYPT</code> for the purpose, and the corresponding key name for that purpose.</li></ul></li></ul><p>Example usage:</p><div class=book-tabs><input type=radio class=toggle name=tabs-bootstrap-cryptokeys id=tabs-bootstrap-cryptokeys-0 checked><label for=tabs-bootstrap-cryptokeys-0>MMv1</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff6ac1>name</span>: service_resource_basic
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>primary_resource_id</span>: example
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>vars</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>kms_key_name</span>: <span style=color:#5af78e>&#39;kms-key&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>test_vars_overrides</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>kms_key_name</span>: <span style=color:#5af78e>&#39;acctest.BootstrapKMSKey(t).CryptoKey.Name&#39;</span></span></span></code></pre></div></div><input type=radio class=toggle name=tabs-bootstrap-cryptokeys id=tabs-bootstrap-cryptokeys-1><label for=tabs-bootstrap-cryptokeys-1>Handwritten</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccProductResource_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>   t.<span style=color:#57c7ff>Parallel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   context <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}{
</span></span><span style=display:flex><span>      <span style=color:#5af78e>&#34;kms&#34;</span>: acctest.<span style=color:#57c7ff>BootstrapKMSKey</span>(t).CryptoKey.Name,
</span></span><span style=display:flex><span>      <span style=color:#78787e>// other variables</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#78787e>// rest of test</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><h3 id=iam-resources>IAM resources<a class=anchor href=#iam-resources>#</a></h3><p>Specify member/role pairs that should always exist. <code>{project_number}</code> will be replaced with the default project&rsquo;s project number. <code>{organization_id}</code> will be replaced with the &ldquo;target&rdquo; test organization&rsquo;s ID – we don&rsquo;t modify IAM in the main test org to avoid accidentally locking ourselves out.</p><p>Permissions attached to resources created <em>in</em> a test should instead be provisioned with standard terraform resources.</p><p>Example usage:</p><div class=book-tabs><input type=radio class=toggle name=tabs-bootstrap-iam id=tabs-bootstrap-iam-0 checked><label for=tabs-bootstrap-iam-0>MMv1</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#78787e># Project-level IAM</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff6ac1>name</span>: service_resource_basic
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>primary_resource_id</span>: example
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>bootstrap_iam</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff6ac1>member</span>: <span style=color:#5af78e>&#34;serviceAccount:service-{project_number}@gcp-sa-healthcare.iam.gserviceaccount.com&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>role</span>: <span style=color:#5af78e>&#34;roles/bigquery.dataEditor&#34;</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#78787e># Org-level IAM</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff6ac1>name</span>: service_resource_basic
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>primary_resource_id</span>: example
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>bootstrap_iam</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff6ac1>member</span>: <span style=color:#5af78e>&#34;serviceAccount:service-org-{organization_id}@gcp-sa-osconfig.iam.gserviceaccount.com&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>role</span>: <span style=color:#5af78e>&#34;roles/osconfig.serviceAgent&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>test_env_vars</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>org_id</span>: ORG_TARGET</span></span></code></pre></div></div><input type=radio class=toggle name=tabs-bootstrap-iam id=tabs-bootstrap-iam-1><label for=tabs-bootstrap-iam-1>Handwritten</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// Project-level IAM</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-provider-google-beta/google-beta/acctest&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccProductResource_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>    t.<span style=color:#57c7ff>Parallel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    acctest.<span style=color:#57c7ff>BootstrapIamMembers</span>(t, []acctest.IamMember{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Member: <span style=color:#5af78e>&#34;serviceAccount:service-{project_number}@gcp-sa-pubsub.iam.gserviceaccount.com&#34;</span>,
</span></span><span style=display:flex><span>            Role:   <span style=color:#5af78e>&#34;roles/cloudkms.cryptoKeyEncrypterDecrypter&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#78787e>// rest of test</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// Org-level IAM</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-provider-google-beta/google-beta/acctest&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-provider-google-beta/google-beta/envvar&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccProductResource_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>    t.<span style=color:#57c7ff>Parallel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    acctest.<span style=color:#57c7ff>BootstrapIamMembers</span>(t, []acctest.IamMember{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Member: <span style=color:#5af78e>&#34;serviceAccount:service-org-{organization_id}@gcp-sa-osconfig.iam.gserviceaccount.com&#34;</span>,
</span></span><span style=display:flex><span>            Role:   <span style=color:#5af78e>&#34;roles/osconfig.serviceAgent&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    context <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#9aedfe>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#5af78e>&#34;org_id&#34;</span>: envvar.<span style=color:#57c7ff>GetTestOrgTargetFromEnv</span>(t),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#78787e>// rest of test</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><h3 id=networks>Networks<a class=anchor href=#networks>#</a></h3><p>Bootstrapping networks can be useful for two reasons:</p><ol><li>Resources like <code>google_service_networking_connection</code> use a consumer network and create a complementing tenant network which we don&rsquo;t control. These tenant networks never get cleaned up and they can accumulate to the point where a limit is reached for the organization. By reusing a consumer network across test runs, we can reduce the number of tenant networks that are needed. (Googlers: See b/146351146 for more context.)</li><li>Bootstrap networks used in tests (gke clusters, dataproc clusters&mldr;) to limit traffic to the default network (preventing conflicts).</li></ol><p>When creating a bootstrapped network in a test, you can specify an identifier. Note that if the network is being used for a <code>google_service_networking_connection</code>, you should use an identifier unique to the test to avoid race conditions where multiple tests attempt to modify the connection at once.</p><p>You can also bootstrap one or more subnetworks within a bootstrapped network if necessary, to avoid subnetwork-level quotas and race conditions.</p><p>Example usage:</p><div class=book-tabs><input type=radio class=toggle name=tabs-bootstrap-networks id=tabs-bootstrap-networks-0 checked><label for=tabs-bootstrap-networks-0>MMv1</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff6ac1>name</span>: service_resource_basic
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>primary_resource_id</span>: example
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>vars</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>network_name</span>: <span style=color:#5af78e>&#39;default&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>subnetwork_name</span>: <span style=color:#5af78e>&#39;default&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>test_vars_overrides</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>network_name</span>: <span style=color:#5af78e>&#39;acctest.BootstrapSharedTestNetwork(t, &#34;network-identifier&#34;)&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff6ac1>subnetwork_name</span>: <span style=color:#5af78e>&#39;acctest.BootstrapSubnet(t, &#34;subnet-identifier&#34;, acctest.BootstrapSharedTestNetwork(t, &#34;network-identifier&#34;))&#39;</span></span></span></code></pre></div></div><input type=radio class=toggle name=tabs-bootstrap-networks id=tabs-bootstrap-networks-1><label for=tabs-bootstrap-networks-1>Handwritten</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccProductResource_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>   t.<span style=color:#57c7ff>Parallel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   networkName <span style=color:#ff6ac1>:=</span> 
</span></span><span style=display:flex><span>   subnetName <span style=color:#ff6ac1>:=</span> 
</span></span><span style=display:flex><span>   context <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}{
</span></span><span style=display:flex><span>      <span style=color:#5af78e>&#34;network_name&#34;</span>: acctest.<span style=color:#57c7ff>BootstrapSharedTestNetwork</span>(t, <span style=color:#5af78e>&#34;network-identifier&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#5af78e>&#34;subnetwork_name&#34;</span>: acctest.<span style=color:#57c7ff>BootstrapSubnet</span>(t, <span style=color:#5af78e>&#34;subnet-identifier&#34;</span>, acctest.<span style=color:#57c7ff>BootstrapSharedTestNetwork</span>(t, <span style=color:#5af78e>&#34;network-identifier&#34;</span>)),
</span></span><span style=display:flex><span>      <span style=color:#78787e>// other variables</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#78787e>// rest of test</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div><h2 id=create-test-projects>Create test projects<a class=anchor href=#create-test-projects>#</a></h2><p>If <a href=#bootstrapping>bootstrapping</a> doesn&rsquo;t work or isn&rsquo;t an option for some reason, you can also work around project quota issues or test project-global resources by creating a new test project. You will also need to enable any necessary APIs and wait for their enablement to propagate.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff6ac1>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-plugin-testing/helper/resource&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-provider-google-beta/google-beta/acctest&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#5af78e>&#34;github.com/hashicorp/terraform-provider-google-beta/google-beta/envvar&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccProductResourceName_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>	t.<span style=color:#57c7ff>Parallel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	context <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}{
</span></span><span style=display:flex><span>		<span style=color:#5af78e>&#34;random_suffix&#34;</span>:   acctest.<span style=color:#57c7ff>RandString</span>(t, <span style=color:#ff9f43>10</span>),
</span></span><span style=display:flex><span>		<span style=color:#5af78e>&#34;billing_account&#34;</span>: envvar.<span style=color:#57c7ff>GetTestBillingAccountFromEnv</span>(t),
</span></span><span style=display:flex><span>		<span style=color:#5af78e>&#34;org_id&#34;</span>:          envvar.<span style=color:#57c7ff>GetTestOrgFromEnv</span>(t),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  acctest.<span style=color:#57c7ff>VcrTest</span>(t, resource.TestCase{
</span></span><span style=display:flex><span>    <span style=color:#78787e>// ...</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Add ExternalProviders so you can use `time_sleep`</span>
</span></span><span style=display:flex><span>    ExternalProviders: <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]resource.ExternalProvider{
</span></span><span style=display:flex><span>      <span style=color:#5af78e>&#34;time&#34;</span>: {},
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    Steps: []resource.TestStep{
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#57c7ff>testAccProductResourceName_update1</span>(context),
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#78787e>// ...</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>testAccProductResourceName_update1</span>(context <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]<span style=color:#ff5c57>interface</span>{}) <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>return</span> accest.<span style=color:#57c7ff>Nprintf</span>(<span style=color:#5af78e>`
</span></span></span><span style=display:flex><span><span style=color:#5af78e>// Set up a test project
</span></span></span><span style=display:flex><span><span style=color:#5af78e>resource &#34;google_project&#34; &#34;project&#34; {
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  project_id      = &#34;tf-test%{random_suffix}&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  name            = &#34;tf-test%{random_suffix}&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  org_id          = &#34;%{org_id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  billing_account = &#34;%{billing_account}&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  deletion_policy = &#34;DELETE&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>}
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>// Enable APIs in a deterministic order to avoid inconsistent VCR recordings
</span></span></span><span style=display:flex><span><span style=color:#5af78e>resource &#34;google_project_service&#34; &#34;servicenetworking&#34; {
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  project = google_project.project.project_id
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  service = &#34;servicenetworking.googleapis.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>}
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>resource &#34;google_project_service&#34; &#34;compute&#34; {
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  project = google_project.project.project_id
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  service = &#34;compute.googleapis.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  depends_on = [google_project_service.servicenetworking]
</span></span></span><span style=display:flex><span><span style=color:#5af78e>}
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>// wait for API enablement
</span></span></span><span style=display:flex><span><span style=color:#5af78e>resource &#34;time_sleep&#34; &#34;wait_120_seconds&#34; {
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  create_duration = &#34;120s&#34;
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  depends_on = [google_project_service.compute]
</span></span></span><span style=display:flex><span><span style=color:#5af78e>}
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>resource &#34;google_product_resource&#34; &#34;example&#34; {
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  // ...
</span></span></span><span style=display:flex><span><span style=color:#5af78e>  depends_on = [time_sleep.wait_120_seconds]
</span></span></span><span style=display:flex><span><span style=color:#5af78e>}
</span></span></span><span style=display:flex><span><span style=color:#5af78e>
</span></span></span><span style=display:flex><span><span style=color:#5af78e>`</span>, context)
</span></span><span style=display:flex><span>}</span></span></code></pre></div><h2 id=skip-vcr>Skip tests in VCR replaying mode<a class=anchor href=#skip-vcr>#</a></h2><p>Acceptance tests are run in VCR replaying mode on PRs (using pre-recorded HTTP requests and responses) to reduce the time it takes to present results to contributors. However, not all resources or tests are possible to run in replaying mode. Incompatible tests should be skipped during VCR replaying mode. They will still run in our nightly test suite.</p><div class=book-tabs><input type=radio class=toggle name=tabs-skipping-tests-in-vcr-replaying id=tabs-skipping-tests-in-vcr-replaying-0 checked><label for=tabs-skipping-tests-in-vcr-replaying-0>Skip a generated test</label><div class="book-tabs-content markdown-inner"><p>Skipping acceptance tests that are generated from example files can be achieved by adding <code>skip_vcr: true</code> in the example&rsquo;s YAML:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>examples</span>:
</span></span><span style=display:flex><span>- <span style=color:#ff6ac1>name</span>: <span style=color:#5af78e>&#39;bigtable_app_profile_anycluster&#39;</span>
</span></span><span style=display:flex><span>   ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#78787e># bigtable instance does not use the shared HTTP client, this test creates an instance</span>
</span></span><span style=display:flex><span>   <span style=color:#ff6ac1>skip_vcr</span>: <span style=color:#ff6ac1>true</span></span></span></code></pre></div><p>If you skip a test in VCR mode, include a code comment explaining the reason for skipping (for example, a link to a GitHub issue.)</p></div><input type=radio class=toggle name=tabs-skipping-tests-in-vcr-replaying id=tabs-skipping-tests-in-vcr-replaying-1><label for=tabs-skipping-tests-in-vcr-replaying-1>Skip a handwritten test</label><div class="book-tabs-content markdown-inner"><p>Skipping acceptance tests that are handwritten can be achieved by adding <code>acctest.SkipIfVcr(t)</code> at the start of the test:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TestAccPubsubTopic_update</span>(t <span style=color:#ff6ac1>*</span>testing.T) {
</span></span><span style=display:flex><span>      acctest.<span style=color:#57c7ff>SkipIfVcr</span>(t) <span style=color:#78787e>// See: https://github.com/hashicorp/terraform-provider-google/issues/9999</span>
</span></span><span style=display:flex><span>      acctest.<span style=color:#57c7ff>VcrTest</span>(t, resource.TestCase{ <span style=color:#ff6ac1>...</span> })
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>If you skip a test in VCR mode, include a code comment explaining the reason for skipping (for example, a link to a GitHub issue.)</p></div></div><h3 id=reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode<a class=anchor href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>#</a></h3><table><thead><tr><th>Problem</th><th>How to fix/Other info</th><th>Skip in VCR replaying?</th></tr></thead><tbody><tr><td><em>Incorrect or insufficient data is present in VCR recordings to replay tests</em>. Tests will fail with <code>Requested interaction not found</code> errors during REPLAYING mode</td><td>Make sure that you&rsquo;re not introducing randomness into the test, e.g. by unnecessarily using the random provider to set a resource&rsquo;s name.</td><td>If you cannot avoid this issue you should skip the test, but try to ensure that it cannot be fixed first.</td></tr><tr><td><em>Bigtable acceptance tests aren&rsquo;t working in VCR mode</em>. <code>Requested interaction not found</code> errors are seen during Bigtable tests run in REPLAYING mode</td><td>Currently the provider uses a separate client than the rest of the provider to interact with the Bigtable API. As HTTP traffic to the Bigtable API doesn&rsquo;t go via the shared client it cannot be recorded in RECORDING mode.</td><td>Skip the test in VCR for Bigtable.</td></tr><tr><td><em>Using multiple provider aliases doesn&rsquo;t work in VCR</em>. You may have two instances of the google provider in the test config but one of them doesn&rsquo;t seem to be using its provider arguments - for example, using the wrong default project.</td><td>See this GitHub issue: <a href=https://github.com/hashicorp/terraform-provider-google/issues/20019>https://github.com/hashicorp/terraform-provider-google/issues/20019</a> . The problem is that, due to how the VCR system works, one provider instance will be configured and the other will be forced to reuse the first instance&rsquo;s configuration, despite them being given different provider arguments.</td><td>Skip the test in VCR is using aliases is unavoidable.</td></tr><tr><td><em>Using multiple versions of the google/google-beta provider in a single test isn&rsquo;t working in VCR</em>. Unexpected test failures may occur during tests in REPLAYING mode where <code>ExternalProviders</code> is used to pull in past versions of the google/google-beta provider.</td><td>When ExternalProviders is used to pulling in other versions of the provider, any HTTP traffic through the external provider will not be recorded. If the HTTP traffic produces an unexpected result or returns an API error then the test will fail in REPLAYING mode.</td><td>Skip the test in VCR when testing the current provider behaviour versus previous released versions.</td></tr></tbody></table><p>Some additional things to bear in mind are that VCR tests in REPLAYING mode will still interact with GCP APIs somewhat. For example:</p><ul><li>When the provider is configured it will use credentials to obtain access tokens from GCP</li><li>Some acceptance tests use bootstrapping functions that ensure long-lived resources are present in a testing project before the provider is tested.</li></ul><p>These tests can still run in VCR replaying mode; however, REPLAYING mode can&rsquo;t be used as a way to completely avoid HTTP traffic generally or with GCP APIs.</p><h2 id=whats-next>What&rsquo;s next?<a class=anchor href=#whats-next>#</a></h2><p><a href=https://googlecloudplatform.github.io/magic-modules/test/run-tests/>Run your tests</a></p><h2 id=references>References<a class=anchor href=#references>#</a></h2><ul><li><a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/testing/acceptance-tests>Official Terraform documentation on Acceptance Tests</a></li><li><a href=https://googlecloudplatform.github.io/magic-modules/reference/resource/#examples>MMv1 resource reference: <code>examples</code> ↗</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/4c5ef7e13d1abc77bb9898471359231a4d2f05e0 title='Last modified by Alex Shpak | September 29, 2025' target=_blank rel=noopener><img src=/magic-modules/icons/calendar.svg class=book-icon alt>
<span>September 29, 2025</span></a></div><div><a class="flex align-center" href="https://github.com/hashicorp/terraform-provider-google/issues/new?assignees=&labels=technical-debt,documentation&projects=&title=MM%20docsite%20issue%20in%20content/test%2ftest.md&template=11_developer_productivity.md" target=_blank rel=noopener><img src=/magic-modules/icons/report.svg class=book-icon alt=Edit>
<span>Report documentation issue</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/test/test.md target=_blank rel="noopener edit"><img src=/magic-modules/icons/edit.svg class=book-icon alt>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap justify-between"><span><a href=/magic-modules/develop/client-side-fields/ class="flex align-center"><img src=/magic-modules/icons/backward.svg class=book-icon alt=Previous title="Client-side fields">
<span>Client-side fields</span>
</a></span><span><a href=/magic-modules/test/run-tests/ class="flex align-center"><span>Run tests</span>
<img src=/magic-modules/icons/forward.svg class=book-icon alt=Next title="Run tests"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#before-you-begin>Before you begin</a></li><li><a href=#add-unit-tests>Add unit tests</a></li><li><a href=#add-a-create-test>Add a create test</a></li><li><a href=#add-an-update-test>Add an update test</a></li><li><a href=#bootstrapping>Bootstrap API resources</a><ul><li><a href=#cryptokeys>CryptoKeys</a></li><li><a href=#iam-resources>IAM resources</a></li><li><a href=#networks>Networks</a></li></ul></li><li><a href=#create-test-projects>Create test projects</a></li><li><a href=#skip-vcr>Skip tests in VCR replaying mode</a><ul><li><a href=#reasons-that-tests-are-skipped-in-vcr-replaying-mode>Reasons that tests are skipped in VCR replaying mode</a></li></ul></li><li><a href=#whats-next>What&rsquo;s next?</a></li><li><a href=#references>References</a></li></ul></nav></div></aside></main></body></html>