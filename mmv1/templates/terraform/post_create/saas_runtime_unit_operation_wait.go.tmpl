
var errUnitOperationPending = errors.New("unit operation is still pending")
var errStateFieldMissing = errors.New("unit operation did not return a state field")
if d.Get("wait_for_completion").(bool) {
	log.Printf("[DEBUG] Waiting for UnitOperation %q to reach terminal state", d.Id())
	url, err := tpgresource.ReplaceVars(d, config, "{{"{{"}}SaasRuntimeBasePath{{"}}"}}projects/{{"{{"}}project{{"}}"}}/locations/{{"{{"}}location{{"}}"}}/unitOperations/{{"{{"}}unit_operation_id{{"}}"}}")
	if err != nil {
		return err
	}
	err := transport_tpg.Retry(transport_tpg.RetryOptions{
		Timeout: d.Timeout(schema.TimeoutCreate),
		RetryFunc: func() error {

			res, err := transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
				Config:    config,
				Method:    "GET",
				Project:   billingProject,
				RawURL:    url,
				UserAgent: userAgent,
			})
			if err != nil {
				return err
			}

			state, ok := res["state"].(string)
			if !ok {
				return errStateFieldMissing
			}

			log.Printf("[DEBUG] UnitOperation %q state: %s", d.Id(), state)

			switch state {
			case "UNIT_OPERATION_STATE_SUCCEEDED":
				return nil
			case "UNIT_OPERATION_STATE_FAILED", "UNIT_OPERATION_STATE_CANCELLED":
				return fmt.Errorf("UnitOperation %q reached terminal failure state: %s", d.Id(), state)
			case "UNIT_OPERATION_STATE_UNKNOWN", "UNIT_OPERATION_STATE_PENDING", "UNIT_OPERATION_STATE_SCHEDULED", "UNIT_OPERATION_STATE_RUNNING":
				return errUnitOperationPending
			default:
				return fmt.Errorf("UnitOperation %q has unexpected state: %s", d.Id(), state)
			}
		},
		ErrorRetryPredicates: []transport_tpg.RetryErrorPredicateFunc{
            func(err error) (bool, string) {
                if errors.Is(err, errUnitOperationPending) {
                    return true, "retry pending state"
                }
                if errors.Is(err, errStateFieldMissing) {
                    return true, "wait for state to be populated"
                }
                return false, ""
            },
		},
	})

	if err != nil {
		return fmt.Errorf("Error waiting for UnitOperation to reach terminal state: %s", err)
	}
}