resource "google_artifact_registry_repository" "{{$.PrimaryResourceId}}-upstream-1" {
  location      = "us-central1"
  repository_id = "{{index $.PrefixedVars "upstream_repository_id"}}-1"
  description   = "{{index $.PrefixedVars "upstream_desc"}} 1"
  format        = "DOCKER"
}

resource "google_artifact_registry_repository" "{{$.PrimaryResourceId}}-upstream-2" {
  location      = "us-central1"
  repository_id = "{{index $.PrefixedVars "upstream_repository_id"}}-2"
  description   = "{{index $.PrefixedVars "upstream_desc"}} 2"
  format        = "DOCKER"
}

resource "google_artifact_registry_repository" "{{$.PrimaryResourceId}}" {
  depends_on    = []
  location      = "us-central1"
  repository_id = "{{index $.PrefixedVars "repository_id"}}"
  description   = "{{index $.PrefixedVars "desc"}}"
  format        = "DOCKER"
  mode          = "VIRTUAL_REPOSITORY"
  virtual_repository_config {
    upstream_policies {
      id          = "{{index $.PrefixedVars "upstream_policy_id"}}-1"
      repository  = google_artifact_registry_repository.{{$.PrimaryResourceId}}-upstream-1.id
      priority    = 20
    }
    upstream_policies {
      id          = "{{index $.PrefixedVars "upstream_policy_id"}}-2"
      repository  = google_artifact_registry_repository.{{$.PrimaryResourceId}}-upstream-2.id
      priority    = 10
    }
  }
}
