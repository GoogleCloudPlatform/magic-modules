userAgent, err := tpgresource.GenerateUserAgentString(d, config.UserAgent)
if err != nil {
  return err
}

billingProject := ""

project, err := tpgresource.GetProject(d, config)
if err != nil {
  return fmt.Errorf("Error fetching project for IcebergCatalog: %s", err)
}
billingProject = project

obj := make(map[string]interface{})
credentialModeProp, err := expandBiglakeIcebergIcebergCatalogCredentialMode(d.Get("credential_mode"), d, config)
if err != nil {
  return err
} else if v, ok := d.GetOkExists("credential_mode"); !tpgresource.IsEmptyValue(reflect.ValueOf(v)) && (ok || !reflect.DeepEqual(v, credentialModeProp)) {
  obj["credential-mode"] = credentialModeProp
}

url, err := tpgresource.ReplaceVars(d, config, "{{"{{"}}BiglakeIcebergBasePath{{"}}"}}iceberg/v1/restcatalog/extensions/projects/{{"{{"}}project{{"}}"}}/catalogs/{{"{{"}}name{{"}}"}}")
if err != nil {
  return err
}

log.Printf("[DEBUG] Updating IcebergCatalog %q: %#v", d.Id(), obj)
headers := make(http.Header)
updateMask := []string{}

// The custom logic is that server only respects property name not the json name for updateMask.
// This will apply to all future updateable fields if they have a kebab-case json name override.
// This does not apply to any field with a camelCase or snake_case name.
if d.HasChange("credential_mode") {
  updateMask = append(updateMask, "credential_mode")
}
// updateMask is a URL parameter but not present in the schema, so ReplaceVars
// won't set it
url, err = transport_tpg.AddQueryParams(url, map[string]string{"updateMask": strings.Join(updateMask, ",")})
if err != nil {
  return err
}

// err == nil indicates that the billing_project value was found
if bp, err := tpgresource.GetBillingProject(d, config); err == nil {
  billingProject = bp
}

// if updateMask is empty we are not updating anything so skip the post
if len(updateMask) > 0 {
  res, err := transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
    Config:    config,
    Method:    "PATCH",
    Project:   billingProject,
    RawURL:    url,
    UserAgent: userAgent,
    Body:      obj,
    Timeout:   d.Timeout(schema.TimeoutUpdate),
    Headers:   headers,
  })

  if err != nil {
    return fmt.Errorf("Error updating IcebergCatalog %q: %s", d.Id(), err)
  } else {
    log.Printf("[DEBUG] Finished updating IcebergCatalog %q: %#v", d.Id(), res)
  }

}

return resourceBiglakeIcebergIcebergCatalogRead(d, meta)
