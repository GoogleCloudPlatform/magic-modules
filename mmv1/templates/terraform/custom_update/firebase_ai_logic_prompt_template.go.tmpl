
userAgent, err := tpgresource.GenerateUserAgentString(d, config.UserAgent)
if err != nil {
	return err
}

billingProject := ""

project, err := tpgresource.GetProject(d, config)
if err != nil {
	return fmt.Errorf("Error fetching project for PromptTemplate: %s", err)
}
billingProject = project

obj := make(map[string]interface{})
displayNameProp, err := expandFirebaseAILogicPromptTemplateDisplayName(d.Get("display_name"), d, config)
if err != nil {
	return err
} else if v, ok := d.GetOkExists("display_name"); !tpgresource.IsEmptyValue(reflect.ValueOf(v)) && (ok || !reflect.DeepEqual(v, displayNameProp)) {
	obj["displayName"] = displayNameProp
}
templateStringProp, err := expandFirebaseAILogicPromptTemplateTemplateString(d.Get("template_string"), d, config)
if err != nil {
	return err
} else if v, ok := d.GetOkExists("template_string"); !tpgresource.IsEmptyValue(reflect.ValueOf(v)) && (ok || !reflect.DeepEqual(v, templateStringProp)) {
	obj["templateString"] = templateStringProp
}

url, err := tpgresource.ReplaceVars(d, config, "{{"{{"}}FirebaseAILogicBasePath{{"}}"}}projects/{{"{{"}}project{{"}}"}}/locations/{{"{{"}}location{{"}}"}}/templates/{{"{{"}}template_id{{"}}"}}")
if err != nil {
	return err
}

log.Printf("[DEBUG] Updating PromptTemplate %q: %#v", d.Id(), obj)
headers := make(http.Header)
updateMask := []string{}

if d.HasChange("display_name") {
	updateMask = append(updateMask, "displayName")
}

if d.HasChange("template_string") {
	updateMask = append(updateMask, "templateString")
}
// updateMask is a URL parameter but not present in the schema, so ReplaceVars
// won't set it
url, err = transport_tpg.AddQueryParams(url, map[string]string{"updateMask": strings.Join(updateMask, ",")})
if err != nil {
	return err
}

// err == nil indicates that the billing_project value was found
if bp, err := tpgresource.GetBillingProject(d, config); err == nil {
	billingProject = bp
}

// if updateMask is empty we are not updating anything so skip the post
if len(updateMask) > 0 {
	res, err := transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
		Config:    config,
		Method:    "PATCH",
		Project:   billingProject,
		RawURL:    url,
		UserAgent: userAgent,
		Body:      obj,
		Timeout:   d.Timeout(schema.TimeoutUpdate),
		Headers:   headers,
	})

	if err != nil {
        if strings.Contains(err.Error(), "Precondition check failed") {
            return fmt.Errorf("Error updating PromptTemplate %q: %s. This usually means the template is locked.\n"+
                "- If the lock is managed by Terraform, remove the 'google_firebase_ai_logic_prompt_template_lock' resource from your configuration.\n"+
                "- If the lock is managed externally (e.g. Firebase Console), unlock it there first.", d.Id(), err)
        }
		return fmt.Errorf("Error updating PromptTemplate %q: %s", d.Id(), err)
	} else {
		log.Printf("[DEBUG] Finished updating PromptTemplate %q: %#v", d.Id(), res)
	}

}

return resourceFirebaseAILogicPromptTemplateRead(d, meta)
