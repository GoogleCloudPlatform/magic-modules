resource "google_workbench_instance" "<%= ctx[:primary_resource_id] %>" {
  name = "<%= ctx[:vars]["instance_name"] %>"
  location = "us-central1-a"

  gce_setup {
    machine_type = "n1-standard-4"

    accelerator_configs = [ {
      type         = "NVIDIA_TESLA_T4"
      core_count   = 1
    }]

    vm_image {
      project      = "deeplearning-platform-release"
      family       = "tf-latest-cpu"
    }

    service_accounts = [ "<%= ctx[:test_env_vars]["service_account"] %>"]

    boot_disk {
      disk_size_gb  = 110
      disk_type = "PD_SSD"
      disk_encryption = "GMEK"
    }

    data_disks = [{
      disk_size_gb  = 110
      disk_type = "PD_SSD"
      disk_encryption = "GMEK"
    }]

    shielded_instance_config {
      enable_secure_boot = true
      enable_vtpm = true
      enable_integrity_monitoring = true
    }

    network_interfaces = [{
      network = data.google_compute_network.my_network.id
      subnet = data.google_compute_subnetwork.my_subnetwork.id
      nic_type = "GVNIC"
    }]

    disable_public_ip = true

    tags = ['abc','def']

    metadata = {
      terraform = "true"
    }

    enable_ip_forwarding = true

    gpu_driver_config {
      enable_gpu_driver = true
      custom_gpu_driver_path = 'test_path'
    }
  }

  instance_owners  = [ "<%= ctx[:test_env_vars]["service_account"] %>"]

  disable_proxy_access = true

  labels = {
    k = "val"
  }

}

data "google_compute_network" "my_network" {
  name = "default"
}

data "google_compute_subnetwork" "my_subnetwork" {
  name   = "default"
  region = "us-central1"
}
