resource "google_iam_workforce_pool" "pool" {
  workforce_pool_id = "{{index $.Vars "workforce_pool_id"}}"
  parent            = "organizations/{{index $.TestEnvVars "org_id"}}"
  location          = "global"
}

resource "google_iam_workforce_pool_provider" "provider" {
    location = "global"
    workforce_pool_id = google_iam_workforce_pool.pool.workforce_pool_id
    provider_id = "{{index $.Vars "provider_id"}}"
    attribute_mapping   = {
    "google.subject"  = "assertion.sub"
    }
    oidc {
      issuer_uri        = "https://accounts.thirdparty.com"
      client_id         = "client-id"
      client_secret {
        value {
          plain_text = "client-secret"
        }
      }
      web_sso_config {
        response_type             = "CODE"
        assertion_claims_behavior = "MERGE_USER_INFO_OVER_ID_TOKEN_CLAIMS"
        additional_scopes         = ["groups", "roles"]
      }
    }
    display_name        = "Display name"
    description         = "A sample OIDC workforce pool provider."
    disabled            = false
    attribute_condition = "true"
}

resource "google_iam_workforce_pool_provider_scim_tenant" "tenant" {
  location            = "global"
  workforce_pool_id   = google_iam_workforce_pool.pool.workforce_pool_id
  provider_id         = google_iam_workforce_pool_provider.provider.provider_id
  scim_tenant_id      = "{{index $.Vars "scim_tenant_id"}}"
  display_name        = "SCIM Tenant display Name"
  description         = "A SCIM Tenant for IAM Workforce Pool Provider"
  claim_mapping       = {
    "google.subject"  = "user.externalId",
    "google.group"    = "group.externalId"
  }
  hard_delete         = true
  # state, base_uri, purge_time and service_agent are output only, not settable
}

resource "google_iam_workforce_pool_provider_scim_token" "{{$.PrimaryResourceId}}" {
  location            = "global"
  workforce_pool_id   = google_iam_workforce_pool.pool.workforce_pool_id
  provider_id         = google_iam_workforce_pool_provider.provider.provider_id
  scim_tenant_id      = google_iam_workforce_pool_provider_scim_tenant.tenant.scim_tenant_id
  scim_token_id       = "example-scim-token"
  display_name        = "SCIM Token display Name"
  # security_token and state are output only, not settable
}
  