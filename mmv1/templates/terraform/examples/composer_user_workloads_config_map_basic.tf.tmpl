data "google_project" "project" {}

resource "google_service_account" "test" {
  account_id   = "{{index $.Vars "service_account_name"}}"
  display_name = "Test Service Account for Composer Environment"
}

resource "google_project_iam_member" "composer-worker" {
  project = data.google_project.project.project_id
  role   = "roles/composer.worker"
  member = "serviceAccount:${google_service_account.test.email}"
}

resource "google_composer_environment" "environment" {
  name   = "{{index $.Vars "environment_name"}}"
  region = "us-central1"
  config {
    software_config {
      image_version = "composer-3-airflow-2"
    }
    node_config {
      service_account = google_service_account.test.name
    }
  }
  depends_on = [google_project_iam_member.composer-worker]
}

resource "google_composer_user_workloads_config_map" "{{$.PrimaryResourceId}}" {
  name = "{{index $.Vars "config_map_name"}}"
  region = "us-central1"
  environment = google_composer_environment.environment.name
  data = {
    api_host: "apihost:443",
  }
}
