resource "google_scc_v2_organization_source" "<%= ctx[:primary_resource_id] %>" {
  display_name = "<%= ctx[:vars]['source_display_name'] %>"
  organization = "<%= ctx[:test_env_vars]['org_id'] %>"
  description  = "My custom Cloud Security Command Center Finding Source"
  canonical_name = "<%= ctx[:vars]['source_canonical_name'] %>"
}

resource "google_scc_v2_organization_source_iam_binding" "primary" {
  condition {
    description = "Description"          
    expression  = "resource.name.startsWith('projects/_/buckets/bucket-name')"
    title       = "Title"                
  }
  members      = ["user:example@example.com"]      
  organization = "<%= ctx[:test_env_vars]['org_id'] %>"
  role         = "roles/securitycenter.findingsEditor"  
  source       = google_scc_v2_organization_source.<%= ctx[:primary_resource_id] %>.name
}

resource "google_scc_v2_organization_source_iam_member" "primary" {
  condition {
    description = "Description"          
    expression  = "resource.name.startsWith('projects/_/buckets/bucket-name')"  
    title       = "Title"                
  }
  member       = "user:example@example.com"        
  organization = "<%= ctx[:test_env_vars]['org_id'] %>"
  role         = "roles/securitycenter.findingsViewer"  
  source       = google_scc_v2_organization_source.<%= ctx[:primary_resource_id] %>.name
}

resource "google_scc_v2_organization_source_iam_policy" "primary" {
  organization = "<%= ctx[:test_env_vars]['org_id'] %>"
  policy_data  = <<EOF
{
  "bindings": [
    {
      "role": "roles/securitycenter.findingsEditor",
      "members": [
        "user:example@example.com"  
      ],
      "condition": {
        "title": "Title",                
        "description": "Description",    
        "expression": "resource.name.startsWith('projects/_/buckets/bucket-name')" 
      }
    }
  ]
}
EOF
  source = google_scc_v2_organization_source.<%= ctx[:primary_resource_id] %>.name
}