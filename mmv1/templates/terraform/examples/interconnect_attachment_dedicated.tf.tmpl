data "google_project" "project" {}

resource "google_compute_interconnect" "foobar" {
  name                 = "<%= ctx[:vars]['interconnect_name'] %>"
  customer_name        = "internal_customer" # Special customer only available for Google testing.
  interconnect_type    = "DEDICATED"
  link_type            = "LINK_TYPE_ETHERNET_10G_LR"
  requested_link_count = 1
  location             = "https://www.googleapis.com/compute/v1/projects/${data.google_project.project.name}/global/interconnectLocations/z2z-us-east4-zone1-lciadl-a" # Special location only available for Google testing.
}

resource "google_compute_interconnect_attachment" "<%= ctx[:primary_resource_id] %>" {
  name                     = "<%= ctx[:vars]['interconnect_attachment_name'] %>"
  type                     = "DEDICATED"
  interconnect             = google_compute_interconnect.foobar.id
  router                   = google_compute_router.foobar.id
  mtu                      = 1500
  subnet_length            = 29
  vlan_tag8021q            = 1000
  region                   = "https://www.googleapis.com/compute/v1/projects/${data.google_project.project.name}/regions/us-east4"
  stack_type               = "IPV4_ONLY"
}

resource "google_compute_router" "foobar" {
  name    = "<%= ctx[:vars]['router_name'] %>"
  network = google_compute_network.foobar.name
  region  = "us-east4"
  bgp {
    asn = 16550
  }
}

resource "google_compute_network" "foobar" {
  name                    = "<%= ctx[:vars]['network_name'] %>"
  auto_create_subnetworks = false
}
