resource "google_compute_region_backend_bucket" "{{$.PrimaryResourceId}}" {
  name                  = "{{index $.Vars "backend_bucket_name"}}"
  region                = "{{index $.Vars "region"}}"
  bucket_name           = google_storage_bucket.{{$.PrimaryResourceId}}.name
  load_balancing_scheme = "EXTERNAL_MANAGED"
  description           = "Regional external backend bucket for static content"
  
  compression_mode = "AUTOMATIC"
  
  custom_response_headers = [
    "X-Cache-Status: {cdn_cache_status}",
    "X-Client-Region: {client_region}",
  ]
}

resource "google_storage_bucket" "{{$.PrimaryResourceId}}" {
  name                        = "{{index $.Vars "bucket_name"}}"
  location                    = upper("{{index $.Vars "region"}}")
  force_destroy               = true
  uniform_bucket_level_access = true
  
  website {
    main_page_suffix = "index.html"
    not_found_page   = "404.html"
  }
}

resource "google_storage_bucket_object" "index" {
  name    = "index.html"
  bucket  = google_storage_bucket.{{$.PrimaryResourceId}}.name
  content = "<html><body><h1>Regional External LB Backend Bucket</h1></body></html>"
}

resource "google_storage_bucket_object" "static_asset" {
  name    = "assets/style.css"
  bucket  = google_storage_bucket.{{$.PrimaryResourceId}}.name
  content = "body { font-family: Arial, sans-serif; }"
}