resource "google_backup_dr_restore_workload" "{{$.PrimaryResourceId}}" {
  location         = "us-central1"
  backup_vault_id  = "{{index $.Vars "backup_vault_id"}}"
  data_source_id   = "{{index $.Vars "data_source_id"}}"
  backup_id        = "{{index $.Vars "backup_id"}}"
  
  name = "{{index $.Vars "backup_name"}}"

  compute_instance_target_environment {
    project = "{{index $.TestEnvVars "project"}}"
    zone    = "us-central1-a"
  }

  compute_instance_restore_properties {
    name         = "{{index $.Vars "instance_name"}}"
    machine_type = "e2-medium"
    description  = "Restored compute instance with advanced configuration"
    
    can_ip_forward      = true
    deletion_protection = false
    
    labels = {
      environment = "production"
      restored    = "true"
      team        = "infrastructure"
    }
    
    tags {
      items = ["web", "https-server", "restored"]
    }
    
    network_interfaces {
      network    = "default"
      subnetwork = "projects/{{index $.TestEnvVars "project"}}/regions/us-central1/subnetworks/default"
      
      access_configs {
        name         = "External NAT"
        network_tier = "PREMIUM"
      }
    }
    
    scheduling {
      automatic_restart   = true
      on_host_maintenance = "MIGRATE"
      preemptible         = false
      provisioning_model  = "STANDARD"
    }
    
    service_accounts {
      email  = "default"
      scopes = [
        "https://www.googleapis.com/auth/cloud-platform",
        "https://www.googleapis.com/auth/compute"
      ]
    }
    
    shielded_instance_config {
      enable_secure_boot          = true
      enable_vtpm                 = true
      enable_integrity_monitoring = true
    }
    
    advanced_machine_features {
      enable_nested_virtualization = false
      threads_per_core            = 1
    }
    
    metadata {
      items {
        key   = "startup-script"
        value = "#!/bin/bash\necho 'Instance restored' > /tmp/restored.txt"
      }
      items {
        key   = "enable-oslogin"
        value = "TRUE"
      }
    }
  }
}
