resource "google_redis_cluster" "{{$.PrimaryResourceId}}" {
  name           = "{{index $.Vars "cluster_name"}}"
  shard_count    = 3
  region         = "us-central1"
  
  psc_configs {
    network = google_compute_network.consumer_net.id
  }

  # Security configurations
  transit_encryption_mode = "TRANSIT_ENCRYPTION_MODE_SERVER_AUTHENTICATION"
  server_ca_mode          = "SERVER_CA_MODE_CUSTOMER_MANAGED_CAS_CA"
  server_ca_pool          = google_privateca_ca_pool.default.id

  deletion_protection_enabled = {{index $.Vars "deletion_protection_enabled"}}

  depends_on = [
    google_network_connectivity_service_connection_policy.default,
    google_privateca_certificate_authority.default
  ]
}

resource "google_privateca_ca_pool" "default" {
  name     = "{{index $.Vars "ca_pool_name"}}"
  location = "us-central1"
  tier     = "ENTERPRISE"
}

resource "google_privateca_certificate_authority" "default" {
  pool                     = google_privateca_ca_pool.default.name
  certificate_authority_id = "{{index $.Vars "ca_auth_id"}}"
  location                 = "us-central1"
  config {
    subject_config {
      subject {
        organization = "Google"
        common_name  = "my-redis-ca"
      }
    }
    x509_config {
      ca_options {
        is_ca = true
      }
      key_usage {
        base_key_usage {
          cert_sign = true
          crl_sign  = true
        }
        # Added this block to satisfy provider requirements
        extended_key_usage {
          server_auth = true
        }
      }
    }
  }
  key_spec {
    algorithm = "RSA_PKCS1_4096_SHA256"
  }
  deletion_protection = false
  skip_grace_period   = true
}

resource "google_network_connectivity_service_connection_policy" "default" {
  name           = "{{index $.Vars "policy_name"}}"
  location       = "us-central1"
  service_class  = "gcp-memorystore-redis"
  network        = google_compute_network.consumer_net.id
  psc_config {
    subnetworks = [google_compute_subnetwork.consumer_subnet.id]
  }
}

resource "google_compute_subnetwork" "consumer_subnet" {
  name          = "{{index $.Vars "subnet_name"}}"
  ip_cidr_range = "10.0.0.248/29"
  region        = "us-central1"
  network       = google_compute_network.consumer_net.id
}

resource "google_compute_network" "consumer_net" {
  name                    = "{{index $.Vars "network_name"}}"
  auto_create_subnetworks = false
}