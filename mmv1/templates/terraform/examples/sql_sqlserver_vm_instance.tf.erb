# [START cloud_sql_sqlserver_vm_instance]
resource "google_compute_instance" "<%= ctx[:primary_resource_id] %>" {
  name = "<%= ctx[:vars]['sqlserver_vm'] %>"
  allow_stopping_for_update = true
  boot_disk {
    auto_delete = true
    device_name = "persistent-disk-0"
    initialize_params {
      image = "projects/windows-sql-cloud/global/images/sql-2019-standard-windows-2022-dc-v20220314"
      size  = 50
      type  = "pd-balanced"
    }
    mode   = "READ_WRITE"
  }
  machine_type = "n1-standard-4"
  zone         = "us-west1-b"
  network_interface {
    access_config {
      network_tier = "PREMIUM"
    }
    network            = "global/networks/default"
    stack_type         = "IPV4_ONLY"
    subnetwork         = "regions/us-west1/subnetworks/default"
  }
}
# [END cloud_sql_sqlserver_vm_instance]

# [START cloud_sql_sqlserver_vm_firewall_rule]
resource "google_compute_firewall" "sql_server_fw_rule" {
  allow {
    ports    = ["1433"]
    protocol = "tcp"
  }
  description   = "Allow SQL Server access from all sources on port 1433."
  direction     = "INGRESS"
  name          = "<%= ctx[:vars]['sql_server_1433'] %>"
  network       = "global/networks/default"
  priority      = 1000
  source_ranges = ["0.0.0.0/0"]
}
# [END cloud_sql_sqlserver_vm_firewall_rule]
