resource "google_dataplex_datascan" "<%= ctx[:primary_resource_id] %>" {
  location     = "us-central1"
  display_name = "Full Datascan Quality"
  data_scan_id = "tf-test-datascan%{random_suffix}"
  description  = "Example resource - Full Datascan Quality"
  labels = {
    author = "billing"
  }

  data {
        resource = "//bigquery.googleapis.com/projects/bigquery-public-data/datasets/samples/tables/shakespeare"
  }

  data_profile_spec {
      sampling_percent = 80
  }

  execution_spec {
    trigger {
              schedule {
                cron = "TZ=America/New_York 1 1 * * *"
              }
            }
  }

  data_quality_spec {
        rules {
          column = "word"
          dimension = "VALIDITY"
          threshold = 0.99
          non_null_expectation {
          }
        }

        rules {
          column = "word_count"
          dimension = "VALIDITY"
          ignore_null = true
          threshold = 0.9
          range_expectation {
            min_value = 0
            max_value = 10
            strict_min_enabled = true
            strict_max_enabled = false
          }
        }

        rules {
          column = "word"
          dimension = "VALIDITY"
          ignore_null = false
          regex_expectation {
            regex = "^apple$"
          }
        }

        rules {
          column = "word"
          dimension = "UNIQUENESS"
          uniqueness_expectation {
          }
        }

        rules {
          column = "word_count"
          dimension = "VALIDITY"
          statistic_range_expectation {
            statistic = "MEAN"
            min_value = 5
            max_value = 10
            strict_min_enabled = true
            strict_max_enabled = false
          }
        }

        rules {
          column = "word_count"
          dimension = "VALIDITY"
          row_condition_expectation {
            sql_expression = "word_count > 0 AND word_count <= 10"
          }
        }

        rules {
          dimension = "VALIDITY"
          table_condition_expectation {
            sql_expression = "COUNT(*) > 0"
          }
        }
      }


  project = "<%= ctx[:test_env_vars]['project_name'] %>"
}


