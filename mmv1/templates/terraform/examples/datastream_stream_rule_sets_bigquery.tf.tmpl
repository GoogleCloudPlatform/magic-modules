data "google_project" "project" {
}

resource "google_datastream_stream" "stream" {
    stream_id = "{{index .Vars "stream_id"}}"
    location = "us-central1"
    display_name = "BigQuery Stream with Rules"

    source_config {
        source_connection_profile = "{{index $.Vars "source_connection_profile_id"}}"
        mysql_source_config {
          include_objects {
            mysql_databases {
              database = "my_database"
            }
          }
          binary_log_position {}
        }
    }

    destination_config {
        destination_connection_profile = "{{index $.Vars "destination_connection_profile_id"}}"
        bigquery_destination_config {
            single_target_dataset {
              dataset_id = "{{index $.Vars "dataset_id"}}"
            }
        }
    }

    backfill_none {}

    rule_sets {
      object_filter {
        source_object_identifier {
          mysql_identifier {
            database = "test_database"
            table    = "test_table_1"
          }
        }
      }
      customization_rules {
        bigquery_clustering {
          columns = ["user_id"]
        }
      }
      customization_rules {
        bigquery_partitioning {
          ingestion_time_partition {
          }
        }
      }
    }
    
    rule_sets {
      object_filter {
        source_object_identifier {
          mysql_identifier {
            database = "test_database"
            table    = "test_table_2"
          }
        }
      }
      customization_rules {
        bigquery_clustering {
          columns = ["event_time"]
        }
      }
      customization_rules {
    	bigquery_partitioning {
          time_unit_partition {
            column = "event_time"
            partitioning_time_granularity = "PARTITIONING_TIME_GRANULARITY_DAY"
          }
    	}
      }
    }
}

