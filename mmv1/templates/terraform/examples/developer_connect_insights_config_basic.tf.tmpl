resource "google_project" "project" {
  project_id = "dci-tf-%{random_suffix}"
  name = "Service Project"
  org_id = "{{index $.TestEnvVars "org_id"}}"
  billing_account = "{{index $.TestEnvVars "billing_account"}}"
  deletion_policy = "DELETE"
}

# Grant Permissions
resource "google_project_iam_member" "apphub_permissions" {
  project = google_project.project.project_id
  role = "roles/apphub.admin"
  member = "serviceAccount:hashicorp-test-runner@ci-test-project-188019.iam.gserviceaccount.com"
}

# Enable APIs
resource "google_project_service" "apphub_api_service" {
  project = google_project.project.project_id
  service = "apphub.googleapis.com"
  depends_on = [google_project.project]
}

# Wait delay after enabling APIs and granting permissions
resource "time_sleep" "wait_permissions_apis" {
  depends_on = [
    google_project_iam_member.apphub_permissions,
    google_project_service.apphub_api_service
  ]
  create_duration  = "120s"
}

resource "google_apphub_application" "my_apphub_application" {
  location = "us-central1"
  application_id = "tf-test-example-application%{random_suffix}"
  scope {
    type = "REGIONAL"
  }
  project = google_project.project.project_id
  depends_on = [time_sleep.wait_for_propagation]
}

resource "google_developer_connect_insights_config" "my_insights_config" {
  location           = "us-central1"
  insights_config_id = "tf-test-ic%{random_suffix}"
  project            = google_project.project.project_id
  annotations = {}
  labels = {}
  app_hub_application = format("//apphub.googleapis.com/projects/%s/locations/%s/applications/%s",
        google_project.project.number,
        google_apphub_application.my_apphub_application.location,
        google_apphub_application.my_apphub_application.application_id)
}
