resource "google_dataplex_data_product" "example" {
  project         = "{{index $.TestEnvVars "project_name"}}"
  location        = "us-central1"
  data_product_id = "tf-test-dp-%{random_suffix}"
  display_name    = "Full Example Parent DP"
  owner_emails    = ["gterraformtestuser@gmail.com"]

  access_groups {
    id           = "analyst"
    group_id     = "analyst"
    display_name = "Data Analyst"
    principal {
      google_group = "dataproduct-terraform-examples@google.com"
    }
  }

  access_groups {
    id           = "scientist"
    group_id     = "scientist"
    display_name = "Data Scientist"
    principal {
      google_group = "dataproduct-terraform-examples-2@google.com"
    }
  }

  provider = google-beta
}

resource "google_bigquery_dataset" "example" {
  project    = "{{index $.TestEnvVars "project_name"}}"
  dataset_id = "tf_test_dataset_%{random_suffix}"
  location   = "us-central1"
  provider   = google-beta
}

resource "google_dataplex_data_asset" "{{$.PrimaryResourceId}}" {
  project         = "{{index $.TestEnvVars "project_name"}}"
  location        = "us-central1"
  data_product_id = google_dataplex_data_product.example.data_product_id
  data_asset_id   = "{{index $.Vars "data_asset_id"}}"
  resource        = "//bigquery.googleapis.com/projects/${google_bigquery_dataset.example.project}/datasets/${google_bigquery_dataset.example.dataset_id}"

  labels = {
    env      = "prod"
    critical = "true"
  }

  access_group_configs {
    access_group = "analyst"
    iam_roles    = ["roles/bigquery.dataViewer"]
  }

  access_group_configs {
    access_group = "scientist"
    iam_roles    = ["roles/bigquery.dataEditor"]
  }

  provider = google-beta
}
