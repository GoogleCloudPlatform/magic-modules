resource "google_bigquery_analytics_hub_data_exchange" "{{$.PrimaryResourceId}}" {
display_name = "My Audience Data Exchange"
data_exchange_id = "{{index $.Vars "data_exchange_id"}}"
description = "{{index $.Vars "desc"}}"
location = "us"
sharing_environment_config {
dcr_exchange_config {}
}
}

resource "google_bigquery_analytics_hub_query_template" "{{$.PrimaryResourceId}}" {
location = "us"
data_exchange_id = google_bigquery_analytics_hub_data_exchange.{{$.PrimaryResourceId}}.data_exchange_id
query_template_id = "{{index $.Vars "query_template_id"}}"
display_name = "{{index $.Vars "query_template_id"}}"
description = "{{index $.Vars "desc"}}"
primary_contact = "admin@example.com"
documentation = "This TVF takes a table t1 as input and returns all columns. Useful for basic data pass-through."
routine {
routine_type="TABLE_VALUED_FUNCTION"
definition_body="{{index $.Vars "query_template_id"}}() as (select * from t1)"
}
submit=true
} 

resource "google_bigquery_analytics_hub_approve_query_template" "{{$.PrimaryResourceId}}" {
  location         = "us" 
  data_exchange_id = google_bigquery_analytics_hub_data_exchange.{{$.PrimaryResourceId}}.data_exchange_id
  query_template_id = "{{index $.Vars "query_template_id"}}"
  depends_on = [google_bigquery_analytics_hub_query_template.{{$.PrimaryResourceId}}]
}