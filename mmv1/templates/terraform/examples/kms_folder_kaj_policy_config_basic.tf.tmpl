# Create Folder in GCP Organization.
resource "google_folder" "kaj_folder" {
	provider     = google-beta
	display_name = "{{index $.Vars "folder_name"}}"
	parent       = "organizations/{{index $.TestEnvVars "org_id"}}"
	deletion_protection = false
}

resource "random_id" "project_suffix" {
  byte_length = 4
}

# Create a project for enabling KMS API.
resource "google_project" "kms_project" {
  provider        = google-beta
  project_id      = "kms-api-project${random_id.project_suffix.hex}"
  name            = "kms-api-project${random_id.project_suffix.hex}"
  folder_id       = google_folder.kaj_folder.folder_id
  billing_account = "{{index $.TestEnvVars "billing_account"}}"
  depends_on      = [google_folder.kaj_folder]
  deletion_policy = "DELETE"
}

# Enable the Cloud KMS API.
resource "google_project_service" "kms_api_service" {
  provider                   = google-beta
  service                    = "cloudkms.googleapis.com"
  project                    = google_project.kms_project.project_id
  disable_dependent_services = true
  depends_on                 = [google_project.kms_project]
}

resource "time_sleep" "wait_enable_service_api" {
	depends_on	= [google_project_service.kms_api_service]
	create_duration	= "30s"
}
# Update folder level KAJ default policy
resource "google_kms_folder_kaj_policy_config" "{{$.PrimaryResourceId}}" {
	provider 				= google-beta
	folder 					= google_folder.kaj_folder.folder_id
	default_key_access_justification_policy {
		allowed_access_reasons = [
			"CUSTOMER_INITIATED_ACCESS",
			"GOOGLE_INITIATED_SYSTEM_OPERATION",
		]
	}
	depends_on      = [time_sleep.wait_enable_service_api]
}
