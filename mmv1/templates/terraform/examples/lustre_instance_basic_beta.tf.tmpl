resource "google_lustre_instance" "{{$.PrimaryResourceId}}" {
  provider = google-beta
  instance_id = "{{index $.Vars "name"}}"
  location = "us-central1-a"
  description = "test instance"
  filesystem = "testfs"
  capacity_gib = 18000
  network = "${data.google_project.project.id}/global/networks/default"
  labels = {
    test = "value"
  }
  depends_on = [google_service_networking_connection.default]
}

# Create an IP address
resource "google_compute_global_address" "private_ip_alloc" {
  provider = google-beta
  name          = "{{index $.Vars "address_name"}}"
  purpose       = "VPC_PEERING"
  address_type  = "INTERNAL"
  prefix_length = 24
  network       = "${data.google_project.project.id}/global/networks/default"
}

# Create a private connection
resource "google_service_networking_connection" "default" {
  provider = google-beta
  network                 = "${data.google_project.project.id}/global/networks/default"
  service                 = "servicenetworking.googleapis.com"
  reserved_peering_ranges = [google_compute_global_address.private_ip_alloc.name]
  update_on_creation_fail = true
}

data "google_project" "project" {
}
