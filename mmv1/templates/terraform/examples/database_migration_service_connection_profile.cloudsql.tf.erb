resource "google_sql_database_instance" "cloudsqldb" {
  name             = "<%= ctx[:vars]["cloudsqldb"] %>"
  database_version = "MYSQL_5_7"
  settings {
    tier = "db-n1-standard-1"
  }
}

resource "google_sql_ssl_cert" "cloudsqldb_client_cert" {
  common_name = "<%= ctx[:vars]["cloudsqldb_cert"] %>"
  instance    = google_sql_database_instance.cloudsqldb.name
  
  depends_on = [google_sql_database_instance.cloudsqldb]
}

resource "google_sql_user" "coudsqldb_user" {
  name     = "<%= ctx[:vars]["cloudsqldb_user"] %>"
  instance = google_sql_database_instance.cloudsqldb.name
  password = "<%= ctx[:vars]["cloudsqldb_pass"] %>"
  
  depends_on = [google_sql_database_instance.cloudsqldb]
}



resource "google_database_migration_service_connection_profile" "<%= ctx[:primary_resource_id] %>" {
	location = "us-central1"		
	connection_profile_id = "<%= ctx[:vars]["cloudsqldb_from_profile"] %>"
	display_name = "<%= ctx[:vars]["cloudsqldb_from_profile"] %>_display"
	name = "projects/${data.google_project.project.number}/locations/us-central1/connectionProfiles/<%= ctx[:vars]["cloudsqldb_from_profile"] %>"
	labels	= { 
					testanno = "testanno" 
				}
	mysql {
	  host = google_sql_database_instance.main.ip_address.0.ip_address
	  port = 3306
	  username = "testusernamecloudsql"
	  password = "testpasswordcloudsql"
	  ssl {
	  	client_key = google_sql_ssl_cert.cloudsqldb_client_cert.private_key
	  	client_certificate = google_sql_ssl_cert.cloudsqldb_client_cert.cert
	  	ca_certificate = google_sql_ssl_cert.cloudsqldb_client_cert.server_ca_cert
	  }
	  cloud_sql_id = "<%= ctx[:vars]["cloudsqldb"] %>"
	}
	dbprovider            = "CLOUDSQL"

	depends_on = [google_sql_database_instance.cloudsqldb]
}


resource "google_database_migration_service_connection_profile" "<%= ctx[:primary_resource_id] %>" {
	location = "us-central1"		
	connection_profile_id = "<%= ctx[:vars]["cloudsqldb_to_profile"] %>"
	display_name = "<%= ctx[:vars]["cloudsqldb_to_profile"] %>_displayname"
	name = "projects/${data.google_project.project.number}/locations/us-central1/connectionProfiles/<%= ctx[:vars]["cloudsqldb_to_profile"] %>"
	dbprovider            = "CLOUDSQL"
	labels	= { 
					testlabela = "testlabelb" 
				}
	cloudsql {
	  settings {
	  	database_version = "MYSQL_5_7"
	  	user_labels = { 
					testuserlabela = "testuserlabelb" 
				}
		tier = "db-n1-standard-1"
		storage_auto_resize_limit = "0"
		activation_policy = "ALWAYS"
		ip_config {
			enable_ipv4 = true
			require_ssl = "true"
			authorized_networks {
				value = google_sql_database_instance.cloudsqldb.ip_address.0.ip_address
				label = "testlabel"
			}
		}
		auto_storage_increase = true
		data_disk_type = "PD_HDD"
		data_disk_size_gb = "11"
		zone = "us-central1-b"
		source_id = "projects/${data.google_project.project.number}/locations/us-central1/connectionProfiles/<%= ctx[:vars]["cloudsqldb_from_profile"] %>"
		root_password = "testpasscloudsql"
	  }


	depends_on = [google_sql_database_instance.main]
	}
}
