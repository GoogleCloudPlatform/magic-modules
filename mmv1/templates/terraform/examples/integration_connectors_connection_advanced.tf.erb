data "google_project" "test_project" {
  project_id = "connectors-autopush-harsha"
}

resource "google_secret_manager_secret" "secret-basic" {
  secret_id = "secret-version"
  project = "connectors-autopush-harsha"

  replication {
    user_managed {
      replicas {
        location = "us-central1"
      }
    }
  }
}


resource "google_secret_manager_secret_version" "secret-version-basic" {
  secret = google_secret_manager_secret.secret-basic.id
  secret_data = "Google@123@"
}

resource "google_secret_manager_secret_iam_member" "secret_iam" {
  secret_id  = google_secret_manager_secret.secret-basic.id
  role       = "roles/secretmanager.admin"
  member     = "serviceAccount:${data.google_project.test_project.number}-compute@developer.gserviceaccount.com"
  depends_on = [google_secret_manager_secret_version.secret-version-basic]
}

resource "google_integration_connectors_connection" "<%= ctx[:primary_resource_id] %>" {
    name     = "<%= ctx[:vars]['connection_name'] %>"
    description = "tf updated description"
    service_account = "893437653600-compute@developer.gserviceaccount.com"
    connector_version = "projects/connectors-autopush-harsha/locations/global/providers/zendesk/connectors/zendesk/versions/1"
    config_variable {
        key = "proxy_enabled"
        boolean_value = false
    }
    suspended = false
    auth_config {
      auth_type = "USER_PASSWORD"
      user_password {
        username = "brijeshpanara@google.com"
        password {
          secret_version = google_secret_manager_secret_version.secret-version-basic.name
        }
      }
    }

    destination_config {
      key = "url"
      destination {
          host = "https://test6091.zendesk.com"
      }
    }
    eventing_enablement_type = "EVENTING_AND_CONNECTION"
    eventing_config {
        registration_destination_config {
          key = "registration_destination_config"
          destinations {
              host = "https://test6091.zendesk.com"
            }
        }
        auth_config {
          auth_type = "USER_PASSWORD"
          user_password {
            username = "brijeshpanara@google.com"
            password {
              secret_version = google_secret_manager_secret_version.secret-version-basic.name
            }
          }
        }
        enrichment_enabled = true
      }
  }