data "google_project" "project" {
  provider = google-beta
}

resource "google_kms_crypto_key_iam_member" "kms-parameter-binding" {
  provider = google-beta
  crypto_key_id = "{{index $.Vars "kms_key"}}"
  role = "roles/cloudkms.cryptoKeyEncrypterDecrypter"
  member = "serviceAccount:service-${data.google_project.project.number}@gcp-sa-pm.iam.gserviceaccount.com"
}

resource "google_parameter_manager_parameter" "parameter-basic" {
  provider  = google-beta
  parameter_id = "{{index $.Vars "parameter_id"}}"

  kms_key = "{{index $.Vars "kms_key"}}"

  depends_on = [ google_kms_crypto_key_iam_member.kms-parameter-binding ]
}

resource "google_parameter_manager_parameter_version" "{{$.PrimaryResourceId}}" {
  provider = google-beta
  parameter = google_parameter_manager_parameter.parameter-basic.id
  parameter_version_id = "{{index $.Vars "parameter_version_id"}}"
  parameter_data = "app-parameter-version-data"
}
