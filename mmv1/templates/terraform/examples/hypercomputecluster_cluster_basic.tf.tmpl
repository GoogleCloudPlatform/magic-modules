data "google_project" "project" {
}

locals {
  project_id = data.google_project.project.name
}

resource "google_hypercomputecluster_cluster" "{{$.PrimaryResourceId}}" {
  cluster_id                  = "{{index $.Vars "cluster_id"}}"
  location                    = "us-central1"
  description                 = "Cluster Director instance created through Terraform"
  network_resources {
    id = "network1"
    config {
      new_network {
        description = "Network one"
        network = "projects/${local.project_id}/global/networks/cluster-net1"
      }
    }
  }
  compute_resources {
    id = "compute1"
    config {
      new_on_demand_instances {
        machine_type = "n2-standard-2"
        zone = "us-central1-a"
      }
    }
  }
  orchestrator {
    slurm {
      login_nodes {
        machine_type = "n2-standard-2"        
        count = 1
        zone = "us-central1-a"
        boot_disk {
          size_gb = "100"
          type = "pd-balanced"
        }
      }
      node_sets {
        id = "nodeset1"
        compute_id = "compute1"
        static_node_count = 1
        compute_instance {
          boot_disk {
            size_gb = "100"
            type = "pd-balanced"
          }
        }
      }
      partitions {
        id = "partition1"
        node_set_ids = ["nodeset1"]
      }
      default_partition = "partition1"
    }
  }
}
