resource "google_bigquery_dataset" "tf_test_dataset" {
  dataset_id = "tf_test_dataset_id_%{random_suffix}"
  default_table_expiration_ms = 3600000
  delete_contents_on_destroy = true
}

resource "google_bigquery_table" "tf_test_table" {
  dataset_id          = google_bigquery_dataset.tf_test_dataset.dataset_id
  table_id            = "tf_test_table_id_%{random_suffix}"
  deletion_protection = false
  schema              = <<EOF
    [
      {
        "name": "word",
        "type": "STRING",
        "mode": "REQUIRED"
      },
      {
        "name": "word_count",
        "type": "INTEGER",
        "mode": "REQUIRED"
      },
      {
        "name": "corpus",
        "type": "STRING",
        "mode": "REQUIRED"
      },
      {
        "name": "corpus_date",
        "type": "INTEGER",
        "mode": "REQUIRED"
      }
    ]
  EOF
}

resource "google_dataplex_datascan" "{{$.PrimaryResourceId}}" {
  location = "us-central1"
  display_name = "Full Datascan Quality Publishing"
  data_scan_id = "{{index $.Vars "datascan_name"}}"
  description = "Example resource - Full Datascan Quality with Publishing enabled"
  labels = {
    author = "billing"
  }

  data {
      resource = "//bigquery.googleapis.com/projects/{{index $.TestEnvVars "project_name"}}/datasets/${google_bigquery_dataset.tf_test_dataset.dataset_id}/tables/${google_bigquery_table.tf_test_table.table_id}"
  }

  execution_spec {
      trigger {
      schedule {
          cron = "TZ=America/New_York 1 1 * * *"
      }
      }
  }

  data_profile_spec {
    sampling_percent = 80
    row_filter = "word_count > 10"
    include_fields {
      field_names = ["word_count"]
    }
    exclude_fields {
      field_names = ["property_type"]
    }
    post_scan_actions {
      bigquery_export {
        results_table = "//bigquery.googleapis.com/projects/{{index $.TestEnvVars "project_name"}}/datasets/${google_bigquery_dataset.tf_test_dataset.dataset_id}/tables/profile_export_%{random_suffix}"
      }
    }
    catalog_publishing_enabled = true
  }

  project = "{{index $.TestEnvVars "project_name"}}"

  depends_on = [
    google_bigquery_dataset.tf_test_dataset
  ]
}
