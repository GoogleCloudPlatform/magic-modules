resource "google_colab_runtime_template" "my_runtime_template" {
  name = "{{index $.Vars "runtime_template_name"}}"
  display_name = "Runtime template"
  location = "us-central1"

  machine_spec {
    machine_type     = "e2-standard-4"
  }

  network_spec {
    enable_internet_access = true
  }
}

resource "google_project_iam_member" "colab_enterprise_admin" {
  project = "{{index $.TestEnvVars "project_id"}}"
  role    = "roles/aiplatform.colabEnterpriseAdmin"
  member  = "user:example@example.com"
}

resource "google_storage_bucket" "notebook_bucket" {
  name          = "{{$.PrimaryResourceId}}_bucket"
  location      = "US"
  force_destroy = true
}

resource "google_storage_bucket_object" "notebook_file" {
  name   = "hello_world.ipynb"
  bucket = google_storage_bucket.notebook_bucket.name
  content = <<EOF
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs":,
   "source": [
    "print(\"hello world\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
EOF
}







resource "google_colab_notebook_execution" "{{$.PrimaryResourceId}}" {
  display_name = "Notebook execution basic"
  location = "us-central1"
  
  direct_notebook_source {
    content = base64encode("{'cells': [{'cell_type': 'code','id':'9fbDnZ6fVT4JriRfUseEFwgX','metadata': {'tags': [],'id':'9fbDnZ6fVT4JriRfUseEFwgX'},'source': ['import numpy as np'],'execution_count': null,'outputs': []}],'metadata': {'kernelspec':{'display_name': 'Python 3','language': 'python','name':'python3'},'language_info': {'codemirror_mode': {'name':'ipython','version': 3},'file_extension': '.py','mimetype':'text/x-python','name': 'python','nbconvert_exporter':'python','pygments_lexer': 'ipython3','version': '3.10.10'},'colab':{'provenance': [],'name': 'test (Aug 20, 2024, 3:12:59PM)'}},'nbformat': 4,'nbformat_minor': 5}")
  }
  notebook_runtime_template_resource_name = "projects/bcreddy-sandbox/locations/us-central1/notebookRuntimeTemplates/my_runtime_template"
  
  gcs_output_uri = "gs://bcreddy-notebooks-test"
  
  execution_user = "example@example.com"
  
}
