resource "google_colab_runtime_template" "my_runtime_template" {
  name = "{{index $.Vars "runtime_template_name"}}"
  display_name = "Runtime template basic"
  location = "us-central1"

  machine_spec {
    machine_type     = "e2-standard-4"
  }

  network_spec {
    enable_internet_access = true
  }
}

resource "google_project_iam_member" "colab_enterprise_admin" {
  project = "{{index $.TestEnvVars "project_id"}}"
  role    = "roles/aiplatform.colabEnterpriseAdmin"
  member  = "user:example@example.com"
}

resource "google_storage_bucket" "bucket" {
	name     = "{{index $.Vars "bucket_name"}}"
  location = "US"
}

resource "google_colab_notebook_execution" "{{$.PrimaryResourceId}}" {
  display_name = "Notebook execution basic"
  location = "us-central1"

  notebook_source {
    direct_notebook_source {
     content = '{"cells": [{"cell_type": "code","id":"9fbDnZ6fVT4JriRfUseEFwgX","metadata": {"tags": [],"id":"9fbDnZ6fVT4JriRfUseEFwgX"},"source": ["import numpy asnp"],"execution_count": null,"outputs": []}],"metadata": {"kernelspec":{"display_name": "Python 3","language": "python","name":"python3"},"language_info": {"codemirror_mode": {"name":"ipython","version": 3},"file_extension": ".py","mimetype":"text/x-python","name": "python","nbconvert_exporter":"python","pygments_lexer": "ipython3","version": "3.10.10"},"colab":{"provenance": [],"name": "test (Aug 20, 2024, 3:12:59PM)"}},"nbformat": 4,"nbformat_minor": 5}'
    }
  }

  environment_spec {
    notebook_runtime_template_resource_name = google_colab_runtime_template.my_runtime_template.name
  }
  
  execution_sink {
    gcsOutputUri = google_storage_bucket.bucket.name
  }

  execution_identity {
    execution_user = example@example.com
  }
}
