# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'ServiceConnectionMap'
description:
  'Manage Service Connection Policies.'
references:
  guides:
    'About Service Connectivity Automation': 'https://cloud.google.com/vpc/docs/about-service-connectivity-automation'
  api: 'https://cloud.google.com/network-connectivity/docs/reference/networkconnectivity/rest/v1/projects.locations.serviceConnectionMaps'
docs:
base_url: 'projects/{{project}}/locations/{{location}}/serviceConnectionMaps'
self_link: 'projects/{{project}}/locations/{{location}}/serviceConnectionMaps/{{name}}'
create_url: 'projects/{{project}}/locations/{{location}}/serviceConnectionMaps?serviceConnectionMapId={{name}}'
update_verb: 'PATCH'
update_mask: true
import_format:
  - 'projects/{{project}}/locations/{{location}}/serviceConnectionMaps/{{name}}'
timeouts:
  insert_minutes: 30
  update_minutes: 30
  delete_minutes: 30
autogen_async: true
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
    timeouts:
      insert_minutes: 30
      update_minutes: 30
      delete_minutes: 30
  result:
    resource_inside_response: false
sweeper:
  prefixes:
    - "gcp-memorystore"
  url_substitutions:
    - region: "us-central1"
    - region: "us-east1"
    - region: "europe-west1"
examples:
  - name: 'network_connectivity_map_basic'
    primary_resource_id: 'default'
    vars:
      resource_name: 'my-network-connectivity-map'
      service_class_name: 'my-basic-service-class'
      consumer_network_name: 'consumer-net'
      consumer_subnetwork_name: 'consumer-subnet'
      network_name: 'psc-ilb-network'
      nat_subnetwork_name: 'psc-ilb-nat'
      service_attachment_name: 'my-psc-ilb'
      producer_subnetwork_name: 'psc-ilb-producer-subnetwork'
      producer_health_check_name: 'producer-service-health-check'
      producer_service_name: 'producer-service'
      producer_forwarding_rule_name: 'producer-forwarding-rule'
      consumer_address_name: 'psc-ilb-consumer-address'
      consumer_forwarding_rule_name: 'psc-ilb-consumer-forwarding-rule'
    test_vars_overrides:
      'service_class_name': '"gcp-memorystore-redis"'
    test_env_vars:
      project_id: 'PROJECT_NAME'
parameters:
  - name: 'name'
    type: String
    description: |
      The name of a ServiceConnectionMap.
    url_param_only: true
    required: true
    immutable: true
  - name: 'location'
    type: String
    description: |
      The location of the ServiceConnectionMap.
    url_param_only: true
    required: true
    immutable: true
properties:
  - name: 'createTime'
    type: Time
    description: |
      The timestamp when the resource was created.
    output: true
  - name: 'updateTime'
    type: Time
    description: |
      The timestamp when the resource was updated.
    output: true
  - name: 'labels'
    type: KeyValueLabels
    description: |
      User-defined labels.
  - name: 'description'
    type: String
    description: |
      The description of this resource.
  - name: 'serviceClass'
    type: String
    description: |
      The service class identifier this ServiceConnectionMap is for.
      The user of ServiceConnectionMap create API needs to have networkconnecitivty.serviceclasses.use iam permission for the service class.
      It is provided by the Service Producer. Google services have a prefix of gcp. For example, gcp-cloud-sql. 3rd party services do not. For example, test-service-a3dfcx.
    required: true
    immutable: true
  - name: 'serviceClassUri'
    type: String
    description: |
      The service class uri this ServiceConnectionMap is for.
    output: true
  - name: 'infrastructure'
    type: String
    description: |
      The infrastructure used for connections between consumers/producers.
    output: true
  - name: 'producerPscConfigs'
    type: NestedObject
    description: |
      The PSC configurations on producer side.
    properties:
      - name: 'serviceAttachmentUri'
        type: String
        description: |
          IDs of the subnetworks or fully qualified identifiers for the subnetworks
        required: true
  - name: 'consumerPscConfigs'
    type: NestedObject
    description: |
      The PSC configurations on consumer side.
    properties:
      - name: 'project'
        type: String
        description: |
          The consumer project where PSC connections are allowed to be created in.
      - name: 'network'
        type: String
        description: |
          The resource path of the consumer network where PSC connections are allowed to be created in.
          Note, this network does not need be in the ConsumerPscConfig.project in the case of SharedVPC.
          Example: projects/{projectNumOrId}/global/networks/{networkId}.
      - name: 'disableGlobalAccess'
        type: Boolean
        description: |
          This is used in PSC consumer ForwardingRule to control whether the PSC endpoint can be accessed from another region.
      - name: 'state'
        type: String
        description: |
          Overall state of PSC Connections management for this consumer psc config.
        output: true
      - name: 'serviceAttachmentIpAddressMap'
        type: KeyValuePairs
        description: |
          A map to store mapping between customer vip and target service attachment.
          Only service attachment with producer specified ip addresses are stored here.
        output: true
      - name: 'consumerInstanceProject'
        type: String
        description: |
          The project ID or project number of the consumer project.
          This project is the one that the consumer uses to interact with the producer instance.
          From the perspective of a consumer who's created a producer instance, this is the project of the producer instance.
          Format: 'projects/' Eg. 'projects/consumer-project' or 'projects/1234'
        required: true
      - name: 'producerInstanceMetadata'
        type: KeyValuePairs
        description: |
          An immutable map for the producer instance metadata.
        immutable: true
      - name: 'ipVersion'
        type: Enum
        description: |
          The IP Version that will be used by this address. The default value is `IPV4`.
        diff_suppress_func: 'tpgresource.EmptyOrDefaultStringSuppress("IPV4")'
        enum_values:
          - 'IPV4'
          - 'IPV6'
  - name: 'consumerPscConnections'
    type: NestedObject
    description: |
      PSC connection details on consumer side
    properties:
      - name: 'serviceAttachmentUri'
        type: String
        description: |
          IDs of the subnetworks or fully qualified identifiers for the subnetworks
        output: true
      - name: 'state'
        type: String
        description: |
          The state of the PSC connection.
        output: true
      - name: 'project'
        type: String
        description: |
          The consumer project whose PSC forwarding rule is connected to the service attachments in this service connection map.
        output: true
      - name: 'network'
        type: String
        description: |
          The consumer network whose PSC forwarding rule is connected to the service attachments in this service connection map.
          Note that the network could be on a different project (shared VPC).
        output: true
      - name: 'pscConnectionId'
        type: String
        description: |
          The PSC connection id of the PSC forwarding rule connected to the service attachments in this service connection map.
        output: true
      - name: 'ip'
        type: String
        description: |
          The IP literal allocated on the consumer network for the PSC forwarding rule that is created to connect to the producer service attachment in this service connection map.
        output: true
      - name: 'gceOperation'
        type: String
        description: |
          The last Compute Engine operation to setup PSC connection.
        output: true
      - name: 'forwardingRule'
        type: String
        description: |
          The URI of the consumer forwarding rule created.
          Example: projects/{projectNumOrId}/regions/us-east1/networks/{resourceId}.
        output: true
      - name: 'errorInfo'
        type: NestedObject
        description: |
          The error info for the latest error during operating this connection.
        output: true
        properties:
          - name: 'reason'
            type: String
            description: The reason of the error.
          - name: 'domain'
            type: String
            description: The logical grouping to which the "reason" belongs.
          - name: 'metadata'
            type: KeyValuePairs
            description: |
             Additional structured details about this error.
      - name: 'selectedSubnetwork'
        type: String
        description: |
          The URI of the selected subnetwork selected to allocate IP address for this connection.
        output: true
      - name: 'producerInstanceMetadata'
        type: KeyValuePairs
        description: |
          An immutable map for the producer instance metadata.
        immutable: true
      - name: 'ipVersion'
        type: Enum
        description: |
          The requested IP version for the PSC connection.
        diff_suppress_func: 'tpgresource.EmptyOrDefaultStringSuppress("IPV4")'
        enum_values:
          - 'IPV4'
          - 'IPV6'
  - name: 'etag'
    type: Fingerprint
    description: |
      The etag is computed by the server, and may be sent on update and delete requests to ensure the client has an up-to-date value before proceeding.
    output: true
