# Copyright 2025 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
name: Guardrail
description: Description
base_url: projects/{{project}}/locations/{{location}}/apps/{{app}}/guardrails
update_mask: true
self_link: projects/{{project}}/locations/{{location}}/apps/{{app}}/guardrails/{{name}}
create_url: projects/{{project}}/locations/{{location}}/apps/{{app}}/guardrails?guardrailId={{guardrail_id}}
update_verb: PATCH
id_format: projects/{{project}}/locations/{{location}}/apps/{{app}}/guardrails/{{name}}
import_format:
 - projects/{{project}}/locations/{{location}}/apps/{{app}}/guardrails/{{name}}
examples:
 - name: "ces_guardrail_basic"
   primary_resource_id: "ces_guardrail_basic"
   vars:
    guardrail_display_name: 'my-guardrail'
    app_display_name: 'my-app'
    guardrail_id: 'guardrail-id'
    app_id: 'app-id'
 - name: "ces_guardrail_transfer_agent_content_filter"
   primary_resource_id: "ces_guardrail_transfer_agent_content_filter"
   vars:
    guardrail_display_name: 'my-guardrail'
    app_display_name: 'my-app'
    guardrail_id: 'guardrail-id'
    app_id: 'app-id'
 - name: "ces_guardrail_generative_answer_llm_prompt_security"
   primary_resource_id: "ces_guardrail_generative_answer_llm_prompt_security"
   vars:
    guardrail_display_name: 'my-guardrail'
    app_display_name: 'my-app'
    guardrail_id: 'guardrail-id'
    app_id: 'app-id'
 - name: "ces_guardrail_code_callback"
   primary_resource_id: "ces_guardrail_code_callback"
   vars:
    guardrail_display_name: 'my-guardrail'
    app_display_name: 'my-app'
    guardrail_id: 'guardrail-id'
    app_id: 'app-id'
 - name: "ces_guardrail_llm_policy"
   primary_resource_id: "ces_guardrail_llm_policy"
   vars:
    guardrail_display_name: 'my-guardrail'
    app_display_name: 'my-app'
    guardrail_id: 'guardrail-id'
    app_id: 'app-id'
autogen_status: R3VhcmRyYWls
parameters:
 - name: location
   type: String
   description: Resource ID segment making up resource `name`. It identifies the resource within its parent collection as described in https://google.aip.dev/122.
   immutable: true
   url_param_only: true
   required: true
 - name: app
   type: String
   description: Resource ID segment making up resource `name`. It identifies the resource within its parent collection as described in https://google.aip.dev/122.
   immutable: true
   url_param_only: true
   required: true
 - name: guardrailId
   type: String
   description: |-
    The ID to use for the guardrail, which will become the final component of
    the guardrail's resource name. If not provided, a unique ID will be
    automatically assigned for the guardrail.
   immutable: true
   url_param_only: true
   required: true
properties:
 - name: action
   type: NestedObject
   description: Action that is taken when a certain precondition is met.
   properties:
    - name: generativeAnswer
      type: NestedObject
      description: The agent will immediately respond with a generative answer.
      properties:
       - name: prompt
         type: String
         description: The prompt to use for the generative answer.
         required: true
    - name: respondImmediately
      type: NestedObject
      description: The agent will immediately respond with a preconfigured response.
      properties:
       - name: responses
         type: Array
         description: |-
          The canned responses for the agent to choose from. The response is chosen
          randomly.
         required: true
         item_type:
          type: NestedObject
          properties:
           - name: disabled
             type: Boolean
             description: |-
              Whether the response is disabled. Disabled responses are not used by the
              agent.
           - name: text
             type: String
             description: Text for the agent to respond with.
             required: true
    - name: transferAgent
      type: NestedObject
      description: The agent will transfer the conversation to a different agent.
      properties:
       - name: agent
         type: String
         description: |-
          The name of the agent to transfer the conversation to. The agent must be
          in the same app as the current agent.
          Format:
          `projects/{project}/locations/{location}/apps/{app}/agents/{agent}`
         required: true
 - name: codeCallback
   type: NestedObject
   description: |-
    Guardrail that blocks the conversation based on the code callbacks
    provided.
   properties:
    - name: afterAgentCallback
      type: NestedObject
      description: |-
       A callback defines the custom logic to be executed at various stages of
       agent interaction.
      properties:
       - name: description
         type: String
         description: Human-readable description of the callback.
       - name: disabled
         type: Boolean
         description: |-
          Whether the callback is disabled. Disabled callbacks are ignored by the
          agent.
       - name: pythonCode
         type: String
         description: The python code to execute for the callback.
         required: true
    - name: afterModelCallback
      type: NestedObject
      description: |-
       A callback defines the custom logic to be executed at various stages of
       agent interaction.
      properties:
       - name: description
         type: String
         description: Human-readable description of the callback.
       - name: disabled
         type: Boolean
         description: |-
          Whether the callback is disabled. Disabled callbacks are ignored by the
          agent.
       - name: pythonCode
         type: String
         description: The python code to execute for the callback.
         required: true
    - name: beforeAgentCallback
      type: NestedObject
      description: |-
       A callback defines the custom logic to be executed at various stages of
       agent interaction.
      properties:
       - name: description
         type: String
         description: Human-readable description of the callback.
       - name: disabled
         type: Boolean
         description: |-
          Whether the callback is disabled. Disabled callbacks are ignored by the
          agent.
       - name: pythonCode
         type: String
         description: The python code to execute for the callback.
         required: true
    - name: beforeModelCallback
      type: NestedObject
      description: |-
       A callback defines the custom logic to be executed at various stages of
       agent interaction.
      properties:
       - name: description
         type: String
         description: Human-readable description of the callback.
       - name: disabled
         type: Boolean
         description: |-
          Whether the callback is disabled. Disabled callbacks are ignored by the
          agent.
       - name: pythonCode
         type: String
         description: The python code to execute for the callback.
         required: true
 - name: contentFilter
   type: NestedObject
   description: Guardrail that bans certain content from being used in the conversation.
   properties:
    - name: bannedContents
      type: Array
      description: List of banned phrases. Applies to both user inputs and agent responses.
      item_type:
       type: String
    - name: bannedContentsInAgentResponse
      type: Array
      description: List of banned phrases. Applies only to agent responses.
      item_type:
       type: String
    - name: bannedContentsInUserInput
      type: Array
      description: List of banned phrases. Applies only to user inputs.
      item_type:
       type: String
    - name: disregardDiacritics
      type: Boolean
      description: If true, diacritics are ignored during matching.
    - name: matchType
      type: String
      description: |-
       Match type for the content filter.
       Possible values:
       SIMPLE_STRING_MATCH
       WORD_BOUNDARY_STRING_MATCH
       REGEXP_MATCH
      required: true
 - name: createTime
   type: String
   description: Timestamp when the guardrail was created.
   output: true
 - name: description
   type: String
   description: Description of the guardrail.
 - name: displayName
   type: String
   description: Display name of the guardrail.
   required: true
 - name: enabled
   type: Boolean
   description: Whether the guardrail is enabled.
 - name: etag
   type: String
   description: |-
    Etag used to ensure the object hasn't changed during a read-modify-write
    operation. If the etag is empty, the update will overwrite any concurrent
    changes.
   output: true
 - name: llmPolicy
   type: NestedObject
   description: |-
    Guardrail that blocks the conversation if the LLM response is considered
    violating the policy based on the LLM classification.
   properties:
    - name: failOpen
      type: Boolean
      description: |-
        If an error occurs during the policy check, fail open and do not trigger
        the guardrail.
    - name: maxConversationMessages
      type: Integer
      description: |-
       When checking this policy, consider the last 'n' messages in the
       conversation.
       When not set a default value of 10 will be used.
    - name: modelSettings
      type: NestedObject
      description: Model settings contains various configurations for the LLM model.
      properties:
       - name: model
         type: String
         description: |-
          The LLM model that the agent should use.
          If not set, the agent will inherit the model from its parent agent.
       - name: temperature
         type: Double
         description: |-
          If set, this temperature will be used for the LLM model. Temperature
          controls the randomness of the model's responses. Lower temperatures
          produce responses that are more predictable. Higher temperatures produce
          responses that are more creative.
    - name: policyScope
      type: Enum
      description: |-
       Defines when to apply the policy check during the conversation. If set to
       `POLICY_SCOPE_UNSPECIFIED`, the policy will be applied to the user input.
       When applying the policy to the agent response, additional latency will
       be introduced before the agent can respond.
       Possible values:
       USER_QUERY
       AGENT_RESPONSE
       USER_QUERY_AND_AGENT_RESPONSE
      required: true
      enum_values:
       - USER_QUERY
       - AGENT_RESPONSE
       - USER_QUERY_AND_AGENT_RESPONSE
    - name: prompt
      type: String
      description: Policy prompt.
      required: true
    - name: allowShortUtterance
      type: Boolean
      description: |-
       By default, the LLM policy check is bypassed for short utterances.
       Enabling this setting applies the policy check to all utterances,
       including those that would normally be skipped.
 - name: llmPromptSecurity
   type: NestedObject
   description: |-
    Guardrail that blocks the conversation if the input is considered unsafe
    based on the LLM classification.
   properties:
    - name: customPolicy
      type: NestedObject
      description: |-
       Guardrail that blocks the conversation if the LLM response is considered
       violating the policy based on the LLM classification.
      properties:
       - name: failOpen
         type: Boolean
         description: |-
          If an error occurs during the policy check, fail open and do not trigger
          the guardrail.
       - name: maxConversationMessages
         type: Integer
         description: |-
          When checking this policy, consider the last 'n' messages in the
          conversation.
          When not set a default value of 10 will be used.
       - name: modelSettings
         type: NestedObject
         description: Model settings contains various configurations for the LLM model.
         properties:
          - name: model
            type: String
            description: |-
             The LLM model that the agent should use.
             If not set, the agent will inherit the model from its parent agent.
          - name: temperature
            type: Double
            description: |-
             If set, this temperature will be used for the LLM model. Temperature
             controls the randomness of the model's responses. Lower temperatures
             produce responses that are more predictable. Higher temperatures produce
             responses that are more creative.
       - name: policyScope
         type: String
         description: |-
          Defines when to apply the policy check during the conversation. If set to
          `POLICY_SCOPE_UNSPECIFIED`, the policy will be applied to the user input.
          When applying the policy to the agent response, additional latency will
          be introduced before the agent can respond.
          Possible values:
          USER_QUERY
          AGENT_RESPONSE
          USER_QUERY_AND_AGENT_RESPONSE
         required: true
       - name: prompt
         type: String
         description: Policy prompt.
         required: true
       - name: allowShortUtterance
         type: Boolean
         description: |-
          By default, the LLM policy check is bypassed for short utterances.
          Enabling this setting applies the policy check to all utterances,
          including those that would normally be skipped.
    - name: defaultSettings
      type: NestedObject
      description: Configuration for default system security settings.
      properties:
       - name: defaultPromptTemplate
         type: String
         description: |-
          The default prompt template used by the system.
          This field is for display purposes to show the user what prompt
          the system uses by default. It is OUTPUT_ONLY.
         output: true
 - name: modelSafety
   type: NestedObject
   description: |-
    Model safety settings overrides. When this is set, it will override the
    default settings and trigger the guardrail if the response is considered
    unsafe.
   properties:
    - name: safetySettings
      type: Array
      description: List of safety settings.
      required: true
      item_type:
       type: NestedObject
       properties:
        - name: category
          type: Enum
          description: |-
           The harm category.
           Possible values:
           HARM_CATEGORY_HATE_SPEECH
           HARM_CATEGORY_DANGEROUS_CONTENT
           HARM_CATEGORY_HARASSMENT
           HARM_CATEGORY_SEXUALLY_EXPLICIT
          required: true
          enum_values:
           - HARM_CATEGORY_HATE_SPEECH
           - HARM_CATEGORY_DANGEROUS_CONTENT
           - HARM_CATEGORY_HARASSMENT
           - HARM_CATEGORY_SEXUALLY_EXPLICIT
        - name: threshold
          type: Enum
          description: |-
           The harm block threshold.
           Possible values:
           BLOCK_LOW_AND_ABOVE
           BLOCK_MEDIUM_AND_ABOVE
           BLOCK_ONLY_HIGH
           BLOCK_NONE
           OFF
          required: true
          enum_values:
           - BLOCK_LOW_AND_ABOVE
           - BLOCK_MEDIUM_AND_ABOVE
           - BLOCK_ONLY_HIGH
           - BLOCK_NONE
           - OFF
 - name: name
   type: String
   description: |-
    Identifier. The unique identifier of the guardrail.
    Format:
    `projects/{project}/locations/{location}/apps/{app}/guardrails/{guardrail}`
   output: true
   custom_flatten: 'templates/terraform/custom_flatten/name_from_self_link.tmpl'
 - name: updateTime
   type: String
   description: Timestamp when the guardrail was last updated.
   output: true
