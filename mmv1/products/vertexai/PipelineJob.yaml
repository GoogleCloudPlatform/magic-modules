# Copyright 2023 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

--- !ruby/object:Api::Resource
name: PipelineJob
base_url: projects/{{project}}/locations/{{location}}/pipelineJobs
create_url: projects/{{project}}/locations/{{location}}/pipelineJobs?pipelineJobId={{name}}
self_link: 'projects/{{project}}/locations/{{location}}/pipelineJobs/{{name}}'
immutable: true
references: !ruby/object:Api::Resource::ReferenceLinks
  guides:
    'Official Documentation': 'https://cloud.google.com/vertex-ai/docs'
  api: 'https://cloud.google.com/vertex-ai/docs/reference/rest/v1/projects.locations.pipelineJobs'
async: !ruby/object:Api::OpAsync
  actions:
    - delete
  operation: !ruby/object:Api::OpAsync::Operation
    path: 'name'
    base_url: '{{op_id}}'
    wait_ms: 1000
  result: !ruby/object:Api::OpAsync::Result
    path: 'response'
    resource_inside_response: true
  status: !ruby/object:Api::OpAsync::Status
    path: 'done'
    complete: true
    allowed:
      - true
      - false
  error: !ruby/object:Api::OpAsync::Error
    path: 'error'
    message: 'message'
description:
  'An instance of a machine learning PipelineJob.'
examples:
  - !ruby/object:Provider::Terraform::Examples
    name: 'vertex_ai_pipeline_job_basic'
    primary_resource_id: 'pipeline_job'
    vars:
      pipeline_job_name: 'pipeline-job'
      bucket_name: 'pipeline-job-bucket'
      bucket_object_name: 'pipeline-job-dataset'
custom_code: !ruby/object:Provider::Terraform::CustomCode
  constants: templates/terraform/constants/vertex_ai_pipeline_job.go.erb
  post_create: templates/terraform/post_create/vertex_ai_pipeline_job.go.erb
  post_import: templates/terraform/post_import/vertex_ai_pipeline_job.go.erb
  pre_delete: templates/terraform/pre_delete/vertex_ai_pipeline_job.go.erb
parameters:
  - !ruby/object:Api::Type::String
    name: location
    description: The location for the resource.
    url_param_only: true
    required: true
properties:
  - !ruby/object:Api::Type::String
    name: name
    description:
      The resource name of the Pipeline. This value should be less than 128 characters, and valid characters are /[a-z][0-9]-/
    url_param_only: true
    required: true
  - !ruby/object:Api::Type::String
    name: displayName
    description:
      The display name of the Pipeline. The name can be up to 128 characters long and can consist of any UTF-8 characters.
  - !ruby/object:Api::Type::Enum
    name: state
    description:
      The detailed state of the job.
    output: true
    values:
      - :PIPELINE_STATE_QUEUED
      - :PIPELINE_STATE_PENDING
      - :PIPELINE_STATE_RUNNING
      - :PIPELINE_STATE_SUCCEEDED
      - :PIPELINE_STATE_FAILED
      - :PIPELINE_STATE_CANCELLING
      - :PIPELINE_STATE_CANCELLED
      - :PIPELINE_STATE_PAUSED
  - !ruby/object:Api::Type::KeyValuePairs
    name: labels
    description:
      The labels with user-defined metadata to organize PipelineJob.
      Label keys and values can be no longer than 64 characters (Unicode codepoints), can only contain lowercase letters, numeric characters, underscores and dashes. International characters are allowed.
      See https://goo.gl/xmQnxf for more information and examples of labels.
      Note there is some reserved label key for Vertex AI Pipelines. - vertex-ai-pipelines-run-billing-id, user set value will get overrided.
    diff_suppress_func: 'VertexAIPipelineJobLabelDiffSuppress'
  - !ruby/object:Api::Type::NestedObject
    name: runtimeConfig
    description:
      Runtime config of the pipeline.
    properties:
      - !ruby/object:Api::Type::String
        name: gcsOutputDirectory
        description:
          A path in a Cloud Storage bucket, which will be treated as the root output directory of the pipeline. It is used by the system to generate the paths of output artifacts. The artifact paths are generated with a sub-path pattern {job_id}/{taskId}/{output_key} under the specified output directory. The service account specified in this pipeline must have the storage.objects.get and storage.objects.create permissions for this bucket.
        required: true
      - !ruby/object:Api::Type::KeyValuePairs
        name: parameterValues
        description:
          The runtime parameters of the PipelineJob. The parameters will be passed into PipelineJob.pipeline_spec to replace the placeholders at runtime. This field is used by pipelines built using PipelineJob.pipeline_spec.schema_version 2.1.0, such as pipelines built using Kubeflow Pipelines SDK 1.9 or higher and the v2 DSL.
      - !ruby/object:Api::Type::Enum
        name: failurePolicy
        description:
          Represents the failure policy of a pipeline. Currently, the default of a pipeline is that the pipeline will continue to run until no more tasks can be executed, also known as PIPELINE_FAILURE_POLICY_FAIL_SLOW. However, if a pipeline is set to PIPELINE_FAILURE_POLICY_FAIL_FAST, it will stop scheduling any new tasks when a task has failed. Any scheduled tasks will continue to completion.
        values:
          - :PIPELINE_FAILURE_POLICY_FAIL_SLOW
          - :PIPELINE_FAILURE_POLICY_FAIL_FAST
      - !ruby/object:Api::Type::Map
        name: inputArtifacts
        description:
          The runtime artifacts of the PipelineJob.
        key_name: artifact
        key_description: 
          The input artifact name.
        value_type: !ruby/object:Api::Type::NestedObject
          name: inputArtifact
          description:
            The runtime artifacts of the PipelineJob. The key will be the input artifact name and the value would be one of the InputArtifact.
          properties:
          - !ruby/object:Api::Type::String
            name: 'version'
            description: 
              The type of an input artifact.
  - !ruby/object:Api::Type::NestedObject
    name: encryptionSpec
    description:
      Customer-managed encryption key spec for a pipelineJob. If set, this PipelineJob and all of its sub-resources will be secured by this key.
    properties:
      - !ruby/object:Api::Type::String
        name: kmsKeyName
        description: |
          The Cloud KMS resource identifier of the customer managed encryption key used to protect a resource. Has the form: projects/my-project/locations/my-region/keyRings/my-kr/cryptoKeys/my-key. The key needs to be in the same region as where the compute resource is created.
        required: true
  - !ruby/object:Api::Type::String
    name: serviceAccount
    description:
      The service account that the pipeline workload runs as. If not specified, the Compute Engine default service account in the project will be used. See https://cloud.google.com/compute/docs/access/service-accounts#default_service_account
      Users starting the pipeline must have the iam.serviceAccounts.actAs permission on this service account.
    default_from_api: true
  - !ruby/object:Api::Type::String
    name: network
    description:
      The full name of the Compute Engine network to which the Pipeline Job's workload should be peered. For example, projects/12345/global/networks/myVPC. Format is of the form projects/{project}/global/networks/{network}. Where {project} is a project number, as in 12345, and {network} is a network name.

      Private services access must already be configured for the network. Pipeline job will apply the network configuration to the Google Cloud resources being launched, if applied, such as Vertex AI Training or Dataflow job. If left unspecified, the workload is not peered with any network.
  - !ruby/object:Api::Type::String
    name: templateUri
    description:
      A template uri from where the PipelineJob.pipeline_spec, if empty, will be downloaded.
  - !ruby/object:Api::Type::NestedObject
    name: templateMetadata
    description:
      Pipeline template metadata. Will fill up fields if PipelineJob.template_uri is from supported template registry.
    output: true
    properties:
      - !ruby/object:Api::Type::String
        name: version
        description:
          The version_name in artifact registry.
          Will always be presented in output if the PipelineJob.template_uri is from supported template registry.
          Format is "sha256:abcdef123456...".
        output: true
  - !ruby/object:Api::Type::String
    name: scheduleName
    description:
      The schedule resource name. Only returned if the Pipeline is created by Schedule API.
    output: true
