# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'RegionBackendBucket'
kind: 'compute#backendBucket'
description: |
  Regional backend buckets allow you to use Google Cloud Storage buckets with
  regional HTTP(S) load balancing.

  A regional HTTP(S) load balancer can direct traffic to specified URLs to a
  backend bucket rather than a backend service. It can send requests for
  static content to a Cloud Storage bucket and requests for dynamic content
  to a virtual machine instance.

  Regional backend buckets are used with:
  - Regional internal Application Load Balancers
  - Regional external Application Load Balancers

  ~> **Note:** Regional backend buckets have important limitations:
  - Cloud CDN cannot be enabled
  - Only public buckets are supported (private bucket access is not available)
  - Only GET requests are supported
  - The bucket must be in the same region as the load balancer
  - Single-region buckets only (multi-region and dual-region buckets are not supported)
references:
  guides:
    'Using a Cloud Storage bucket as a load balancer backend': 'https://cloud.google.com/compute/docs/load-balancing/http/backend-bucket'
  api: 'https://cloud.google.com/compute/docs/reference/v1/regionBackendBuckets'
docs:
base_url: 'projects/{{project}}/regions/{{region}}/backendBuckets'
has_self_link: true
timeouts:
  insert_minutes: 20
  update_minutes: 20
  delete_minutes: 20
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
  result:
    resource_inside_response: false
collection_url_key: 'items'
iam_policy:
  allowed_iam_role: 'roles/compute.admin'
  parent_resource_attribute: 'name'
  iam_conditions_request_type: 'QUERY_PARAM'
  import_format:
    - 'projects/{{project}}/regions/{{region}}/backendBuckets/{{name}}'
    - '{{name}}'
  min_version: 'beta'
sweeper:
  url_substitutions:
    - region: "us-central1"
    - region: "us-east1"
    - region: "europe-west1"
examples:
  - name: 'region_backend_bucket_basic'
    primary_resource_id: 'image_backend'
    primary_resource_name: 'fmt.Sprintf("tf-test-region-image-backend-bucket%s", context["random_suffix"])'
    vars:
      backend_bucket_name: 'region-image-backend-bucket'
      bucket_name: 'region-image-store-bucket'
      region: 'us-central1'
  - name: 'region_backend_bucket_internal_lb'
    primary_resource_id: 'internal_backend'
    vars:
      backend_bucket_name: 'regional-internal-backend'
      bucket_name: 'regional-internal-bucket'
      region: 'us-central1'
  - name: 'region_backend_bucket_external_lb'
    primary_resource_id: 'external_backend'
    vars:
      backend_bucket_name: 'regional-external-backend'
      bucket_name: 'regional-external-bucket'
      region: 'us-east1'
parameters:
  - name: 'region'
    type: ResourceRef
    description: |
      The region where the backend bucket resides.
    required: true
    immutable: true
    resource: 'region'
    imports: 'name'
    url_param_only: true
properties:
  - name: 'bucketName'
    type: String
    description: |
      Cloud Storage bucket name. The bucket must be in the same region as this
      backend bucket.
    required: true
  - name: 'creationTimestamp'
    type: Time
    description: 'Creation timestamp in RFC3339 text format.'
    output: true
  - name: 'description'
    type: String
    description: |
      An optional textual description of the resource; provided by the
      client when the resource is created.
  - name: 'name'
    type: String
    description: |
      Name of the resource. Provided by the client when the resource is
      created. The name must be 1-63 characters long, and comply with
      RFC1035.  Specifically, the name must be 1-63 characters long and
      match the regular expression `[a-z]([-a-z0-9]*[a-z0-9])?` which means
      the first character must be a lowercase letter, and all following
      characters must be a dash, lowercase letter, or digit, except the
      last character, which cannot be a dash.
    required: true
    immutable: true
    validation:
      regex: '^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$'
  - name: 'loadBalancingScheme'
    type: Enum
    description: |
      Specifies the load balancer type this backend bucket will be used with.

      Possible values:
      - 'INTERNAL_MANAGED': for regional internal Application Load Balancers
      - 'EXTERNAL_MANAGED': for regional external Application Load Balancers

      This field is required for regional backend buckets.
    enum_values:
      - 'INTERNAL_MANAGED'
      - 'EXTERNAL_MANAGED'
    required: false
    default_from_api: true
