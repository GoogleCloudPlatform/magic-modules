# Copyright 2023 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

--- !ruby/object:Api::Resource
name: 'RegionSecurityPolicy'
base_url: projects/{{project}}/regions/{{region}}/securityPolicies
collection_url_key: 'items'
has_self_link: true
description: |
  Represents a Region Cloud Armor Security Policy resource.
references: !ruby/object:Api::Resource::ReferenceLinks
  guides:
    'Official Documentation': 'https://cloud.google.com/armor/docs/security-policy-concepts'
  api: 'https://cloud.google.com/compute/docs/reference/rest/v1/regionSecurityPolicies'
async: !ruby/object:Api::OpAsync
  operation: !ruby/object:Api::OpAsync::Operation
    kind: 'compute#operation'
    path: 'name'
    base_url: 'projects/{{project}}/regions/{{region}}/operations/{{op_id}}'
    wait_ms: 1000
  result: !ruby/object:Api::OpAsync::Result
    path: 'targetLink'
  status: !ruby/object:Api::OpAsync::Status
    path: 'status'
    complete: 'DONE'
    allowed:
      - 'PENDING'
      - 'RUNNING'
      - 'DONE'
  error: !ruby/object:Api::OpAsync::Error
    path: 'error/errors'
    message: 'message'
parameters:
  - !ruby/object:Api::Type::ResourceRef
    name: 'region'
    resource: 'Region'
    imports: 'name'
    required: false
    immutable: true
    description: |
      The Region in which the created Region Security Policy should reside.
      If it is not provided, the provider region is used.
    default_from_api: true
    # TODO(felipegc) we may evaluate what is this and if this might be necessary.
    # custom_flatten: 'templates/terraform/custom_flatten/name_from_self_link.erb'
properties:
  - !ruby/object:Api::Type::String
    name: 'name'
    description: 'Name of the resource. Provided by the client when the resource is created. The name must be 1-63 characters long, and comply with RFC1035.
    Specifically, the name must be 1-63 characters long and match the regular expression [a-z]([-a-z0-9]*[a-z0-9])? which means the first character must be a lowercase letter, and all following characters must be a dash, lowercase letter, or digit, except the last character, which cannot be a dash.'
    required: true
  - !ruby/object:Api::Type::Integer
    name: 'id'
    description: 'The unique identifier for the resource. This identifier is defined by the server.'
    output: true
  - !ruby/object:Api::Type::Array
    name: 'rules'
    description: |
      A list of rules that belong to this policy.
      There must always be a default rule which is a rule with priority 2147483647 and match all condition (for the match condition this means match "*" for srcIpRanges and for the networkMatch condition every field must be either match "*" or not set).
      If no rules are provided when creating a security policy, a default rule with action "allow" will be added.
    item_type: !ruby/object:Api::Type::NestedObject
      properties:
        - !ruby/object:Api::Type::String
          name: 'description'
          description: |
            An optional description of this resource. Provide this property when you create the resource.
        - !ruby/object:Api::Type::Integer
          name: 'priority'
          description: |
            An integer indicating the priority of a rule in the list. The priority must be a positive value between 0 and 2147483647.
            Rules are evaluated from highest to lowest priority where 0 is the highest priority and 2147483647 is the lowest priority.
        - !ruby/object:Api::Type::String
          name: 'action'
          description: |
            The Action to perform when the rule is matched. The following are the valid actions: 
            - allow: allow access to target.
            - deny(STATUS): deny access to target, returns the HTTP response code specified. Valid values for `STATUS` are 403, 404, and 502. 
            - rate_based_ban: limit client traffic to the configured threshold and ban the client if the traffic exceeds the threshold. Configure parameters for this action in RateLimitOptions. Requires rate_limit_options to be set. 
            - redirect: redirect to a different target. This can either be an internal reCAPTCHA redirect, or an external URL-based redirect via a 302 response. Parameters for this action can be configured via redirectOptions. This action is only supported in Global Security Policies of type CLOUD_ARMOR.
            - throttle: limit client traffic to the configured threshold. Configure parameters for this action in rateLimitOptions. Requires rate_limit_options to be set for this.
        - !ruby/object:Api::Type::Boolean
          name: 'preview'
          description: |
            If set to true, the specified action is not enforced.
        # TODO(felipegc) finish all objects
  - !ruby/object:Api::Type::Enum
    name: 'type'
    immutable: true
    description: |
      The type indicates the intended use of the security policy.
      - CLOUD_ARMOR: Cloud Armor backend security policies can be configured to filter incoming HTTP requests targeting backend services. They filter requests before they hit the origin servers.
      - CLOUD_ARMOR_EDGE: Cloud Armor edge security policies can be configured to filter incoming HTTP requests targeting backend services (including Cloud CDN-enabled) as well as backend buckets (Cloud Storage). They filter requests before the request is served from Google's cache.
      - CLOUD_ARMOR_NETWORK: Cloud Armor network policies can be configured to filter packets targeting network load balancing resources such as backend services, target pools, target instances, and instances with external IPs. They filter requests before the request is served from the application.
      This field can be set only at resource creation time.
    values:
      - :CLOUD_ARMOR
      - :CLOUD_ARMOR_EDGE
      - :CLOUD_ARMOR_NETWORK
  - !ruby/object:Api::Type::NestedObject
      name: 'ddosProtectionConfig'
      description: |
        TODO(felipegc) we should add a useful description here since the current api does not have it.
      properties:
        - !ruby/object:Api::Type::Enum
          name: 'ddosProtection'
          description: | 
            TODO(felipegc) we should add a useful description here since the current api does not have it.
          values:
            - :ADVANCED
            - :STANDARD