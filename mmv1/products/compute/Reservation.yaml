# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'Reservation'
api_resource_type_kind: Allocation
description: |
  Represents a reservation resource. A reservation ensures that capacity is
  held in a specific zone even if the reserved VMs are not running.

  Reservations apply only to Compute Engine, Cloud Dataproc, and Google
  Kubernetes Engine VM usage.Reservations do not apply to `f1-micro` or
  `g1-small` machine types, preemptible VMs, sole tenant nodes, or other
  services not listed above
  like Cloud SQL and Dataflow.
references:
  guides:
    'Reserving zonal resources': 'https://cloud.google.com/compute/docs/instances/reserving-zonal-resources'
  api: 'https://cloud.google.com/compute/docs/reference/rest/v1/reservations'
docs:
base_url: 'projects/{{project}}/zones/{{zone}}/reservations'
has_self_link: true
update_url: 'projects/{{project}}/zones/{{zone}}/reservations/{{name}}'
update_verb: 'PATCH'
update_mask: true
timeouts:
  insert_minutes: 20
  update_minutes: 20
  delete_minutes: 20
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
  result:
    resource_inside_response: false
collection_url_key: 'items'
custom_code:
  constants: 'templates/terraform/constants/reservation.go.tmpl'
  update_encoder: 'templates/terraform/update_encoder/reservation.go.tmpl'
  pre_update: 'templates/terraform/pre_update/shared_reservation_update.go.tmpl'
  post_read: templates/terraform/post_read/compute_reservetion.go.tmpl
sweeper:
  url_substitutions:
    - zone: "us-central1-a"
    - zone: "us-west1-a"
    - zone: "us-central1-f"
examples:
  - name: 'reservation_basic'
    primary_resource_id: 'gce_reservation'
    vars:
      reservation_name: 'gce-reservation'
  - name: 'reservation_basic_beta'
    primary_resource_id: 'gce_reservation'
    vars:
      reservation_name: 'gce-reservation'
    min_version: 'beta'
  - name: 'reservation_source_instance_template'
    primary_resource_id: 'gce_reservation_source_instance_template'
    vars:
      instance-template: 'instance-template'
      reservation_name: 'gce-reservation-source-instance-template'
  - name: 'reservation_sharing_policy'
    primary_resource_id: 'gce_reservation_sharing_policy'
    vars:
      instance-template: 'instance-template'
      reservation_name: 'gce-reservation-sharing-policy'
  - name: 'shared_reservation_basic'
    primary_resource_id: 'gce_reservation'
    vars:
      reservation_name: 'gce-shared-reservation'
    test_env_vars:
      project: 'PROJECT_NAME'
      org_id: 'ORG_ID'
      billing_account: 'BILLING_ACCT'
    exclude_docs: true
    external_providers: ["time"]
  - name: 'shared_reservation_beta'
    primary_resource_id: 'gce_reservation'
    vars:
      reservation_name: 'gce-shared-reservation-beta'
    test_env_vars:
      project: 'PROJECT_NAME'
      org_id: 'ORG_ID'
      billing_account: 'BILLING_ACCT'
    exclude_docs: true
    min_version: 'beta'
    external_providers: ["time"]
virtual_fields:
  - name: 'block_names'
    type: Array
    description: |
      List of all reservation block names in the parent reservation.
    output: true
    item_type:
      type: String
parameters:
  - name: 'zone'
    type: ResourceRef
    description: |
      The zone where the reservation is made.
    required: true
    immutable: true
    custom_expand: 'templates/terraform/custom_expand/resourceref_with_validation.go.tmpl'
    resource: 'Zone'
    imports: 'name'
properties:
  - name: 'creationTimestamp'
    type: Time
    description: |
      Creation timestamp in RFC3339 text format.
    output: true
  - name: 'description'
    type: String
    description: |
      An optional description of this resource.
    immutable: true
  - name: 'name'
    type: String
    description: |
      Name of the resource. Provided by the client when the resource is
      created. The name must be 1-63 characters long, and comply with
      RFC1035. Specifically, the name must be 1-63 characters long and match
      the regular expression `[a-z]([-a-z0-9]*[a-z0-9])?` which means the
      first character must be a lowercase letter, and all following
      characters must be a dash, lowercase letter, or digit, except the last
      character, which cannot be a dash.
    required: true
    immutable: true
  - name: 'commitment'
    type: String
    description: |
      Full or partial URL to a parent commitment. This field displays for
      reservations that are tied to a commitment.
    output: true
  - name: 'specificReservationRequired'
    type: Boolean
    description: |
      When set to true, only VMs that target this reservation by name can
      consume this reservation. Otherwise, it can be consumed by VMs with
      affinity for any reservation. Defaults to false.
    immutable: true
    # Not a hard API default, but this should help avoid a unset/true/false
    # trinary.
    default_value: false
  - name: 'status'
    type: String
    description: |
      The status of the reservation.
    output: true
  - name: 'shareSettings'
    type: NestedObject
    description: |
      The share setting for reservations.
    ignore_read: true
    default_from_api: true
    properties:
      - name: 'shareType'
        type: Enum
        description: |
          Type of sharing for this shared-reservation
        immutable: true
        default_from_api: true
        enum_values:
          - 'LOCAL'
          - 'SPECIFIC_PROJECTS'
      - name: 'projectMap'
        type: Map
        description: |
          A map of project number and project config. This is only valid when shareType's value is SPECIFIC_PROJECTS.
        key_name: 'id'
        value_type:
          type: NestedObject
          properties:
            - name: 'projectId'
              type: String
              description: |
                The project id/number, should be same as the key of this project config in the project map.
      - name: 'projects'
        type: Array
        description: |
          List of project IDs with which the reservation is shared.
        item_type:
          type: String
        min_version: 'beta'
  - name: 'specificReservation'
    type: NestedObject
    description: |
      Reservation for instances with specific machine shapes.
    required: true
    update_url: 'projects/{{project}}/zones/{{zone}}/reservations/{{name}}/resize'
    update_verb: 'POST'
    properties:
      - name: 'count'
        type: Integer
        description: |
          The number of resources that are allocated.
        required: true
        validation:
          function: 'validation.IntAtLeast(1)'
      - name: 'inUseCount'
        type: Integer
        description: |
          How many instances are in use.
        output: true
      - name: 'assuredCount'
        type: Integer
        description: |
          Indicates how many instances are actually usable currently.
        output: true
      - name: 'instanceProperties'
        type: NestedObject
        description: |
          The instance properties for the reservation.
        immutable: true
        default_from_api: true
        exactly_one_of:
          - 'specific_reservation.0.instance_properties'
          - 'specific_reservation.0.source_instance_template'
        properties:
          - name: 'machineType'
            type: String
            description: |
              The name of the machine type to reserve.
            required: true
            immutable: true
          - name: 'minCpuPlatform'
            type: String
            description: |
              The minimum CPU platform for the reservation. For example,
              `"Intel Skylake"`. See
              the CPU platform availability reference](https://cloud.google.com/compute/docs/instances/specify-min-cpu-platform#availablezones)
              for information on available CPU platforms.
            immutable: true
            default_from_api: true
          - name: 'guestAccelerators'
            type: Array
            description: |
              Guest accelerator type and count.
            immutable: true
            item_type:
              type: NestedObject
              properties:
                - name: 'acceleratorType'
                  type: String
                  description: |
                    The full or partial URL of the accelerator type to
                    attach to this instance. For example:
                    `projects/my-project/zones/us-central1-c/acceleratorTypes/nvidia-tesla-p100`

                    If you are creating an instance template, specify only the accelerator name.
                  required: true
                  immutable: true
                - name: 'acceleratorCount'
                  type: Integer
                  description: |
                    The number of the guest accelerator cards exposed to
                    this instance.
                  required: true
                  immutable: true
          - name: 'localSsds'
            type: Array
            description: |
              The amount of local ssd to reserve with each instance. This
              reserves disks of type `local-ssd`.
            immutable: true
            item_type:
              type: NestedObject
              properties:
                - name: 'interface'
                  type: Enum
                  description: |
                    The disk interface to use for attaching this disk.
                  immutable: true
                  default_value: "SCSI"
                  enum_values:
                    - 'SCSI'
                    - 'NVME'
                - name: 'diskSizeGb'
                  type: Integer
                  description: |
                    The size of the disk in base-2 GB.
                  required: true
                  immutable: true
          - name: 'maintenanceInterval'
            type: Enum
            description: |
              Specifies the frequency of planned maintenance events.
            enum_values:
              - 'AS_NEEDED'
              - 'PERIODIC'
              - 'RECURRENT'
            min_version: 'beta'
            immutable: true
          - name: 'locationHint'
            type: String
            description: |
              An opaque location hint used to place the allocation close to other resources. This field is for use by internal tools that use the public API.
            output: true
      - name: 'sourceInstanceTemplate'
        type: String
        description: |
          Specifies the instance template to create the reservation. If you use this field, you must exclude the
          instanceProperties field.
        exactly_one_of:
          - 'specific_reservation.0.instance_properties'
          - 'specific_reservation.0.source_instance_template'
  - name: 'deleteAtTime'
    type: String
    description: |
      Absolute time in future when the reservation will be auto-deleted by Compute Engine. Timestamp is represented in RFC3339 text format.
      Cannot be used with delete_after_duration.
    immutable: true
    default_from_api: true
    conflicts:
      - 'delete_after_duration.0.seconds'
      - 'delete_after_duration.0.nanos'
  - name: 'deleteAfterDuration'
    type: NestedObject
    description: |
      Duration after which the reservation will be auto-deleted by Compute Engine. Cannot be used with delete_at_time.
    ignore_read: true
    properties:
      - name: 'seconds'
        type: String
        description: |
          Number of seconds for the auto-delete duration.
        immutable: true
        conflicts:
          - 'delete_at_time'
      - name: 'nanos'
        type: Integer
        description: |
          Number of nanoseconds for the auto-delete duration.
        immutable: true
        conflicts:
          - 'delete_at_time'
  - name: 'reservationSharingPolicy'
    type: NestedObject
    description: |
      Sharing policy for reservations with Google Cloud managed services.
    default_from_api: true
    properties:
      - name: 'serviceShareType'
        type: Enum
        description: |
          Sharing config for all Google Cloud services.
        enum_values:
          - 'ALLOW_ALL'
          - 'DISALLOW_ALL'
        default_from_api: true
        immutable: true
  - name: 'enableEmergentMaintenance'
    type: Boolean
    description: |
      Indicates if this group of VMs have emergent maintenance enabled.
    immutable: true
    ignore_read: true
    min_version: 'beta'
  - name: 'reservationBlockCount'
    type: Integer
    description: |
      The number of reservation blocks associated with this reservation.
    output: true
  - name: 'kind'
    type: String
    description: |
      Type of the resource. Always compute#reservations for reservations.
    output: true
  - name: 'id'
    type: String
    description: |
      The unique identifier for the resource. This identifier is defined by the server.
    output: true
  - name: 'linkedCommitments'
    type: Array
    description: |
      Full or partial URL to parent commitments. This field displays for reservations that are tied to multiple commitments.
    output: true
    item_type:
      type: String
  - name: 'satisfiesPzs'
    type: Boolean
    description: |
      Reserved for future use.
    output: true
  - name: 'resourceStatus'
    type: NestedObject
    description: |
      Status information for Reservation resource.
    output: true
    properties:
      - name: 'specificSkuAllocation'
        type: NestedObject
        description: |
          Allocation Properties of this reservation.
        output: true
        properties:
          - name: 'sourceInstanceTemplateId'
            type: String
            description: |
              ID of the instance template used to populate reservation properties.
            output: true
          - name: 'utilizations'
            type: KeyValuePairs
            description: |
              Per service utilization breakdown. The Key is the Google Cloud managed service name.
            output: true
      - name: 'reservationMaintenance'
        type: NestedObject
        description: |
          Maintenance information for this reservation
        output: true
        properties:
          - name: 'upcomingGroupMaintenance'
            type: NestedObject
            description: |
              Maintenance information on this group of VMs.
            output: true
            properties:
              - name: 'type'
                type: Enum
                description: |
                  Defines the type of maintenance.
                output: true
                enum_values:
                  - 'SCHEDULED'
                  - 'UNSCHEDULED'
              - name: 'canReschedule'
                type: Boolean
                description: |
                  Indicates if the maintenance can be customer triggered.
                output: true
              - name: 'windowStartTime'
                type: String
                description: |
                  The current start time of the maintenance window. This timestamp value is in RFC3339 text format.
                output: true
              - name: 'windowEndTime'
                type: String
                description: |
                  The time by which the maintenance disruption will be completed. This timestamp value is in RFC3339 text format.
                output: true
              - name: 'latestWindowStartTime'
                type: String
                description: |
                  The latest time for the planned maintenance window to start. This timestamp value is in RFC3339 text format.
                output: true
              - name: 'maintenanceStatus'
                type: Enum
                description: |
                  Status of the maintenance.
                output: true
                enum_values:
                  - 'PENDING'
                  - 'ONGOING'
                  - 'COMPLETED'
              - name: 'maintenanceOnShutdown'
                type: Boolean
                description: |
                  Indicates whether the UpcomingMaintenance will be triggered on VM shutdown.
                output: true
              - name: 'maintenanceReasons'
                type: Array
                description: |
                  The reasons for the maintenance. Only valid for vms.
                output: true
                item_type:
                  type: Enum
                  enum_values:
                    - 'UNKNOWN_REASON'
                    - 'HOST_MAINTENANCE'
          - name: 'maintenanceOngoingCount'
            type: Integer
            description: |
              Progress for ongoing maintenance for this group of VMs/hosts. Describes number of hosts in the block that have ongoing maintenance.
            output: true
          - name: 'maintenancePendingCount'
            type: Integer
            description: |
              Progress for ongoing maintenance for this group of VMs/hosts. Describes number of hosts in the block that have pending maintenance.
            output: true
          - name: 'schedulingType'
            type: Enum
            description: |
              The type of maintenance for the reservation.
            output: true
            enum_values:
              - 'PERIODIC'
              - 'AS_NEEDED'
          - name: 'subblockInfraMaintenanceOngoingCount'
            type: Integer
            description: |
              Describes number of subblock Infrastructure that has ongoing maintenance. Here, Subblock Infrastructure Maintenance pertains to upstream hardware contained in the Subblock that is necessary for a VM Family(e.g. NVLink Domains). Not all VM Families will support this field.
            output: true
          - name: 'subblockInfraMaintenancePendingCount'
            type: Integer
            description: |
              Describes number of subblock Infrastructure that has pending maintenance. Here, Subblock Infrastructure Maintenance pertains to upstream hardware contained in the Subblock that is necessary for a VM Family (e.g. NVLink Domains). Not all VM Families will support this field.
            output: true
          - name: 'instanceMaintenanceOngoingCount'
            type: Integer
            description: |
              Describes number of instances that have ongoing maintenance.
            output: true
          - name: 'instanceMaintenancePendingCount'
            type: Integer
            description: |
              Describes number of instances that have pending maintenance.
            output: true
      - name: 'reservationBlockCount'
        type: Integer
        description: |
          The number of reservation blocks associated with this reservation.
        output: true
      - name: 'healthInfo'
        type: NestedObject
        description: |
          Health information for the reservation.
        output: true
        properties:
          - name: 'healthStatus'
            type: Enum
            description: |
              The health status of the reservation.
            output: true
            enum_values:
              - 'HEALTHY'
              - 'DEGRADED'
              - 'UNHEALTHY'
          - name: 'healthyBlockCount'
            type: Integer
            description: |
              The number of reservation blocks that are healthy.
            output: true
          - name: 'degradedBlockCount'
            type: Integer
            description: |
              The number of reservation blocks that are degraded.
            output: true
