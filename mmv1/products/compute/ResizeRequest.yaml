# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

--- !ruby/object:Api::Resource
# API resource name
name: 'ResizeRequest'
kind: 'compute#instanceGroupManagerResizeRequest'
description: |
  Represents a Managed Instance Group Resize Request

  Resize Requests are the Managed Instance Group implementation of Dynamic Workload Scheduler Flex Start. 

  With Dynamic Workload Scheduler in Flex Start mode, you submit a GPU capacity request for your AI/ML jobs by indicating how many you need, a duration, and your preferred region. Dynamic Workload Scheduler intelligently persists the request; once the capacity becomes available, it automatically provisions your VMs enabling your workloads to run continuously for the entire duration of the capacity allocation.
references: !ruby/object:Api::Resource::ReferenceLinks
  guides:
   # Link to quickstart in the API's Guides section. For example:
   # 'Create and connect to a database': 'https://cloud.google.com/alloydb/docs/quickstart/create-and-connect'
    'QUICKSTART_TITLE': 'https://cloud.google.com/compute/docs/instance-groups/create-resize-requests-mig'
  # Link to the REST API reference for the resource. For example,
  # https://cloud.google.com/alloydb/docs/reference/rest/v1/projects.locations.backups
  api: 'https://cloud.google.com/compute/docs/reference/rest/beta/instanceGroupManagerResizeRequests'
# Marks the resource as beta-only. Ensure a beta version block is present in
# provider.yaml.
min_version: beta
base_url: 'projects/{{project}}/zones/{{zone}}/instanceGroupManagers/{{instanceGroupManager}}/resizeRequests'
self_link: 'projects/{{project}}/zones/{{zone}}/instanceGroupManagers/{{instanceGroupManager}}/resizeRequests/{{resizeRequest}}'


# If true, the resource and all its fields are considered immutable - that is,
# only creatable, not updatable. Individual fields can override this if they
# have a custom update method in the API.
# immutable: true

create_url: 'projects/{{project}}/zones/{{zone}}/instanceGroupManagers/{{instanceGroupManager}}/resizeRequests?requestId={{requestId}}'
create_verb: :POST

# Overrides the URL for the resource's standard Update method. (If unset, the
# self_link URL is used by default.) https://google.aip.dev/134
# Terraform field names enclosed in double curly braces are replaced with
# the field values from the resource at runtime.
# update_url: 'projects/{{project}}/locations/{{location}}/resourcenames/{{name}}'
# The HTTP verb used to update a resource. Allowed values: :POST, :PUT, :PATCH. Default: :PUT.
##update_verb: :PATCH
# If true, the resource sets an `updateMask` query parameter listing modified
# fields when updating the resource. If false, it does not.
##update_mask: true

# Overrides the URL for the resource's standard Delete method. (If unset, the
# self_link URL is used by default.) https://google.aip.dev/135
# Terraform field names enclosed in double curly braces are replaced with
# the field values from the resource at runtime.
# delete_url: 'projects/{{project}}/locations/{{location}}/resourcenames/{{name}}'
# Overrides the HTTP verb used to delete a resource.
# Allowed values: :POST, :PUT, :PATCH, :DELETE. Default: :DELETE
# delete_verb: :DELETE

# If true, code for handling long-running operations is generated along with
# the resource. If false, that code is not generated.
autogen_async: true
# Sets parameters for handling operations returned by the API.
async: !ruby/object:Api::OpAsync
  # Overrides which API calls return operations. Default: ['create',
  # 'update', 'delete']
  # actions: ['create', 'update', 'delete']
  operation: !ruby/object:Api::OpAsync::Operation
    kind: 'compute#operation'
    path: 'name'
    base_url: 'projects/{{project}}/zones/{{zone}}/operations/{{op_id}}'
    wait_ms: 1000
  result: !ruby/object:Api::OpAsync::Result
    path: 'targetLink'
  status: !ruby/object:Api::OpAsync::Status
    path: 'status'
    complete: 'DONE'
    allowed:
      - 'PENDING'
      - 'RUNNING'
      - 'DONE'
  error: !ruby/object:Api::OpAsync::Error
    path: 'error/errors'
    message: 'message'

  # If true, the provider sets the resource's Terraform ID after the resource is created,
  # taking into account values that are set by the API at create time. This is only possible
  # when the completed operation's JSON includes the created resource in the "response" field.
  # If false (or unset), the provider sets the resource's Terraform ID before the resource is
  # created, based only on the resource configuration.
  # result: !ruby/object:Api::OpAsync::Result
  #   resource_inside_response: true

# All resources (of all kinds) that share a mutex value block rather than
# executing concurrent API requests.
# Terraform field names enclosed in double curly braces are replaced with
# the field values from the resource at runtime.
# mutex: RESOURCE_NAME/{{name}}

parameters:
  - !ruby/object:Api::Type::ResourceRef
    name: 'zone'
    resource: 'Zone'
    imports: 'name'
    description: |
      Zone where the containing instance group manager is located
    required: false
    url_param_only: true
    immutable: true
    ignore_read: true
    default_from_api: true
  - !ruby/object:Api::Type::ResourceRef
    name: 'instanceGroupManager'
    resource: 'InstanceGroupManager'
    imports: 'name'
    description: |
      The instance group manager this instance config is part of.
    required: true
    url_param_only: true
    immutable: true  

properties:
  - !ruby/object:Api::Type::Time
    name: 'creationTimestamp'
    description: 'Creation timestamp in RFC3339 text format.'
    output: true
  - !ruby/object:Api::Type::String
    name: 'name'
    description: |
      Name of the resize-request.
    required: true
    immutable: true
  - !ruby/object:Api::Type::String
    name: 'description'
    description: |
      An optional description of this resize-request.
  - !ruby/object:Api::Type::Integer
    name: 'count'
    description: |
      TBD.
    required: true
  - !ruby/object:Api::Type::Integer
    name: 'resizeBy'
    description: |
      The maximum number of instances to scale to.
    required: true
  - !ruby/object:Api::Type::NestedObject
      name: 'requestedRunDuration'
      description: |
        How long the instances should be provisioned for.
      required: true
      properties:
        - !ruby/object:Api::Type::String
          name: 'seconds'
          description: |
            Seconds
        - !ruby/object:Api::Type::Integer
          name: 'nanos'
          api_name: minNumReplicas
          description: |
            nanos
  - !ruby/object:Api::Type::Enum
    name: 'state'
    api_name: 'utilizationTargetType'
    description: |
      State of the resize request
    values:
      - :GAUGE
      - :DELTA_PER_SECOND
      - :DELTA_PER_MINUTE