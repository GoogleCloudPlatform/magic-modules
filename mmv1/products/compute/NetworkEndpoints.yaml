# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'NetworkEndpoints'
kind: 'compute#networkEndpoints'
description: |
  A set of network endpoints belonging to a network endpoint group (NEG). A
  single network endpoint represents a IP address and port combination that is
  part of a specific network endpoint group  (NEG). NEGs are zonal collections
  of these endpoints for GCP resources within a single subnet. **NOTE**:
  Network endpoints cannot be created outside of a network endpoint group.

  This resource is authoritative for a single NEG. Any endpoints not specified
  by this resource will be deleted when the resource configuration is applied.

  -> **NOTE** In case the Endpoint's Instance is recreated, it's needed to
  perform `apply` twice. To avoid situations like this, please use this resource
  with the lifecycle `replace_triggered_by` method, with the passed Instance's ID.
references:
  guides:
    'Official Documentation': 'https://cloud.google.com/load-balancing/docs/negs/'
  api: 'https://cloud.google.com/compute/docs/reference/rest/beta/networkEndpointGroups'
docs:
id_format: '{{project}}/{{zone}}/{{network_endpoint_group}}'
base_url: 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}'
self_link: 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}/listNetworkEndpoints'
create_url: 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}/attachNetworkEndpoints'
update_url: 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}/attachNetworkEndpoints'
update_verb: 'POST'
read_verb: 'POST'
delete_url: 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}/detachNetworkEndpoints'
delete_verb: 'POST'
mutex: 'networkEndpoint/{{project}}/{{zone}}/{{network_endpoint_group}}'
import_format:
  - 'projects/{{project}}/zones/{{zone}}/networkEndpointGroups/{{network_endpoint_group}}'
timeouts:
  insert_minutes: 20
  update_minutes: 20
  delete_minutes: 20
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
    kind: 'compute#operation'
    path: 'name'
    wait_ms: 1000
  result:
    path: 'targetLink'
    resource_inside_response: false
  error:
    path: 'error/errors'
    message: 'message'
identity:
  - networkEndpointGroup
custom_code:
  constants: 'templates/terraform/constants/network_endpoints.go.tmpl'
  encoder: 'templates/terraform/encoders/compute_network_endpoints.go.tmpl'
  decoder: 'templates/terraform/decoders/network_endpoints.go.tmpl'
  pre_create: 'templates/terraform/pre_create/network_endpoints.go.tmpl'
  pre_update: 'templates/terraform/pre_update/network_endpoints.go.tmpl'
  pre_delete: 'templates/terraform/pre_delete/compute_network_endpoints.go.tmpl'
exclude_tgc: true
examples:
  - name: 'network_endpoints'
    primary_resource_id: 'default-endpoints'
    vars:
      neg_name: 'my-lb-neg'
      instance_name: 'endpoint-instance'
      network_name: 'neg-network'
      subnetwork_name: 'neg-subnetwork'
      # Fine-grained resource need different autogenerated tests, as
      # we need to check destroy during a test step where the parent resource
      # still exists, rather than during CheckDestroy (when read returns
      # nothing because the parent resource has then also been destroyed)
    exclude_test: true
parameters:
  - name: 'zone'
    type: ResourceRef
    description: |
      Zone where the containing network endpoint group is located.
    url_param_only: true
    required: false
    ignore_read: true
    default_from_api: true
    resource: 'Zone'
    imports: 'name'
  - name: 'networkEndpointGroup'
    type: ResourceRef
    description: |
      The network endpoint group these endpoints are part of.
    url_param_only: true
    required: true
    ignore_read: true
    diff_suppress_func: 'tpgresource.CompareResourceNames'
    resource: 'NetworkEndpointGroup'
    imports: 'name'
properties:
  - name: 'networkEndpoints'
    type: Array
    description: |
      The network endpoints to be added to the enclosing network endpoint group
      (NEG). Each endpoint specifies an IP address and port, along with
      additional information depending on the NEG type.
    is_set: true
    item_type:
      type: NestedObject
      properties:
        - name: 'instance'
          type: ResourceRef
          description: |
            The name for a specific VM instance that the IP address belongs to.
            This is required for network endpoints of type GCE_VM_IP_PORT.
            The instance must be in the same zone as the network endpoint group.
          custom_expand: 'templates/terraform/custom_expand/resource_from_self_link.go.tmpl'
          resource: 'Instance'
          imports: 'name'
        - name: 'port'
          type: Integer
          description: |
            Port number of network endpoint.
            **Note** `port` is required unless the Network Endpoint Group is created
            with the type of `GCE_VM_IP`
          custom_flatten: 'templates/terraform/custom_flatten/float64_to_int.go.tmpl'
        - name: 'ipAddress'
          type: String
          description: |
            IPv4 address of network endpoint. The IP address must belong
            to a VM in GCE (either the primary IP or as part of an aliased IP
            range).
          required: true
