# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Warning: This is a temporary file, and should not be edited directly
---
name: 'ServicePerimeterEgressPolicy'
description: |
  EgressPolicies match requests based on egressFrom and egressTo stanzas.
  For an EgressPolicy to match, both egressFrom and egressTo stanzas must be matched.
  If an EgressPolicy matches a request, the request is allowed to span the ServicePerimeter
  boundary. For example, an EgressPolicy can be used to allow VMs on networks
  within the ServicePerimeter to access a defined set of projects outside the
  perimeter in certain contexts (e.g. to read data from a Cloud Storage bucket
  or query against a BigQuery dataset).

  ~> **Note:** By default, updates to this resource will remove the EgressPolicy from the
  from the perimeter and add it back in a non-atomic manner. To ensure that the new EgressPolicy
  is added before the old one is removed, add a `lifecycle` block with `create_before_destroy = true` to this resource.
references:
  guides:
  api: 'https://cloud.google.com/access-context-manager/docs/reference/rest/v1/accessPolicies.servicePerimeters#egresspolicy'
docs:
id_format: '{{perimeter}}'
base_url: ''
self_link: '{{perimeter}}'
create_url: '{{perimeter}}'
create_verb: 'PATCH'
update_mask: true
delete_verb: 'PATCH'
immutable: true
mutex: '{{perimeter}}'
import_format:
  - '{{perimeter}}'
timeouts:
  insert_minutes: 20
  update_minutes: 20
  delete_minutes: 20
autogen_async: true
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
    path: 'name'
    wait_ms: 1000
  result:
    path: 'response'
    resource_inside_response: true
  error:
    path: 'error'
    message: 'message'
identity:
  - egressFrom
  - egressTo
nested_query:
  keys:
    - status
    - egressPolicies
  is_list_of_ids: false
  modify_by_patch: true
custom_code:
  custom_import: 'templates/terraform/custom_import/go/access_context_manager_service_perimeter_ingress_policy.go.tmpl'
exclude_tgc: true
skip_sweeper: true
examples:
  - name: 'access_context_manager_service_perimeter_egress_policy'
    skip_test: true
parameters:
  - name: 'perimeter'
    type: ResourceRef
    description: |
      The name of the Service Perimeter to add this resource to.
    url_param_only: true
    required: true
    resource: 'ServicePerimeter'
    imports: 'name'
properties:
  - name: 'egressFrom'
    type: NestedObject
    description: |
      Defines conditions on the source of a request causing this `EgressPolicy` to apply.
    properties:
      - name: 'identityType'
        type: Enum
        description: |
          Specifies the type of identities that are allowed access to outside the
          perimeter. If left unspecified, then members of `identities` field will
          be allowed access.
        enum_values:
          - 'ANY_IDENTITY'
          - 'ANY_USER_ACCOUNT'
          - 'ANY_SERVICE_ACCOUNT'
      - name: 'identities'
        type: Array
        description: |
          A list of identities that are allowed access through this `EgressPolicy`.
          Should be in the format of email address. The email address should
          represent individual user or service account only.
        item_type:
          type: String
      - name: 'sources'
        type: Array
        description: 'Sources that this EgressPolicy authorizes access from.'
        item_type:
          type: NestedObject
          properties:
            - name: 'accessLevel'
              type: String
              description: 'An AccessLevel resource name that allows resources outside the ServicePerimeter to be accessed from the inside.'
      - name: 'sourceRestriction'
        type: Enum
        description: 'Whether to enforce traffic restrictions based on `sources` field. If the `sources` field is non-empty, then this field must be set to `SOURCE_RESTRICTION_ENABLED`.'
        enum_values:
          - 'SOURCE_RESTRICTION_UNSPECIFIED'
          - 'SOURCE_RESTRICTION_ENABLED'
          - 'SOURCE_RESTRICTION_DISABLED'
  - name: 'egressTo'
    type: NestedObject
    description: |
      Defines the conditions on the `ApiOperation` and destination resources that
      cause this `EgressPolicy` to apply.
    properties:
      - name: 'resources'
        type: Array
        description: |
          A list of resources, currently only projects in the form
          `projects/<projectnumber>`, that match this to stanza. A request matches
          if it contains a resource in this list. If * is specified for resources,
          then this `EgressTo` rule will authorize access to all resources outside
          the perimeter.
        item_type:
          type: String
      - name: 'externalResources'
        type: Array
        description: |
          A list of external resources that are allowed to be accessed. A request
          matches if it contains an external resource in this list (Example:
          s3://bucket/path). Currently '*' is not allowed.
        item_type:
          type: String
      - name: 'operations'
        type: Array
        description: |
          A list of `ApiOperations` that this egress rule applies to. A request matches
          if it contains an operation/service in this list.
        item_type:
          type: NestedObject
          properties:
            - name: 'serviceName'
              type: String
              description: |
                The name of the API whose methods or permissions the `IngressPolicy` or
                `EgressPolicy` want to allow. A single `ApiOperation` with serviceName
                field set to `*` will allow all methods AND permissions for all services.
            - name: 'methodSelectors'
              type: Array
              description: |
                API methods or permissions to allow. Method or permission must belong
                to the service specified by `serviceName` field. A single MethodSelector
                entry with `*` specified for the `method` field will allow all methods
                AND permissions for the service specified in `serviceName`.
              item_type:
                type: NestedObject
                properties:
                  - name: 'method'
                    type: String
                    description: |
                      Value for `method` should be a valid method name for the corresponding
                      `serviceName` in `ApiOperation`. If `*` used as value for method,
                      then ALL methods and permissions are allowed.
                  - name: 'permission'
                    type: String
                    description: |
                      Value for permission should be a valid Cloud IAM permission for the
                      corresponding `serviceName` in `ApiOperation`.
