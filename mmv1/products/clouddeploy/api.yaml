# Copyright 2017 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

--- !ruby/object:Api::Product
name: CloudDeploy
display_name: Cloud Deploy
versions:
  - !ruby/object:Api::Product::Version
    name: ga
    base_url: https://clouddeploy.googleapis.com/v1/
scopes:
  - https://www.googleapis.com/auth/cloud-platform
apis_required:
  - !ruby/object:Api::Product::ApiReference
    name: Cloud Deploy API
    url: https://pantheon.corp.google.com/apis/library/clouddeploy.googleapis.com
objects:
  - !ruby/object:Api::Resource
    name: 'DeliveryPipeline'
    base_url: projects/{{project}}/locations/{{location}}/deliveryPipelines
    create_verb: :POST
    description: |
      A DeliveryPipeline defines a pipeline through which a Skaffold configuration can progress
    collection_url_key: 'deliveryPipelines'
    update_mask: true
    async: !ruby/object:Api::OpAsync
      operation: !ruby/object:Api::OpAsync::Operation
        path: 'name'
        base_url: '{{op_id}}'
        wait_ms: 1000
      result: !ruby/object:Api::OpAsync::Result
        path: 'response'
        resource_inside_response: true
      status: !ruby/object:Api::OpAsync::Status
        path: 'done'
        complete: True
        allowed:
          - True
          - False
      error: !ruby/object:Api::OpAsync::Error
        path: 'error'
        message: 'message'
    parameters:
      - !ruby/object:Api::Type::String
        name: 'location'
        required: true
        description: The location of this cloud function.
        # This is not a real API field.
        # This is a more user-centric way for users to specify
        # that they want to use a HTTP Trigger rather than
        # send httpsTrigger with an empty dictionary.
      - !ruby/object:Api::Type::Boolean
        name: 'trigger_http'
        description: 'Use HTTP to trigger this function'
    iam_policy: !ruby/object:Api::Resource::IamPolicy
      exclude: true
    properties:
      - !ruby/object:Api::Type::String
        name: 'name'
        required: true
        description: |
          Name of the DeliveryPipeline.
          Format is projects/{project}/locations/{location}/deliveryPipelines/[a-z][a-z0-9-]{0,62}.
        pattern: projects/{{project}}/locations/{{location}}/deliveryPipelines/{{name}}
      - !ruby/object:Api::Type::String
        name: 'description'
        description: 'Description of the Release. Max length is 255 characters.'
      - !ruby/object:Api::Type::KeyValuePairs
        name: 'annotations'
        description: |
          User annotations. These attributes can only be set and used by the user,
          and not by Google Cloud Deploy. See https://google.aip.dev/128#annotations for more details
          such as format and size limitations.
      - !ruby/object:Api::Type::KeyValuePairs
        name: 'labels'
        description: |
          Labels are attributes that can be set and used by both the user and by Google Cloud Deploy.
          Labels must meet the following constraints: Keys and values can contain only lowercase letters, numeric characters, underscores, and dashes.
          All characters must use UTF-8 encoding, and international characters are allowed.
          Keys must start with a lowercase letter or international character.
          Each resource is limited to a maximum of 64 labels.
          Both keys and values are additionally constrained to be <= 128 bytes.
      - !ruby/object:Api::Type::String
        name: 'etag'
        output: true
        description: |
          This checksum is computed by the server based on the value of other fields, and may be sent on update and delete requests to ensure the
          client has an up-to-date value before proceeding.'
      - !ruby/object:Api::Type::Boolean
        name: 'suspended'
        description: |
          When suspended, no new releases or rollouts can be created, but in-progress ones will complete.'
      - !ruby/object:Api::Type::NestedObject
        name: 'serialPipeline'
        description: |
          SerialPipeline defines a sequential set of stages for a DeliveryPipeline.
        properties:
        - !ruby/object:Api::Type::Array
          name: 'stages'
          required: true
          description: |
            Each stage specifies configuration for a Target. The ordering of this list defines the promotion flow.
          item_type: !ruby/object:Api::Type::NestedObject
            properties:
            - !ruby/object:Api::Type::String
              name: 'targetId'
              description: |
                The targetId to which this stage points. This field refers exclusively to the last segment of a target name.
                For example, this field would just be my-target (rather than projects/project/locations/location/targets/my-target).
                The location of the Target is inferred to be the same as the location of the DeliveryPipeline that contains this Stage.
            - !ruby/object:Api::Type::Array
              name: 'profiles'
              item_type: Api::Type::String
              description: |
                Skaffold profiles to use when rendering the manifest for this stage's Target.
            - !ruby/object:Api::Type::NestedObject
              name: 'strategy'
              description: |
                Optional. The strategy to use for a Rollout to this stage.
              properties:
              - !ruby/object:Api::Type::NestedObject
                  name: 'standard'
                  description: |
                    Standard deployment strategy executes a single deploy and allows verifying the deployment.
                  properties:
                  - !ruby/object:Api::Type::Boolean
                    name: 'verify'
                    description: |
                      Whether to verify a deployment.
