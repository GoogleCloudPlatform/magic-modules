# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'WasmPlugin'
description: |
  WasmPlugin is a resource representing a service executing a customer-provided Wasm module.
references:
  guides:
    'Configure a route extension': 'https://cloud.google.com/service-extensions/docs/create-plugin'
  api: 'https://cloud.google.com/service-extensions/docs/reference/rest/v1/projects.locations.wasmPlugins'
docs:
base_url: 'projects/{{project}}/locations/{{location}}/wasmPlugins'
self_link: 'projects/{{project}}/locations/{{location}}/wasmPlugins/{{name}}'
create_url: 'projects/{{project}}/locations/{{location}}/wasmPlugins?wasmPluginId={{name}}'
create_verb: 'POST'
update_verb: 'PATCH'
update_mask: true
read_query_params: '?view=WASM_PLUGIN_VIEW_FULL'
timeouts:
  insert_minutes: 20
  update_minutes: 20
  delete_minutes: 20
autogen_async: true
async:
  actions: ['create', 'delete', 'update']
  type: 'OpAsync'
  operation:
    base_url: '{{op_id}}'
  result:
    resource_inside_response: false
custom_code:
examples:
  - name: 'wasm_plugin_basic'
    primary_resource_id: 'wasm_plugin'
    vars:
      wasm_plugin_name: 'my-wasm-plugin'
    skip_vcr: true
parameters:
  - name: 'location'
    type: String
    description: |
      The location of the traffic extension
    url_param_only: true
    immutable: true
    default_value: "global"
  - name: 'name'
    type: String
    description: |
      Identifier. Name of the WasmPlugin resource.
    url_param_only: true
    required: true
    immutable: true
properties:
  - name: 'createTime'
    type: Time
    description: 'Output only. The timestamp when the resource was created.'
    output: true
  - name: 'updateTime'
    type: Time
    description: 'Output only. The timestamp when the resource was updated.'
    output: true
  - name: 'description'
    type: String
    description: |
      Optional. A human-readable description of the resource.
  - name: 'labels'
    type: KeyValueLabels
    description: 'Optional. Set of labels associated with the WasmPlugin resource.'
  - name: 'mainVersionId'
    type: String
    description: |
      The ID of the WasmPluginVersion resource that is the currently serving one. The version referred to must be a child of this WasmPlugin resource and should be listed in the "versions" field.
    required: true
  - name: 'logConfig'
    type: NestedObject
    description: |
      Optional. Specifies the logging options for the activity performed by this plugin. If logging is enabled, plugin logs are exported to Cloud Logging.
      Note that the settings relate to the logs generated by using logging statements in your Wasm code.
    properties:
      - name: 'enable'
        type: Boolean
        description: |
          Optional. Specifies whether to enable logging for activity by this plugin.
      - name: 'sampleRate'
        type: Double
        validation:
          function: 'validation.FloatBetween(0, 1)'
        description: |
          Non-empty default. Configures the sampling rate of activity logs, where 1.0 means all logged activity is reported and 0.0 means no activity is reported.
          A floating point value between 0.0 and 1.0 indicates that a percentage of log messages is stored.
          The default value when logging is enabled is 1.0. The value of the field must be between 0 and 1 (inclusive).
          This field can be specified only if logging is enabled for this plugin.
        default_from_api: true
      - name: 'minLogLevel'
        type: Enum
        description: |
          Non-empty default. Specificies the lowest level of the plugin logs that are exported to Cloud Logging. This setting relates to the logs generated by using logging statements in your Wasm code.
          This field is can be set only if logging is enabled for the plugin.
          If the field is not provided when logging is enabled, it is set to INFO by default.
        default_from_api: true
        enum_values:
          - 'LOG_LEVEL_UNSPECIFIED'
          - 'TRACE'
          - 'DEBUG'
          - 'INFO'
          - 'WARN'
          - 'ERROR'
          - 'CRITICAL'
  - name: 'versions'
    type: Map
    description: |
      All versions of this WasmPlugin resource in the key-value format. The key is the resource ID, and the value is the VersionDetails object.
    required: true
    key_name: 'version_name'
    key_description: 'Name of the WasmPluginVersion'
    # custom_expand is used for both preventing empty maps being created on update and to remove output fields that are being incorrecty included in the expand when inside a map
    custom_expand: 'templates/terraform/custom_expand/wasm_plugin_skip_empty_versions.go.tmpl'
    value_type:
      name: value
      type: NestedObject
      properties:
        - name: 'createTime'
          type: Time
          description: 'Output only. The timestamp when the resource was created.'
          output: true
        - name: 'updateTime'
          type: Time
          description: 'Output only. The timestamp when the resource was updated.'
          output: true
        - name: 'description'
          type: String
          description: |
            Optional. A human-readable description of the resource.
        - name: 'labels'
          type: KeyValuePairs
          description: 'Optional. Set of labels associated with the WasmPlugin resource.'
        - name: 'imageUri'
          type: String
          description: |
            Optional. URI of the container image containing the plugin, stored in the Artifact Registry. When a new WasmPluginVersion resource is created, the digest of the container image is saved in the imageDigest field.
            When downloading an image, the digest value is used instead of an image tag.
        - name: 'imageDigest'
          type: String
          description: |
            Output only. The resolved digest for the image specified in the image field. The digest is resolved during the creation of WasmPluginVersion resource.
            This field holds the digest value, regardless of whether a tag or digest was originally specified in the image field.
          output: true
        - name: 'pluginConfigDigest'
          type: String
          description: |
            Output only. This field holds the digest (usually checksum) value for the plugin configuration.
            The value is calculated based on the contents of pluginConfigData or the container image defined by the pluginConfigUri field.
          output: true
        - name: 'pluginConfigData'
          type: String
          description: |
            A base64-encoded string containing the configuration for the plugin. The configuration is provided to the plugin at runtime through the ON_CONFIGURE callback.
            When a new WasmPluginVersion resource is created, the digest of the contents is saved in the pluginConfigDigest field.
            Conflics with pluginConfigUri.
          conflicts:
            - pluginConfigUri
          validation:
            function: 'verify.ValidateBase64String'
        - name: 'pluginConfigUri'
          type: String
          description: |
            URI of the plugin configuration stored in the Artifact Registry. The configuration is provided to the plugin at runtime through the ON_CONFIGURE callback.
            The container image must contain only a single file with the name plugin.config.
            When a new WasmPluginVersion resource is created, the digest of the container image is saved in the pluginConfigDigest field.
            Conflics with pluginConfigData.
          conflicts:
            - pluginConfigData
  - name: 'usedBy'
    type: Array
    description: |
      Output only. List of all extensions that use this WasmPlugin resource.
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: 'name'
          type: string
          description: 'Output only. Full name of the resource'
