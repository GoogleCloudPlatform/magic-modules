# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: Release
description: A version to be propagated and deployed to Units. It points to a specific version of a Blueprint that can be applied to Units, for example, via a Rollout.
base_url: projects/{{project}}/locations/{{location}}/releases
update_mask: true
self_link: projects/{{project}}/locations/{{location}}/releases/{{release_id}}
create_url: projects/{{project}}/locations/{{location}}/releases?releaseId={{release_id}}
update_verb: PATCH
id_format: projects/{{project}}/locations/{{location}}/releases/{{release_id}}
import_format:
  - projects/{{project}}/locations/{{location}}/releases/{{release_id}}
min_version: beta
examples:
  - name: saas_runtime_release_basic
    primary_resource_id: "example"
    min_version: "beta"
    vars:
      saas_name: example-saas
      unitkind_name: example-unitkind
      release_name: example-release
      previous_release_name: previous-release
    test_env_vars:
      project: "PROJECT_NAME"
    bootstrap_iam:
      - member: "serviceAccount:service-{project_number}@gcp-sa-saasservicemgmt.iam.gserviceaccount.com"
        role: "roles/saasservicemgmt.serviceAgent"
autogen_async: false
autogen_status: UmVsZWFzZQ==
parameters:
  - name: location
    type: String
    description: Resource ID segment making up resource `name`. It identifies the resource within its parent collection as described in https://google.aip.dev/122.
    immutable: true
    url_param_only: true
    required: true
  - name: releaseId
    type: String
    description: The ID value for the new release.
    immutable: true
    url_param_only: true
    required: true
properties:
  - name: annotations
    type: KeyValueAnnotations
    description: |-
      Annotations is an unstructured key-value map stored with a resource that
      may be set by external tools to store and retrieve arbitrary metadata.
      They are not queryable and should be preserved when modifying objects.

      More info: https://kubernetes.io/docs/user-guide/annotations
  - name: blueprint
    type: NestedObject
    description: |-
      Blueprints are OCI Images that contain all of the artifacts needed to
      provision a unit. Metadata such as, type of the engine used to actuate the
      blueprint (e.g. terraform, helm etc) and version will come from the image
      manifest. If the hostname is omitted, it will be assumed to be the regional
      path to Artifact Registry (eg. us-east1-docker.pkg.dev).
    properties:
      - name: engine
        type: String
        description: Type of the engine used to actuate the blueprint. e.g. terraform, helm etc.
        output: true
      - name: package
        type: String
        description: |-
          URI to a blueprint used by the Unit (required unless unitKind or release is
          set).
        immutable: true
      - name: version
        type: String
        description: Version metadata if present on the blueprint.
        output: true
  - name: createTime
    type: String
    description: The timestamp when the resource was created.
    output: true
  - name: etag
    type: String
    description: |-
      An opaque value that uniquely identifies a version or
      generation of a resource. It can be used to confirm that the client
      and server agree on the ordering of a resource being written.
    output: true
  - name: inputVariableDefaults
    type: Array
    description: Mapping of input variables to default values. Maximum 100
    item_type:
      type: NestedObject
      properties:
        - name: type
          type: Enum
          description: "Name of a supported variable type. Supported types are STRING, INT, BOOL."
          enum_values:
            - "TYPE_UNSPECIFIED"
            - "STRING"
            - "INT"
            - "BOOL"
          immutable: true
        - name: value
          type: String
          description: String encoded value for the variable.
        - name: variable
          type: String
          description: Name of the variable from actuation configs.
          immutable: true
          required: true
  - name: inputVariables
    type: Array
    description: |-
      List of input variables declared on the blueprint and can be present with
      their values on the unit spec
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: type
          type: Enum
          description: "Name of a supported variable type. Supported types are STRING, INT, BOOL."
          enum_values:
            - "TYPE_UNSPECIFIED"
            - "STRING"
            - "INT"
            - "BOOL"
          immutable: true
        - name: value
          type: String
          description: String encoded value for the variable.
        - name: variable
          type: String
          description: Name of the variable from actuation configs.
          immutable: true
          required: true
  - name: labels
    type: KeyValueLabels
    description: |-
      The labels on the resource, which can be used for categorization.
      similar to Kubernetes resource labels.
  - name: name
    type: String
    description: |-
      Identifier. The resource name (full URI of the resource) following the standard naming
      scheme:

      "projects/{project}/locations/{location}/releases/{release}"
    output: true
  - name: outputVariables
    type: Array
    description: |-
      List of output variables declared on the blueprint and can be present with
      their values on the unit status
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: type
          type: Enum
          description: "Name of a supported variable type. Supported types are STRING, INT, BOOL."
          enum_values:
            - "TYPE_UNSPECIFIED"
            - "STRING"
            - "INT"
            - "BOOL"
          immutable: true
        - name: value
          type: String
          description: String encoded value for the variable.
        - name: variable
          type: String
          description: Name of the variable from actuation configs.
          immutable: true
          required: true
  - name: releaseRequirements
    type: NestedObject
    description: Set of requirements to be fulfilled on the Unit when using this Release.
    properties:
      - name: upgradeableFromReleases
        type: Array
        description: |-
          A list of releases from which a unit can be upgraded to this one
          (optional). If left empty no constraints will be applied. When provided,
          unit upgrade requests to this release will check and enforce this
          constraint.
        item_type:
          type: String
  - name: uid
    type: String
    description: |-
      The unique identifier of the resource. UID is unique in the time
      and space for this resource within the scope of the service. It is
      typically generated by the server on successful creation of a resource
      and must not be changed. UID is used to uniquely identify resources
      with resource name reuses. This should be a UUID4.
    output: true
  - name: unitKind
    type: String
    description: |-
      Reference to the UnitKind this Release corresponds to (required and
      immutable once created).
    immutable: true
    required: true
  - name: updateTime
    type: String
    description: |-
      The timestamp when the resource was last updated. Any
      change to the resource made by users must refresh this value.
      Changes to a resource made by the service should refresh this value.
    output: true
