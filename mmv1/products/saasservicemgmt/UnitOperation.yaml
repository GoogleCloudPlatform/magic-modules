# Copyright 2025 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: UnitOperation
description: A UnitOperation encapsulates the intent to change or interact with a Unit. Operations such as provisioning, upgrading, or deprovisioning a Unit are triggered by creating a UnitOperation resource.
base_url: projects/{{project}}/locations/{{location}}/unitOperations
self_link: projects/{{project}}/locations/{{location}}/unitOperations/{{unit_operation_id}}
create_url: projects/{{project}}/locations/{{location}}/unitOperations?unitOperationId={{unit_operation_id}}
id_format: projects/{{project}}/locations/{{location}}/unitOperations/{{unit_operation_id}}
immutable: true
import_format:
  - projects/{{project}}/locations/{{location}}/unitOperations/{{unit_operation_id}}
examples:
  - name: saas_runtime_unit_operation_basic
    primary_resource_id: "provision_unit_operation"
    min_version: "beta"
    vars:
      saas_name: example-saas
      unitkind_name: vm-unitkind
      release_name: example-release
      tenant_name: example-tenant
      unit_name: example-unit
      provision_operation_name: provision-unit-operation
      upgrade_operation_name: upgrade-unit-operation
      deprovision_operation_name: deprovision-unit-operation
      actuation_service_account: actuator
      tenant_project_name: tenant
    test_env_vars:
      project: "PROJECT_NAME"
      project_number: "PROJECT_NUMBER"
      org_id: "ORG_ID"
      billing_account: "BILLING_ACCT"
    bootstrap_iam:
      - member: "serviceAccount:service-{project_number}@gcp-sa-saasservicemgmt.iam.gserviceaccount.com"
        role: "roles/saasservicemgmt.serviceAgent"
    ignore_read_extra:
      - "etag"
      - "error_category"
      - "state"
      - "update_time"
      - "conditions"
autogen_async: false
autogen_status: VW5pdE9wZXJhdGlvbg==
virtual_fields:
  - name: wait_for_completion
    type: Boolean
    description: |
      If true, wait for the UnitOperation to reach a terminal state (SUCCEEDED, FAILED, CANCELLED)
      before completing the apply.
    default_value: true
custom_code:
  post_create: "templates/terraform/post_create/saas_runtime_unit_operation_wait.go.tmpl"
parameters:
  - name: location
    type: String
    description: Resource ID segment making up resource `name`. It identifies the resource within its parent collection as described in https://google.aip.dev/122.
    immutable: true
    url_param_only: true
    required: true
  - name: unitOperationId
    type: String
    description: The ID value for the new unit operation.
    immutable: true
    url_param_only: true
    required: true
properties:
  - name: annotations
    type: KeyValueAnnotations
    description: |-
      Annotations is an unstructured key-value map stored with a resource that
      may be set by external tools to store and retrieve arbitrary metadata.
      They are not queryable and should be preserved when modifying objects.

      More info: https://kubernetes.io/docs/user-guide/annotations
  - name: conditions
    type: Array
    description: |-
      A set of conditions which indicate the various conditions this resource can
      have.
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: lastTransitionTime
          type: String
          description: Last time the condition transited from one status to another.
          output: true
        - name: message
          type: String
          description: Human readable message indicating details about the last transition.
          output: true
        - name: reason
          type: String
          description: Brief reason for the condition's last transition.
          output: true
        - name: status
          type: String
          description: |-
            Status of the condition.
            Possible values:
            STATUS_UNKNOWN
            STATUS_TRUE
            STATUS_FALSE
          output: true
        - name: type
          type: String
          description: |-
            Type of the condition.
            Possible values:
            TYPE_SCHEDULED
            TYPE_RUNNING
            TYPE_SUCCEEDED
            TYPE_CANCELLED
          output: true
  - name: createTime
    type: String
    description: The timestamp when the resource was created.
    output: true
  - name: deprovision
    type: NestedObject
    description: |-
      Deprovision is the unit operation that deprovision the underlying
      resources represented by a Unit. Can only execute if the Unit is currently
      provisioned.
    properties: []
    send_empty_value: true
    allow_empty_object: true
  - name: engineState
    type: String
    description: |-
      The engine state for on-going
      deployment engine operation(s).
      This field is opaque for external usage.
    output: true
  - name: errorCategory
    type: String
    description: |-
      Possible values:
      NOT_APPLICABLE
      FATAL
      RETRIABLE
      IGNORABLE
      STANDARD
    output: true
  - name: etag
    type: String
    description: |-
      An opaque value that uniquely identifies a version or
      generation of a resource. It can be used to confirm that the client
      and server agree on the ordering of a resource being written.
    output: true
  - name: labels
    type: KeyValueLabels
    description: |-
      The labels on the resource, which can be used for categorization.
      similar to Kubernetes resource labels.
  - name: name
    type: String
    description: |-
      Identifier. The resource name (full URI of the resource) following the standard naming
      scheme:

      "projects/{project}/locations/{location}/unitOperations/{unitOperation}"
    output: true
  - name: provision
    type: NestedObject
    description: |-
      Provision is the unit operation that provision the underlying resources
      represented by a Unit. Can only execute if the Unit is not currently
      provisioned.
    properties:
      - name: inputVariables
        type: Array
        description: Set of input variables. Maximum 100. (optional)
        item_type:
          type: NestedObject
          properties:
            - name: type
              type: String
              description: |-
                Name of a supported variable type. Supported types are string, int, bool.
                Possible values:
                STRING
                INT
                BOOL
              immutable: true
            - name: value
              type: String
              description: String encoded value for the variable.
            - name: variable
              type: String
              description: Name of the variable from actuation configs.
              immutable: true
              required: true
      - name: release
        type: String
        description: Reference to the Release object to use for the Unit. (optional).
  - name: state
    type: String
    description: |-
      UnitOperationState describes the current state of the unit operation.
      Possible values:
      UNIT_OPERATION_STATE_UNKNOWN
      UNIT_OPERATION_STATE_PENDING
      UNIT_OPERATION_STATE_SCHEDULED
      UNIT_OPERATION_STATE_RUNNING
      UNIT_OPERATION_STATE_SUCCEEDED
      UNIT_OPERATION_STATE_FAILED
      UNIT_OPERATION_STATE_CANCELLED
    output: true
  - name: uid
    type: String
    description: |-
      The unique identifier of the resource. UID is unique in the time
      and space for this resource within the scope of the service. It is
      typically generated by the server on successful creation of a resource
      and must not be changed. UID is used to uniquely identify resources
      with resource name reuses. This should be a UUID4.
    output: true
  - name: unit
    type: String
    description: The Unit a given UnitOperation will act upon.
    immutable: true
    required: true
  - name: updateTime
    type: String
    description: |-
      The timestamp when the resource was last updated. Any
      change to the resource made by users must refresh this value.
      Changes to a resource made by the service should refresh this value.
    output: true
  - name: upgrade
    type: NestedObject
    description: |-
      Upgrade is the unit operation that upgrades a provisioned unit, which may
      also include the underlying resources represented by a Unit. Can only execute
      if the Unit is currently provisioned.
    properties:
      - name: inputVariables
        type: Array
        description: Set of input variables. Maximum 100. (optional)
        item_type:
          type: NestedObject
          properties:
            - name: type
              type: String
              description: |-
                Name of a supported variable type. Supported types are string, int, bool.
                Possible values:
                STRING
                INT
                BOOL
              immutable: true
            - name: value
              type: String
              description: String encoded value for the variable.
            - name: variable
              type: String
              description: Name of the variable from actuation configs.
              immutable: true
              required: true
      - name: release
        type: String
        description: Reference to the Release object to use for the Unit. (optional).
