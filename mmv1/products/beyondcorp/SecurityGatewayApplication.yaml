# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: SecurityGatewayApplication
description: Specifies application endpoint(s) to protect behind a Security Gateway.
base_url: projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications
update_mask: true
self_link: projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications/{{application_id}}
create_url: projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications?applicationId={{application_id}}
update_verb: PATCH
id_format: projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications/{{application_id}}
import_format:
  - projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications/{{application_id}}
iam_policy:
  method_name_separator: ':'
  iam_conditions_request_type: 'QUERY_PARAM_NESTED'
  allowed_iam_role: 'roles/beyondcorp.securityGatewayUser'
  parent_resource_attribute: 'application_id'
  import_format:
    - 'projects/{{project}}/locations/global/securityGateways/{{security_gateway_id}}/applications/{{application_id}}'
    - '{{application_id}}'
examples:
  - name: beyondcorp_security_gateway_application_basic
    primary_resource_id: example
    primary_resource_name: 'fmt.Sprintf("tf-test-default-sg%s", context["random_suffix"]), fmt.Sprintf("tf-test-google-sga%s", context["random_suffix"])'
    vars:
      security_gateway_name: default-sg
      application_name: google-sga
  - name: beyondcorp_security_gateway_application_vpc
    primary_resource_id: example
    primary_resource_name: 'fmt.Sprintf("tf-test-default-sg%s", context["random_suffix"]), fmt.Sprintf("tf-test-google-sga%s", context["random_suffix"])'
    vars:
      security_gateway_name: default-sg
      application_name: my-vm-service2
  - name: beyondcorp_security_gateway_application_spa_api
    primary_resource_id: example-spa
    primary_resource_name: 'fmt.Sprintf("tf-test-default-sg-spa-api%s", context["random_suffix"]), fmt.Sprintf("tf-test-google-sga%s", context["random_suffix"])'
    vars:
      security_gateway_name: default-sg-spa-api
      application_discovery_name: app-discovery
  - name: beyondcorp_security_gateway_application_spa_proxy
    primary_resource_id: example-spa
    primary_resource_name: 'fmt.Sprintf("tf-test-default-sg-spa-proxy%s", context["random_suffix"]), fmt.Sprintf("tf-test-google-sga%s", context["random_suffix"])'
    vars:
      security_gateway_name: default-sg-spa-proxy
      application_proxy_name: app-proxy
autogen_async: true
async:
  operation:
    timeouts:
      insert_minutes: 20
      update_minutes: 20
      delete_minutes: 20
    base_url: '{{op_id}}'
  actions:
    - create
    - delete
    - update
  type: OpAsync
  result:
    resource_inside_response: true
  include_project: false
autogen_status: QXBwbGljYXRpb24=
parameters:
  - name: securityGatewayId
    type: String
    description: ID of the Security Gateway resource this belongs to.
    immutable: true
    url_param_only: true
    required: true
  - name: applicationId
    type: String
    description: |-
      User-settable Application resource ID.
      * Must start with a letter.
      * Must contain between 4-63 characters from `/a-z-/`.
      * Must end with a number or letter.
    immutable: true
    url_param_only: true
    required: true
properties:
  - name: createTime
    type: String
    description: Output only. Timestamp when the resource was created.
    output: true
  - name: displayName
    type: String
    description: |-
      Optional. An arbitrary user-provided name for the Application resource.
      Cannot exceed 64 characters.
  - name: endpointMatchers
    type: Array
    description: |-
      Required. Endpoint matchers associated with an application.
      A combination of hostname and ports as endpoint matcher is used to match
      the application.
      Match conditions for OR logic.
      An array of match conditions to allow for multiple matching criteria.
      The rule is considered a match if one the conditions are met.
      The conditions can be one of the following combination
      (Hostname), (Hostname & Ports)

      EXAMPLES:
      Hostname - ("*.abc.com"), ("xyz.abc.com")
      Hostname and Ports - ("abc.com" and "22"), ("abc.com" and "22,33") etc
    item_type:
      type: NestedObject
      properties:
        - name: hostname
          type: String
          description: Required. Hostname of the application.
          required: true
        - name: ports
          type: Array
          description: Optional. Ports of the application.
          item_type:
            type: Integer
  - name: upstreams
    type: Array
    description: Optional. List of which upstream resource(s) to forward traffic to.
    item_type:
      type: NestedObject
      properties:
        - name: egressPolicy
          type: NestedObject
          description: Optional. Routing policy information.
          properties:
            - name: regions
              type: Array
              description: Required. List of regions where the application sends traffic to.
              required: true
              item_type:
                type: String
        - name: network
          type: NestedObject
          description: Network to forward traffic to.
          properties:
            - name: name
              type: string
              description: |-
                Required. Network name is of the format:
                `projects/{project}/global/networks/{network}`
              required: true
        - name: external
          type: NestedObject
          description: List of the external endpoints to forward traffic to.
          properties:
            - name: endpoints
              type: Array
              description: List of the endpoints to forward traffic to.
              required: true
              item_type:
                type: NestedObject
                properties:
                  - name: hostname
                    type: String
                    description: Hostname of the endpoint.
                    required: true
                  - name: port
                    type: Integer
                    description: Port of the endpoint.
                    required: true
        - name: proxyProtocol
          type: NestedObject
          description: Shared proxy configuration for all apps.
          properties:
            - name: allowedClientHeaders
              type: Array
              description: The configuration for the proxy.
              item_type:
                type: string
            - name: contextualHeaders
              type: NestedObject
              description: Configuration for the contextual headers.
              properties:
                - name: userInfo
                  type: NestedObject
                  description: User info configuration.
                  properties:
                    - name: outputType
                      type: Enum
                      description: The output type of the delegated user info.
                      enum_values:
                        - 'PROTOBUF'
                        - 'JSON'
                        - 'NONE'
                - name: groupInfo
                  type: NestedObject
                  description: Group info configuration.
                  properties:
                    - name: outputType
                      type: Enum
                      description: The output type of the delegated group info.
                      enum_values:
                        - 'PROTOBUF'
                        - 'JSON'
                        - 'NONE'
                - name: deviceInfo
                  type: NestedObject
                  description: Device info configuration.
                  properties:
                    - name: outputType
                      type: Enum
                      description: The output type of the delegated device info.
                      enum_values:
                        - 'PROTOBUF'
                        - 'JSON'
                        - 'NONE'
                - name: outputType
                  type: Enum
                  description: Default output type for all enabled headers.
                  enum_values:
                    - 'PROTOBUF'
                    - 'JSON'
                    - 'NONE'
            - name: metadataHeaders
              type: KeyValuePairs
              description: |-
                Custom resource specific headers along with the values.
                The names should conform to RFC 9110:
                > Field names SHOULD constrain themselves to alphanumeric characters, "-",
                  and ".", and SHOULD begin with a letter.
                > Field values SHOULD contain only ASCII printable characters and tab.
            - name: gatewayIdentity
              type: Enum
              description: Gateway identity configuration.
              enum_values:
                - 'RESOURCE_NAME'
            - name: clientIp
              type: Boolean
              description: Client IP configuration. The client IP address is included if true.
  - name: schema
    type: Enum
    description: Type of the external application.
    enum_values:
      - 'PROXY_GATEWAY'
      - 'API_GATEWAY'
  - name: name
    type: String
    description: Identifier. Name of the resource.
    output: true
  - name: updateTime
    type: String
    description: Output only. Timestamp when the resource was last modified.
    output: true
