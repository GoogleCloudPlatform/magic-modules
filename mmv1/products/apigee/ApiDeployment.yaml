# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: "ApiDeployment"
description: |
  An `ApiDeployment` in Apigee.
references:
  guides:
    "API Proxy Deployments": "https://cloud.google.com/apigee/docs/api-platform/deploy/ui-deploy-overview"
  api: "https://cloud.google.com/apigee/docs/reference/apis/apigee/rest/v1/organizations.environments.apis.revisions.deployments"
docs:
base_url: "{{env_id}}/apis/{{api_name}}/revisions/{{revision}}/deployments"
self_link: "{{env_id}}/apis/{{api_name}}/revisions/{{revision}}/deployments"
create_url: "{{env_id}}/apis/{{api_name}}/revisions/{{revision}}/deployments?override=true&serviceAccount={{service_account}}"
import_format:
  - "{{env_id}}/apis/{{api_name}}/revisions/{{revision}}"
  - "{{env_id}}/{{api_name}}/revisions/{{revision}}"
custom_code:
  custom_import: "templates/terraform/custom_import/apigee_api_deployment.go.tmpl"
examples:
  - name: "apigee_api_deployment_basic"
    exclude_test: true
  - name: "apigee_api_deployment_basic_test"
    primary_resource_id: "apigee_api_deployment"
    test_env_vars:
      org_id: "ORG_ID"
      billing_account: "BILLING_ACCT"
    exclude_docs: true
    skip_vcr: true
parameters:
  - name: "envId"
    type: String
    description: |
      The Apigee Organization name.
    url_param_only: true
    required: true
    immutable: true
  - name: "apiName"
    type: String
    description: |
      The Apigee API proxy name.
    url_param_only: true
    required: true
    immutable: true
  - name: "revision"
    type: String
    description: |
      The Apigee API proxy name.
    url_param_only: true
    required: true
    immutable: true
  - name: "serviceAccount"
    type: String
    url_param_only: true
    description: |
      The service account to deploy the API proxy, if required.
properties:
  - name: 'deployStartTime'
    type: String
    description: |
      Time the API proxy was marked deployed in the control plane in millisconds since epoch.
    output: true
  - name: 'state'
    type: Enum
    description: |
      Current state of the deployment.
    output: true
    enum_values:
      - 'RUNTIME_STATE_UNSPECIFIED'
      - 'READY'
      - 'PROGRESSING'
      - 'ERROR'
  - name: 'errors'
    type: Array
    description: |
      Errors reported for this deployment. Populated only when state == ERROR.
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: 'code'
          type: Integer
          description: |
            The status code, which should be an enum value of google.rpc.Code.
        - name: 'message'
          type: String
          description: |
            A developer-facing error message, which should be in English. Any user-facing error message should be localized and sent in the google.rpc.Status.details field, or localized by the client.
        - name: 'details'
          type: KeyValuePairs
          description: |
            A list of messages that carry the error details. There is a common set of message types for APIs to use.
            An object containing fields of an arbitrary type. An additional field "@type" contains a URI identifying the type. Example: { "id": 1234, "@type": "types.example.com/standard/id" }.
  - name: 'routeConflicts'
    type: Array
    description: |
      Conflicts in the desired state routing configuration. The presence of conflicts does not cause the state to be ERROR, but it will mean that some of the deployment's base paths are not routed to its environment. If the conflicts change, the state will transition to PROGRESSING until the latest configuration is rolled out to all instances.
    output: true
    item_type:
      type: NestedObject
      properties:
        - name: 'environmentGroup'
          type: String
          description: |
            Name of the environment group in which this conflict exists.
        - name: 'conflictingDeployment'
          type: NestedObject
          description: |
            Existing base path/deployment causing the conflict.
          properties:
            - name: "basepath"
              type: String
              description: |
                Base path receiving traffic.
            - name: "environment"
              type: String
              description: |
                Name of the environment in which the proxy is deployed.
            - name: "apiProxy"
              type: String
              description: |
                Name of the deployed API proxy containing the base path.
            - name: "revision"
              type: String
              description: |
                Revision of the deployed API proxy containing the base path.
        - name: 'description'
          type: String
          description: |
            Human-readable description of this conflict.
  - name: 'instances'
    type: Array
    description: |
      Status reported by each runtime instance.
    item_type:
      type: NestedObject
      properties:
        - name: 'instance'
          type: String
          description: |
            ID of the instance reporting the status.
        - name: 'deployedRevisions'
          type: Array
          description: |
            Revisions currently deployed in MPs.
          item_type:
            type: NestedObject
            properties:
              - name: 'revision'
                type: String
                description: |
                  API proxy revision reported as deployed.
              - name: 'percentage'
                type: Integer
                description: |
                  Percentage of MP replicas reporting this revision.
        - name: 'deployedRoutes'
          type: Array
          description: |
            Current routes deployed in the ingress routing table. A route which is missing will appear in missingRoutes.
          item_type:
            type: NestedObject
            properties:
              - name: "basepath"
                type: String
                description: |
                  Base path in the routing table.
              - name: "envgroup"
                type: String
                description: |
                  Environment group where this route is installed.
              - name: "environment"
                type: String
                description: |
                  Destination environment. This will be empty if the route is not yet reported.
              - name: "percentage"
                type: Integer
                description: |
                  Percentage of ingress replicas reporting this route.
    output: true
  - name: 'proxyDeploymentType'
    type: Enum
    output: true
    enum_values:
      - 'PROXY_DEPLOYMENT_TYPE_UNSPECIFIED'
      - 'STANDARD'
      - 'EXTENSIBLE'
