# Copyright 2025 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: 'ApigeeApiProxyDeployment'
description: |
  Deploys a specific Apigee API Proxy revision to a given Apigee environment.
references:
  guides:
    'Deploying an API proxy': 'https://cloud.google.com/apigee/docs/api-platform/deploy/ui-deploy-new#apigee-api'
  api: 'https://cloud.google.com/apigee/docs/reference/apis/apigee/rest/v1/organizations.environments.apis.revisions.deployments/deploy'
base_url: 'v1/organizations/{{org}}/environments/{{environment}}/apis/{{api}}/revisions/{{revision}}/deployments'
self_link: 'v1/organizations/{{org}}/environments/{{environment}}/apis/{{api}}/revisions/{{revision}}/deployments'
immutable: true
create_url: 'v1/organizations/{{org}}/environments/{{environment}}/apis/{{api}}/revisions/{{revision}}/deployments'
autogen_async: false
custom_flatten: true
custom_flatten_function: 'flattenApigeeApiProxyDeployment'
id_format: 'organizations/{{org}}/environments/{{environment}}/apis/{{api}}/revisions/{{revision}}'
import_format:
  - '{{id}}'
parameters:
  - name: 'org'
    type: String
    required: true
    url_param_only: true
    description: |
      The Apigee organization ID.
  - name: 'environment'
    type: String
    required: true
    url_param_only: true
    description: |
        The Apigee environment name.
  - name: 'api'
    type: String
    required: true
    url_param_only: true
    description: |
      The Apigee API proxy name.
  - name: 'revision'
    type: Integer
    required: true
    url_param_only: true
    description: |
      The API proxy revision number to deploy.
properties:
  - name: 'override'
    type: Boolean
    url_param_only: true
    description: |
      If true, replaces any currently-deployed revision for this proxy in the target environment.
  - name: 'sequenced_rollout'
    type: Boolean
    url_param_only: true
    description: |
      If true, uses a sequenced rollout for safer traffic switching.
      Supported by both deploy (POST) and undeploy (DELETE).
  - name: 'service_account'
    type: String
    url_param_only: true
    description: |
      Optional service account email the deployed proxy runs as. Caller must have `iam.serviceAccounts.actAs` on this SA.
      (Only used by deploy.)
  - name: 'state'
    type: String
    output: true
    description: 'Deployment state reported by Apigee, if present.'
  - name: 'basepaths'
    type: Array
    item_type: String
    output: true
    description: 'Basepaths associated with the deployed proxy, if present.'
  - name: 'deployed_at'
    type: String
    output: true
    description: 'RFC3339 timestamp when deployment started, if available.'
